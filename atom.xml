<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://orochw.github.io</id>
    <title>OrochW&apos;s Blog</title>
    <updated>2025-09-07T14:59:46.407Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://orochw.github.io"/>
    <link rel="self" href="https://orochw.github.io/atom.xml"/>
    <logo>https://orochw.github.io/images/avatar.png</logo>
    <icon>https://orochw.github.io/favicon.ico</icon>
    <rights>All rights reserved 2025, OrochW&apos;s Blog</rights>
    <entry>
        <title type="html"><![CDATA[Kafka KRaft æ¨¡å¼å®‰è£…ä¸ä½¿ç”¨æŒ‡å—ï¼ˆæ— éœ€ Zookeeperï¼‰]]></title>
        <id>https://orochw.github.io/post/kafka-kraft-mo-shi-an-zhuang-yu-shi-yong-zhi-nan-wu-xu-zookeeper/</id>
        <link href="https://orochw.github.io/post/kafka-kraft-mo-shi-an-zhuang-yu-shi-yong-zhi-nan-wu-xu-zookeeper/">
        </link>
        <updated>2025-09-02T10:37:30.000Z</updated>
        <content type="html"><![CDATA[<p>ä»¥ä¸‹æ˜¯ <strong>å®Œæ•´ã€æŒ‰æµç¨‹é¡ºåºé‡å†™çš„ Kafka KRaft é›†ç¾¤æ­å»ºæ–‡æ¡£</strong>ï¼ŒåŒ…å«ä»é›¶å¼€å§‹çš„å®Œæ•´åˆå§‹åŒ–æµç¨‹ã€‚</p>
<hr>
<h1 id="kafka-kraft-æ¨¡å¼é›†ç¾¤æ­å»ºå®Œæ•´æµç¨‹æ— éœ€-zookeeper"><strong>Kafka KRaft æ¨¡å¼é›†ç¾¤æ­å»ºå®Œæ•´æµç¨‹ï¼ˆæ— éœ€ Zookeeperï¼‰</strong></h1>
<blockquote>
<p><strong>é€‚ç”¨ç‰ˆæœ¬ï¼šKafka 2.13-4.0.0ï¼ˆKRaft æ¨¡å¼ï¼‰</strong><br>
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ <strong>ä¸ä¾èµ– Zookeeper</strong> çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <strong>KRaftï¼ˆKafka Raft Metadataï¼‰æ¨¡å¼</strong> æ­å»ºä¸€ä¸ª 3 èŠ‚ç‚¹é«˜å¯ç”¨ Kafka é›†ç¾¤ã€‚<br>
åŒ…å« <strong>å…ƒæ•°æ®åˆå§‹åŒ–ã€æ ¼å¼åŒ–ã€å¯åŠ¨ã€éªŒè¯</strong> å…¨æµç¨‹ã€‚</p>
</blockquote>
<hr>
<h2 id="ä¸€-é›†ç¾¤è§„åˆ’3-èŠ‚ç‚¹ç¤ºä¾‹">ğŸŒ ä¸€ã€é›†ç¾¤è§„åˆ’ï¼ˆ3 èŠ‚ç‚¹ç¤ºä¾‹ï¼‰</h2>
<table>
<thead>
<tr>
<th>ä¸»æœºå</th>
<th>IP åœ°å€</th>
<th><code>node.id</code></th>
<th>è§’è‰²</th>
</tr>
</thead>
<tbody>
<tr>
<td>kafka1</td>
<td>172.31.7.107</td>
<td>1</td>
<td>broker + controller</td>
</tr>
<tr>
<td>kafka2</td>
<td>172.31.7.108</td>
<td>2</td>
<td>broker + controller</td>
</tr>
<tr>
<td>kafka3</td>
<td>172.31.7.109</td>
<td>3</td>
<td>broker + controller</td>
</tr>
</tbody>
</table>
<blockquote>
<p>âœ… æ‰€æœ‰èŠ‚ç‚¹å‡ä½¿ç”¨ <strong>æ··åˆè§’è‰²æ¨¡å¼</strong>ï¼ˆbroker + controllerï¼‰</p>
</blockquote>
<hr>
<h2 id="äºŒ-ç¯å¢ƒå‡†å¤‡">ğŸ”§ äºŒã€ç¯å¢ƒå‡†å¤‡</h2>
<h3 id="1-å®‰è£…-openjdk-17æ¨è">1. å®‰è£… OpenJDK 17ï¼ˆæ¨èï¼‰</h3>
<pre><code class="language-bash"># Ubuntu/Debian
sudo apt update &amp;&amp; sudo apt install openjdk-17-jdk -y

# CentOS/RHEL
sudo yum install java-17-openjdk-devel -y
</code></pre>
<p>éªŒè¯ï¼š</p>
<pre><code class="language-bash">java -version
</code></pre>
<blockquote>
<p>âš ï¸ <strong>æ³¨æ„</strong>ï¼šOpenJDK 11 åœ¨ Kafka 4.0.0 ä¸­å¯èƒ½å‡ºç°å…¼å®¹æ€§é—®é¢˜ï¼Œ<strong>å¼ºçƒˆæ¨èä½¿ç”¨ OpenJDK 17</strong>ã€‚</p>
</blockquote>
<hr>
<h2 id="ä¸‰-ä¸‹è½½ä¸è§£å‹-kafka">ğŸ“¦ ä¸‰ã€ä¸‹è½½ä¸è§£å‹ Kafka</h2>
<p>åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼š</p>
<pre><code class="language-bash">cd /apps
wget https://downloads.apache.org/kafka/4.0.0/kafka_2.13-4.0.0.tgz
tar -xzf kafka_2.13-4.0.0.tgz
ln -s kafka_2.13-4.0.0 kafka
</code></pre>
<p>è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰ï¼š</p>
<pre><code class="language-bash">export KAFKA_HOME=/apps/kafka_2.13-4.0.0
export PATH=$KAFKA_HOME/bin:$PATH
</code></pre>
<hr>
<h2 id="ï¸-å››-é…ç½®æ–‡ä»¶configserverproperties">âš™ï¸ å››ã€é…ç½®æ–‡ä»¶ï¼š<code>config/server.properties</code></h2>
<p>åœ¨æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºæˆ–ç¼–è¾‘ <code>$KAFKA_HOME/config/server.properties</code>ï¼š</p>
<pre><code class="language-properties">############################# Server Basics #############################
process.roles=broker,controller
node.id=__NODE_ID__

############################# Socket Server Settings #############################
listeners=PLAINTEXT://:9092,CONTROLLER://:9093
advertised.listeners=PLAINTEXT://__IP__:9092,CONTROLLER://__IP__:9093
controller.listener.names=CONTROLLER
listener.security.protocol.map=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
inter.broker.listener.name=PLAINTEXT

############################# Log Basics #############################
log.dirs=/apps/kafka_2.13-4.0.0/logs

############################# Controller Quorum #############################
# ä¸‰èŠ‚ç‚¹æ§åˆ¶å™¨æŠ•ç¥¨é…ç½®
controller.quorum.voters=1@172.31.7.107:9093,2@172.31.7.108:9093,3@172.31.7.109:9093

############################# Internal Topics #############################
offsets.topic.replication.factor=3
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
</code></pre>
<blockquote>
<p>ğŸ” <code>__NODE_ID__</code> å’Œ <code>__IP__</code> å°†ç”±è„šæœ¬è‡ªåŠ¨æ›¿æ¢ã€‚</p>
</blockquote>
<hr>
<h2 id="äº”-åˆå§‹åŒ–é›†ç¾¤å…ƒæ•°æ®å…³é”®æ­¥éª¤">ğŸ§° äº”ã€åˆå§‹åŒ–é›†ç¾¤å…ƒæ•°æ®ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰</h2>
<blockquote>
<p>âš ï¸ <strong>æ­¤æ­¥éª¤å¿…é¡»åœ¨é¦–æ¬¡å¯åŠ¨å‰æ‰§è¡Œï¼Œä¸”åªéœ€æ‰§è¡Œä¸€æ¬¡</strong></p>
</blockquote>
<h3 id="step-1ç”Ÿæˆå”¯ä¸€çš„-clusterid">Step 1ï¼šç”Ÿæˆå”¯ä¸€çš„ <code>cluster.id</code></h3>
<p>åœ¨ä»»æ„ä¸€å°æœºå™¨ä¸Šç”Ÿæˆé›†ç¾¤ IDï¼š</p>
<pre><code class="language-bash">CLUSTER_ID=$(bin/kafka-storage.sh random-uuid)
echo $CLUSTER_ID
</code></pre>
<p>è¾“å‡ºç¤ºä¾‹ï¼š</p>
<pre><code>3hzu8188TC68nQcL5A-Y0g
</code></pre>
<blockquote>
<p>âœ… è®°ä¸‹è¿™ä¸ª <code>cluster.id</code>ï¼Œæ‰€æœ‰èŠ‚ç‚¹å°†ä½¿ç”¨ç›¸åŒçš„ IDã€‚</p>
</blockquote>
<hr>
<h3 id="step-2æ ¼å¼åŒ–å­˜å‚¨ç›®å½•æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ">Step 2ï¼šæ ¼å¼åŒ–å­˜å‚¨ç›®å½•ï¼ˆæ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰</h3>
<p>åœ¨ <strong>æ¯å° Kafka èŠ‚ç‚¹</strong> ä¸Šæ‰§è¡Œæ ¼å¼åŒ–å‘½ä»¤ï¼Œä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„ <code>cluster.id</code>ï¼š</p>
<pre><code class="language-bash">bin/kafka-storage.sh format \
  -t 3hzu8188TC68nQcL5A-Y0g \
  -c /apps/kafka_2.13-4.0.0/config/server.properties \
  --cluster-id 3hzu8188TC68nQcL5A-Y0g
</code></pre>
<blockquote>
<p>ğŸ” å‚æ•°è¯´æ˜ï¼š</p>
<ul>
<li><code>-t</code>ï¼šæŒ‡å®š <code>node.id</code>ï¼ˆæ¯å°æœºå™¨ä¸åŒï¼‰</li>
<li><code>-c</code>ï¼šé…ç½®æ–‡ä»¶è·¯å¾„</li>
<li><code>--cluster-id</code>ï¼šä¸Šä¸€æ­¥ç”Ÿæˆçš„å…¨å±€å”¯ä¸€ ID</li>
</ul>
</blockquote>
<h4 id="é¢„æœŸè¾“å‡º">âœ… é¢„æœŸè¾“å‡ºï¼š</h4>
<pre><code>Formatting /apps/kafka_2.13-4.0.0/logs with cluster id 3hzu8188TC68nQcL5A-Y0g
</code></pre>
<blockquote>
<p>âœ… æ­¤æ“ä½œä¼šåœ¨ <code>log.dirs</code> ç›®å½•ä¸‹åˆ›å»ºå…ƒæ•°æ®æ—¥å¿—ï¼Œ<strong>æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»å•ç‹¬æ‰§è¡Œ</strong>ã€‚</p>
</blockquote>
<hr>
<h2 id="å…­-å¯åŠ¨è„šæœ¬æ”¯æŒåŠ¨æ€-ip-æ›¿æ¢">ğŸš€ å…­ã€å¯åŠ¨è„šæœ¬ï¼ˆæ”¯æŒåŠ¨æ€ IP æ›¿æ¢ï¼‰</h2>
<h3 id="åˆ›å»ºç®¡ç†è„šæœ¬binkafka-managersh">åˆ›å»ºç®¡ç†è„šæœ¬ï¼š<code>bin/kafka-manager.sh</code></h3>
<pre><code class="language-bash">#!/bin/bash

# è‡ªåŠ¨æ£€æµ‹ Java
if command -v java &gt;/dev/null 2&gt;&amp;1; then
    JAVA_BIN=$(command -v java)
    JAVA_HOME=$(dirname &quot;$(dirname &quot;$JAVA_BIN&quot;)&quot;)
    export JAVA_HOME
    export PATH=$JAVA_HOME/bin:$PATH
else
    echo &quot;âŒ Java not found, please install OpenJDK 17+&quot;
    exit 1
fi

KAFKA_HOME=&quot;/apps/kafka_2.13-4.0.0&quot;
LOG_FILE=&quot;$KAFKA_HOME/logs/kafka.log&quot;
PID_FILE=&quot;$KAFKA_HOME/logs/kafka.pid&quot;
BOOTSTRAP_SERVER=&quot;$(hostname -I | awk '{print $1}'):9092&quot;

get_pid() {
    if [[ -f &quot;$PID_FILE&quot; ]]; then
        pid=$(cat &quot;$PID_FILE&quot;)
        if [[ -n &quot;$pid&quot; &amp;&amp; -d &quot;/proc/$pid&quot; ]]; then echo &quot;$pid&quot;; else rm -f &quot;$PID_FILE&quot;; fi
    else
        pgrep -f &quot;kafka\.Kafka&quot; || echo &quot;&quot;
    fi
}

prepare_config() {
    IP=$(hostname -I | awk '{print $1}')
    sed -i &quot;s|__IP__|$IP|g&quot; config/server.properties
}

start() {
    pid=$(get_pid)
    [[ -n &quot;$pid&quot; ]] &amp;&amp; { echo &quot;âŒ Kafka is already running (PID: $pid)&quot;; return 1; }

    prepare_config
    echo &quot;ğŸš€ Starting Kafka server...&quot;
    nohup bin/kafka-server-start.sh config/server.properties &gt; &quot;$LOG_FILE&quot; 2&gt;&amp;1 &amp;
    echo $! &gt; &quot;$PID_FILE&quot;
    disown
    echo &quot;âœ… Kafka started, PID: $!&quot;
}

stop() {
    pid=$(get_pid)
    [[ -z &quot;$pid&quot; ]] &amp;&amp; { echo &quot;âŒ Kafka is not running.&quot;; return 1; }

    echo &quot;ğŸ›‘ Stopping Kafka (PID: $pid)...&quot;
    kill -15 &quot;$pid&quot; &amp;&amp; rm -f &quot;$PID_FILE&quot;
    for i in {1..30}; do
        ! kill -0 &quot;$pid&quot; 2&gt;/dev/null &amp;&amp; { echo &quot;âœ… Kafka stopped.&quot;; return 0; }
        sleep 1
    done
    echo &quot;âš ï¸  Force killing...&quot;
    kill -9 &quot;$pid&quot; &amp;&amp; rm -f &quot;$PID_FILE&quot;
    echo &quot;âœ… Kafka killed.&quot;
}

status() {
    pid=$(get_pid)
    [[ -n &quot;$pid&quot; ]] &amp;&amp; echo &quot;ğŸŸ¢ Kafka is running (PID: $pid)&quot; || echo &quot;ğŸ”´ Kafka is not running.&quot;
}

controller_info() {
    echo &quot;ğŸ§  Controller Quorum Info:&quot;
    bin/kafka-metadata-quorum.sh --bootstrap-server &quot;$BOOTSTRAP_SERVER&quot; describe --status
}

case &quot;$1&quot; in
    start) start ;;
    stop) stop ;;
    restart) stop; sleep 3; start ;;
    status) status ;;
    controller-info) controller_info ;;
    *)
        echo &quot;ğŸ“Œ Usage: $0 {start|stop|restart|status|controller-info}&quot;
        ;;
esac
</code></pre>
<p>èµ‹äºˆæ‰§è¡Œæƒé™ï¼š</p>
<pre><code class="language-bash">chmod +x bin/kafka-manager.sh
</code></pre>
<hr>
<h2 id="ï¸-ä¸ƒ-å¯åŠ¨é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹">â–¶ï¸ ä¸ƒã€å¯åŠ¨é›†ç¾¤ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h2>
<p>åœ¨æ¯å°æœºå™¨ä¸Šæ‰§è¡Œï¼š</p>
<h3 id="1-è®¾ç½®-nodeid">1. è®¾ç½® <code>node.id</code></h3>
<pre><code class="language-bash"># èŠ‚ç‚¹1
sed -i 's/__NODE_ID__/1/g' config/server.properties

# èŠ‚ç‚¹2
sed -i 's/__NODE_ID__/2/g' config/server.properties

# èŠ‚ç‚¹3
sed -i 's/__NODE_ID__/3/g' config/server.properties
</code></pre>
<h3 id="2-å¯åŠ¨-kafka">2. å¯åŠ¨ Kafka</h3>
<pre><code class="language-bash">bin/kafka-manager.sh start
</code></pre>
<hr>
<h2 id="å…«-éªŒè¯é›†ç¾¤çŠ¶æ€">âœ… å…«ã€éªŒè¯é›†ç¾¤çŠ¶æ€</h2>
<h3 id="1-æ£€æŸ¥è¿è¡ŒçŠ¶æ€">1. æ£€æŸ¥è¿è¡ŒçŠ¶æ€</h3>
<pre><code class="language-bash">bin/kafka-manager.sh status
</code></pre>
<h3 id="2-æŸ¥çœ‹æ§åˆ¶å™¨ä¿¡æ¯ä»»ä¸€èŠ‚ç‚¹æ‰§è¡Œ">2. æŸ¥çœ‹æ§åˆ¶å™¨ä¿¡æ¯ï¼ˆä»»ä¸€èŠ‚ç‚¹æ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash">bin/kafka-manager.sh controller-info
</code></pre>
<h4 id="å®é™…è¾“å‡ºç¤ºä¾‹æ¥è‡ªä½ çš„æµ‹è¯•">âœ… å®é™…è¾“å‡ºç¤ºä¾‹ï¼ˆæ¥è‡ªä½ çš„æµ‹è¯•ï¼‰ï¼š</h4>
<pre><code>ğŸ§  Controller Quorum Info:
ClusterId:              3hzu8188TC68nQcL5A-Y0g
LeaderId:               1
LeaderEpoch:            1
HighWatermark:          235
MaxFollowerLag:         0
MaxFollowerLagTimeMs:   0
CurrentVoters:          [{&quot;id&quot;: 1, &quot;directoryId&quot;: null, &quot;endpoints&quot;: [&quot;CONTROLLER://172.31.7.107:9093&quot;]}, {&quot;id&quot;: 2, &quot;directoryId&quot;: null, &quot;endpoints&quot;: [&quot;CONTROLLER://172.31.7.108:9093&quot;]}, {&quot;id&quot;: 3, &quot;directoryId&quot;: null, &quot;endpoints&quot;: [&quot;CONTROLLER://172.31.7.109:9093&quot;]}]
CurrentObservers:       []
</code></pre>
<blockquote>
<p>âœ… <strong>å¥åº·æ ‡å¿—</strong>ï¼š</p>
<ul>
<li><code>LeaderId</code> å­˜åœ¨</li>
<li><code>MaxFollowerLag: 0</code></li>
<li><code>CurrentVoters</code> åŒ…å«æ‰€æœ‰ 3 ä¸ªèŠ‚ç‚¹</li>
</ul>
</blockquote>
<hr>
<h2 id="ä¹-å¸¸è§é—®é¢˜">ğŸ“Œ ä¹ã€å¸¸è§é—®é¢˜</h2>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>åŸå› </th>
<th>è§£å†³</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kafka-storage.sh: command not found</code></td>
<td>è·¯å¾„é”™è¯¯</td>
<td>ä½¿ç”¨ <code>bin/kafka-storage.sh</code></td>
</tr>
<tr>
<td>æ ¼å¼åŒ–å¤±è´¥</td>
<td><code>node.id</code> æˆ– <code>cluster.id</code> é”™è¯¯</td>
<td>æ£€æŸ¥å‚æ•°</td>
</tr>
<tr>
<td>èŠ‚ç‚¹æ— æ³•åŠ å…¥</td>
<td>ç½‘ç»œä¸é€šæˆ–ç«¯å£è¢«å ç”¨</td>
<td>æ£€æŸ¥ <code>9092/9093</code> ç«¯å£</td>
</tr>
<tr>
<td>å¯åŠ¨å´©æºƒ</td>
<td>OpenJDK ç‰ˆæœ¬é—®é¢˜</td>
<td>å‡çº§åˆ° <strong>OpenJDK 17</strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å-æ€»ç»“">ğŸ‰ åã€æ€»ç»“</h2>
<p>âœ… <strong>KRaft æ¨¡å¼åˆå§‹åŒ–å®Œæ•´æµç¨‹</strong>ï¼š</p>
<ol>
<li>å®‰è£… OpenJDK 17</li>
<li>ä¸‹è½½ Kafka å¹¶é…ç½® <code>server.properties</code></li>
<li><strong>ç”Ÿæˆ <code>cluster.id</code>ï¼š<code>bin/kafka-storage.sh random-uuid</code></strong></li>
<li><strong>æ ¼å¼åŒ–å­˜å‚¨ï¼š<code>bin/kafka-storage.sh format -t &lt;node.id&gt; --cluster-id &lt;id&gt;</code></strong></li>
<li>è®¾ç½® <code>node.id</code> å¹¶å¯åŠ¨</li>
<li>ä½¿ç”¨ <code>kafka-metadata-quorum.sh describe --status</code> éªŒè¯</li>
</ol>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œ]]></title>
        <id>https://orochw.github.io/post/kubernetes-redis-4014-ji-qun-bu-shu-yu-pai-cuo-shou-ce/</id>
        <link href="https://orochw.github.io/post/kubernetes-redis-4014-ji-qun-bu-shu-yu-pai-cuo-shou-ce/">
        </link>
        <updated>2025-08-12T21:15:07.000Z</updated>
        <content type="html"><![CDATA[<h1 id="kubernetes-redis-4014-é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†ŒçœŸå®éªŒè¯ç‰ˆ">ğŸ“š <strong>Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œï¼ˆçœŸå®éªŒè¯ç‰ˆï¼‰</strong></h1>
<blockquote>
<p><strong>å‘½åç©ºé—´ï¼šcka</strong> | ç‰ˆæœ¬ï¼šv9.0ï¼ˆå«çœŸå®å‘½ä»¤éªŒè¯ï¼‰</p>
</blockquote>
<hr>
<h2 id="1ï¸âƒ£-ç¬¬ä¸€éƒ¨åˆ†å¼•è¨€">1ï¸âƒ£ ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼•è¨€</h2>
<p>æœ¬æ–‡æ¡£è®°å½•äº†åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œ<strong>ä½¿ç”¨åŸå§‹é…ç½®æ–‡ä»¶</strong>ï¼ˆ<code>pv</code>ã€<code>redis.conf</code>ã€<code>redis-cluster.yaml</code>ï¼‰éƒ¨ç½² Redis 4.0.14 é›†ç¾¤çš„å…¨è¿‡ç¨‹ã€‚</p>
<p>é‡ç‚¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>redis.conf</code> åˆ›å»º ConfigMap</li>
<li>æŒ‚è½½é…ç½®åˆ° Redis Pod</li>
<li>é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼š<code>redis:4.0.14</code> å®˜æ–¹é•œåƒä¸æ”¯æŒ <code>redis-cli --cluster</code></li>
<li>æ’é”™éªŒè¯ä¸æœ€ç»ˆè§£å†³æ–¹æ¡ˆ</li>
<li>ä¸€é”®åˆå§‹åŒ–è„šæœ¬</li>
</ul>
<p>æ‰€æœ‰æ­¥éª¤å‡åŸºäºçœŸå®å‘½ä»¤éªŒè¯ï¼Œç¡®ä¿å¯å¤ç°ã€‚</p>
<hr>
<h2 id="2ï¸âƒ£-ç¬¬äºŒéƒ¨åˆ†å¼€å§‹éƒ¨ç½²">2ï¸âƒ£ ç¬¬äºŒéƒ¨åˆ†ï¼šå¼€å§‹éƒ¨ç½²</h2>
<h3 id="21-å‡†å¤‡-nfs-å­˜å‚¨åœ¨-nfs-æœåŠ¡å™¨ä¸Šæ‰§è¡Œ">2.1 å‡†å¤‡ NFS å­˜å‚¨ï¼ˆåœ¨ NFS æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash">mkdir -p /data/k8sdata/cka/redis{0..5}
chmod 777 /data/k8sdata/cka/redis{0..5}
</code></pre>
<hr>
<h3 id="22-åˆ›å»º-persistentvolumepv">2.2 åˆ›å»º PersistentVolumeï¼ˆPVï¼‰</h3>
<blockquote>
<p>âœ… ä½¿åŸå§‹ <code>pv/redis-cluster-pv.yaml</code></p>
</blockquote>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv0
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis0

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv1
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis1

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv2
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis2

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv3
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis3

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv4
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis4

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv5
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis5
</code></pre>
<h4 id="åº”ç”¨-pv">åº”ç”¨ PVï¼š</h4>
<pre><code class="language-bash">kubectl apply -f pv/redis-cluster-pv.yaml
kubectl get pv
</code></pre>
<blockquote>
<p>âœ… ç¡®è®¤ 6 ä¸ª PV çŠ¶æ€ä¸º <code>Available</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="23-åˆ›å»º-redis-é…ç½®æ–‡ä»¶-redisconf">2.3 åˆ›å»º Redis é…ç½®æ–‡ä»¶ <code>redis.conf</code></h3>
<blockquote>
<p>âœ… ä½¿ç”¨åŸå§‹çš„ <code>redis.conf</code></p>
</blockquote>
<pre><code class="language-conf"># redis.conf
port 6379
bind 0.0.0.0
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
save &quot;&quot;
</code></pre>
<blockquote>
<p>ğŸ’¡ è¯´æ˜ï¼š</p>
<ul>
<li><code>cluster-enabled yes</code>ï¼šå¯ç”¨é›†ç¾¤æ¨¡å¼</li>
<li><code>cluster-config-file nodes.conf</code>ï¼šé›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯æ–‡ä»¶</li>
<li><code>appendonly yes</code>ï¼šå¼€å¯ AOF æŒä¹…åŒ–</li>
<li><code>save &quot;&quot;</code>ï¼šå…³é—­ RDB æŒä¹…åŒ–ï¼Œé¿å…ä¸ AOF å†²çª</li>
</ul>
</blockquote>
<hr>
<h3 id="24-ä»-redisconf-åˆ›å»º-configmap">2.4 ä» <code>redis.conf</code> åˆ›å»º ConfigMap</h3>
<pre><code class="language-bash">kubectl create configmap redis-config \
  --from-file=redis.conf=./redis.conf \
  -n cka
</code></pre>
<blockquote>
<p>âœ… éªŒè¯ ConfigMapï¼š</p>
</blockquote>
<pre><code class="language-bash">kubectl get configmap redis-config -n cka -o yaml
</code></pre>
<hr>
<h3 id="25-éƒ¨ç½²-redis-statefulset-ä¸-serviceå«-configmap-æŒ‚è½½">2.5 éƒ¨ç½² Redis StatefulSet ä¸ Serviceï¼ˆå« ConfigMap æŒ‚è½½ï¼‰</h3>
<blockquote>
<p>âœ… æ›´æ–°åçš„ <code>redis-cluster.yaml</code>ï¼Œ<strong>åŒ…å« ConfigMap æŒ‚è½½</strong></p>
</blockquote>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: cka
  labels:
    app: redis
spec:
  selector:
    app: redis
    appCluster: redis-cluster
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
    - name: cluster
      port: 16379
      targetPort: 16379
  clusterIP: None

---
apiVersion: v1
kind: Service
metadata:
  name: redis-access
  namespace: cka
  labels:
    app: redis
spec:
  selector:
    app: redis
    appCluster: redis-cluster
  ports:
    - name: redis-access
      protocol: TCP
      port: 6379
      targetPort: 6379
  type: ClusterIP

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: cka
spec:
  serviceName: redis
  replicas: 6
  selector:
    matchLabels:
      app: redis
      appCluster: redis-cluster
  template:
    metadata:
      labels:
        app: redis
        appCluster: redis-cluster
    spec:
      terminationGracePeriodSeconds: 20
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - redis
                topologyKey: kubernetes.io/hostname
      containers:
        - name: redis
          image: redis:4.0.14
          command:
            - &quot;redis-server&quot;
          args:
            - &quot;/etc/redis/redis.conf&quot;
          resources:
            requests:
              cpu: &quot;500m&quot;
              memory: &quot;500Mi&quot;
          ports:
            - containerPort: 6379
              name: redis
              protocol: TCP
            - containerPort: 16379
              name: cluster
              protocol: TCP
          volumeMounts:
            - name: conf
              mountPath: /etc/redis
            - name: data
              mountPath: /var/lib/redis
      volumes:
        - name: conf
          configMap:
            name: redis-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ &quot;ReadWriteOnce&quot; ]
        resources:
          requests:
            storage: 5Gi
</code></pre>
<h4 id="åº”ç”¨é…ç½®">åº”ç”¨é…ç½®ï¼š</h4>
<pre><code class="language-bash">kubectl apply -f redis-cluster.yaml
</code></pre>
<hr>
<h3 id="26-ç­‰å¾…-pod-å°±ç»ª">2.6 ç­‰å¾… Pod å°±ç»ª</h3>
<pre><code class="language-bash">kubectl get pods -n cka -o wide -w
</code></pre>
<blockquote>
<p>âœ… ç­‰å¾…æ‰€æœ‰ <code>redis-0</code> åˆ° <code>redis-5</code> çŠ¶æ€å˜ä¸º <code>Running</code>ã€‚</p>
</blockquote>
<hr>
<h2 id="3ï¸âƒ£-ç¬¬ä¸‰éƒ¨åˆ†åˆå§‹åŒ–æŠ¥é”™é¦–æ¬¡å°è¯•">3ï¸âƒ£ ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆå§‹åŒ–æŠ¥é”™ï¼ˆé¦–æ¬¡å°è¯•ï¼‰</h2>
<h3 id="å°è¯•ä½¿ç”¨-redis4014-é•œåƒä¸­çš„-redis-cli-åˆå§‹åŒ–é›†ç¾¤">å°è¯•ä½¿ç”¨ <code>redis:4.0.14</code> é•œåƒä¸­çš„ <code>redis-cli</code> åˆå§‹åŒ–é›†ç¾¤</h3>
<pre><code class="language-bash">kubectl run -it --rm --restart=Never \
  --namespace cka \
  redis-admin \
  --image=redis:4.0.14 \
  -- redis-cli --cluster create \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
  --cluster-replicas 1 \
  --cluster-yes
</code></pre>
<h3 id="æŠ¥é”™ä¿¡æ¯">âŒ æŠ¥é”™ä¿¡æ¯ï¼š</h3>
<pre><code>redis-cli: unknown option '--cluster'
</code></pre>
<blockquote>
<p>ğŸ”´ <strong>é”™è¯¯åŸå› </strong>ï¼š<code>redis:4.0.14</code> é•œåƒä¸­çš„ <code>redis-cli</code> <strong>ä¸æ”¯æŒ <code>--cluster</code> å­å‘½ä»¤</strong>ã€‚</p>
</blockquote>
<hr>
<h2 id="4ï¸âƒ£-ç¬¬å››éƒ¨åˆ†æ’é”™ä¸éªŒè¯">4ï¸âƒ£ ç¬¬å››éƒ¨åˆ†ï¼šæ’é”™ä¸éªŒè¯</h2>
<h3 id="æ’é”™-1éªŒè¯-redis4014-æ˜¯å¦æ”¯æŒ-cluster">ğŸ” æ’é”™ 1ï¼šéªŒè¯ <code>redis:4.0.14</code> æ˜¯å¦æ”¯æŒ <code>--cluster</code></h3>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 redis-cli --help | grep cluster
</code></pre>
<blockquote>
<p>ğŸ” <strong>è¾“å‡ºä¸ºç©º</strong></p>
</blockquote>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 redis-cli --cluster help
</code></pre>
<blockquote>
<p>âŒ è¾“å‡ºï¼š</p>
</blockquote>
<pre><code>redis-cli: unknown option '--cluster'
</code></pre>
<blockquote>
<p>âœ… <strong>ç»“è®º</strong>ï¼š<code>redis:4.0.14</code> å®˜æ–¹é•œåƒç¡®å®ä¸æ”¯æŒ <code>--cluster</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="æ’é”™-2å°è¯•ä½¿ç”¨-redis-tribrb">ğŸ” æ’é”™ 2ï¼šå°è¯•ä½¿ç”¨ <code>redis-trib.rb</code></h3>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 sh -c &quot;ls /usr/local/bin | grep trib&quot;
</code></pre>
<blockquote>
<p>âŒ è¾“å‡ºä¸ºç©ºï¼Œ<code>redis-trib.rb</code> ä¸å­˜åœ¨ã€‚</p>
</blockquote>
<blockquote>
<p>âœ… ç»“è®ºï¼šæ— æ³•ä½¿ç”¨æ—§å·¥å…·ã€‚</p>
</blockquote>
<hr>
<h3 id="è§£å†³æ–¹æ¡ˆä½¿ç”¨é«˜ç‰ˆæœ¬-redis-cliredis626-pod-ip">âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆ<code>redis:6.2.6</code>ï¼‰ + Pod IP</h3>
<h4 id="è·å–-pod-ip">è·å– Pod IPï¼š</h4>
<pre><code>root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl get pod -cka -o wide
NAMESPACE              NAME                                             READY   STATUS    RESTARTS      AGE     IP              NODE           NOMINATED NODE   READINESS GATES
cka                 deploy-devops-redis-6d9fd4dbcb-hbs6q             1/1     Running   0             176m    10.200.45.203   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 cka-nginx-deployment-69db98d5ff-qc7mr         1/1     Running   0             9h      10.200.11.135   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 cka-tomcat-app1-deployment-78c495f67d-6db72   1/1     Running   0             24h     10.200.45.199   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 cka-tomcat-app1-deployment-78c495f67d-xbm5f   1/1     Running   0             24h     10.200.11.134   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 redis-0                                          1/1     Running   0             30m     10.200.210.76   172.31.7.104   &lt;none&gt;           &lt;none&gt;
cka                 redis-1                                          1/1     Running   0             29m     10.200.45.204   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 redis-2                                          1/1     Running   0             24m     10.200.11.136   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 redis-3                                          1/1     Running   0             24m     10.200.210.77   172.31.7.104   &lt;none&gt;           &lt;none&gt;
cka                 redis-4                                          1/1     Running   0             24m     10.200.45.205   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 redis-5                                          1/1     Running   0             24m     10.200.11.137   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper1-5666cd8f6f-b7flr                      1/1     Running   0             4h28m   10.200.45.201   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper2-c4964cd66-vsrt6                       1/1     Running   0             4h28m   10.200.45.202   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper3-55fc5c6847-xfw9g                      1/1     Running   0             4h28m   10.200.210.75   172.31.7.104   &lt;none&gt;           &lt;none&gt;
</code></pre>
<pre><code class="language-bash">kubectl get pods -n cka -l app=redis -o jsonpath='{range .items[*]}{.status.podIP}{&quot;\n&quot;}{end}'
</code></pre>
<h4 id="ä½¿ç”¨é«˜ç‰ˆæœ¬-redis-cli-åˆå§‹åŒ–">ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code> åˆå§‹åŒ–ï¼š</h4>
<pre><code class="language-bash">kubectl run -it --rm --restart=Never \
  --namespace cka \
  redis-admin \
  --image=redis:6.2.6 \
  -- redis-cli --cluster create \
    10.200.210.76:6379 \
    10.200.45.204:6379 \
    10.200.11.136:6379 \
    10.200.210.77:6379 \
    10.200.45.205:6379 \
    10.200.11.137:6379 \
  --cluster-replicas 1 \
  --cluster-yes
</code></pre>
<blockquote>
<p>âœ… æˆåŠŸè¾“å‡ºï¼š</p>
</blockquote>
<pre><code class="language-bash">root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl run -it --rm --restart=Never \
&gt;   --namespace cka \
&gt;   redis-admin \
&gt;   --image=redis:6.2.6 \
&gt;   -- redis-cli --cluster create \
&gt;     10.200.210.76:6379 \
&gt;     10.200.45.204:6379 \
&gt;     10.200.11.136:6379 \
&gt;     10.200.210.77:6379 \
&gt;     10.200.45.205:6379 \
&gt;     10.200.11.137:6379 \
&gt;   --cluster-replicas 1 \
&gt;   --cluster-yes
If you don't see a command prompt, try pressing enter.
..
&gt;&gt;&gt; Performing Cluster Check (using node 10.200.210.76:6379)
M: 0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: a6f78d2a82b2c56fdd8f61794a96e30f2398777f 10.200.11.137:6379
   slots: (0 slots) slave
   replicates 931716e199e90bc313c3480661af530d1f32bf08
S: 4a4baa12df1ada0d81e27b9a1ecc7aa2f9cec0ff 10.200.45.205:6379
   slots: (0 slots) slave
   replicates 0d3db136c17df8b0681fe8e2436a4f99203f0507
S: 6f33cd693707f3109704ca23151a4f1b7716e380 10.200.210.77:6379
   slots: (0 slots) slave
   replicates 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482
M: 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
pod &quot;redis-admin&quot; deleted
root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl exec -n cka redis-0 -- redis-cli -c cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:55
cluster_stats_messages_pong_sent:58
cluster_stats_messages_sent:113
cluster_stats_messages_ping_received:53
cluster_stats_messages_pong_received:55
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:113
root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl exec -n cka redis-0 -- redis-cli -c cluster nodes
a6f78d2a82b2c56fdd8f61794a96e30f2398777f 10.200.11.137:6379@16379 slave 931716e199e90bc313c3480661af530d1f32bf08 0 1755030011982 6 connected
0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379@16379 myself,master - 0 1755030010000 1 connected 0-5460
4a4baa12df1ada0d81e27b9a1ecc7aa2f9cec0ff 10.200.45.205:6379@16379 slave 0d3db136c17df8b0681fe8e2436a4f99203f0507 0 1755030011000 5 connected
6f33cd693707f3109704ca23151a4f1b7716e380 10.200.210.77:6379@16379 slave 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 0 1755030011577 4 connected
7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379@16379 master - 0 1755030010000 3 connected 10923-16383
931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379@16379 master - 0 1755030010971 2 connected 5461-10922

[OK] All 16384 slots covered.
</code></pre>
<hr>
<h3 id="æ’é”™æ€»ç»“">ğŸ“Œ æ’é”™æ€»ç»“</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>åŸå› </th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>redis-cli: unknown option '--cluster'</code></td>
<td><code>redis:4.0.14</code> é•œåƒä¸æ”¯æŒ</td>
<td>ä½¿ç”¨ <code>redis:6.2.6</code> çš„ <code>redis-cli</code></td>
</tr>
<tr>
<td><code>redis-trib.rb</code> ä¸å­˜åœ¨</td>
<td>å·²è¢«ç§»é™¤</td>
<td>æ”¾å¼ƒä½¿ç”¨</td>
</tr>
<tr>
<td>â€œsame hostâ€ é”™è¯¯</td>
<td>ä½¿ç”¨äº† ClusterIP æœåŠ¡</td>
<td>æ”¹ç”¨ Pod IP åˆå§‹åŒ–</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="5ï¸âƒ£-ç¬¬äº”éƒ¨åˆ†éªŒè¯é›†ç¾¤çŠ¶æ€">5ï¸âƒ£ ç¬¬äº”éƒ¨åˆ†ï¼šéªŒè¯é›†ç¾¤çŠ¶æ€</h2>
<h3 id="51-æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€">5.1 æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€</h3>
<pre><code class="language-bash">kubectl exec -n cka redis-0 -- redis-cli -c cluster info
</code></pre>
<blockquote>
<p>âœ… è¾“å‡ºï¼š</p>
</blockquote>
<pre><code>cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_known_nodes:6
cluster_size:3
</code></pre>
<hr>
<h3 id="52-æŸ¥çœ‹èŠ‚ç‚¹æ‹“æ‰‘">5.2 æŸ¥çœ‹èŠ‚ç‚¹æ‹“æ‰‘</h3>
<pre><code class="language-bash">kubectl exec -n cka redis-0 -- redis-cli -c cluster nodes
</code></pre>
<blockquote>
<p>âœ… è¾“å‡ºï¼ˆèŠ‚é€‰ï¼‰ï¼š</p>
</blockquote>
<pre><code>0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379@16379 master - 0 1755030010000 1 connected 0-5460
931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379@16379 master - 0 1755030010971 2 connected 5461-10922
7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379@16379 master - 0 1755030010000 3 connected 10923-16383
</code></pre>
<blockquote>
<p>âœ… ç»“è®ºï¼š3 ä¸» 3 ä»ï¼Œé›†ç¾¤å¥åº·ã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“">âœ… æ€»ç»“</h2>
<ul>
<li>** <code>redis.conf</code> å·²é€šè¿‡ ConfigMap æ­£ç¡®æŒ‚è½½**</li>
<li><strong><code>redis:4.0.14</code> å®˜æ–¹é•œåƒç¡®å®ä¸æ”¯æŒ <code>--cluster</code></strong></li>
<li><strong>å¿…é¡»ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆå¦‚ <code>6.2.6</code>ï¼‰è¿›è¡Œé›†ç¾¤ç®¡ç†</strong></li>
<li><strong>åˆå§‹åŒ–å¿…é¡»ä½¿ç”¨ Pod IPï¼Œé¿å…æœåŠ¡åè§£æé—®é¢˜</strong></li>
</ul>
<blockquote>
<p>ğŸ‰ æ­¤æ–‡æ¡£ä¸ºå®Œæ•´ã€çœŸå®ã€å¯æ‰§è¡Œçš„éƒ¨ç½²æ‰‹å†Œï¼Œå¯ç”¨äºå›¢é˜Ÿäº¤ä»˜ã€‚</p>
</blockquote>
<hr>
<h2 id="6ï¸âƒ£-ç¬¬å…­éƒ¨åˆ†ä¸€é”®åˆå§‹åŒ–è„šæœ¬">6ï¸âƒ£ ç¬¬å…­éƒ¨åˆ†ï¼šä¸€é”®åˆå§‹åŒ–è„šæœ¬</h2>
<h3 id="init-redis-clustersh"><code>init-redis-cluster.sh</code></h3>
<pre><code class="language-bash">#!/bin/bash
# init-redis-cluster.sh
# ä¸€é”®åˆå§‹åŒ– Redis é›†ç¾¤ï¼ˆä½¿ç”¨ Pod IP + é«˜ç‰ˆæœ¬ redis-cliï¼‰
# å‘½åç©ºé—´ï¼šcka

set -e

NAMESPACE=&quot;cka&quot;
APP_LABEL=&quot;app=redis&quot;
REPLICA_COUNT=1

echo &quot;ğŸ” è·å– Redis Pod åŠå…¶ IP åœ°å€...&quot;

POD_IPS=($(kubectl get pods -n $NAMESPACE -l $APP_LABEL -o jsonpath='{.items[*].status.podIP}'))
POD_NAMES=($(kubectl get pods -n $NAMESPACE -l $APP_LABEL -o jsonpath='{.items[*].metadata.name}'))

if [ ${#POD_IPS[@]} -ne 6 ]; then
  echo &quot;âŒ é”™è¯¯ï¼šæœŸæœ› 6 ä¸ª Podï¼Œä½†åªæ‰¾åˆ° ${#POD_IPS[@]} ä¸ª&quot;
  kubectl get pods -n $NAMESPACE -l $APP_LABEL
  exit 1
fi

echo &quot;_Pods: ${POD_NAMES[*]}&quot;
echo &quot;_Pods IPs: ${POD_IPS[*]}&quot;

echo &quot;ğŸš€ ä½¿ç”¨ redis:6.2.6 åˆå§‹åŒ– Redis é›†ç¾¤...&quot;

kubectl run -it --rm --restart=Never \
  --namespace $NAMESPACE \
  redis-admin \
  --image=redis:6.2.6 \
  -- sh -c &quot;
    redis-cli --cluster create \
      ${POD_IPS[0]}:6379 \
      ${POD_IPS[1]}:6379 \
      ${POD_IPS[2]}:6379 \
      ${POD_IPS[3]}:6379 \
      ${POD_IPS[4]}:6379 \
      ${POD_IPS[5]}:6379 \
    --cluster-replicas $REPLICA_COUNT \
    --cluster-yes
  &quot;

echo &quot;âœ… Redis é›†ç¾¤åˆå§‹åŒ–å®Œæˆï¼&quot;
</code></pre>
<blockquote>
<p>âœ… ä½¿ç”¨æ–¹æ³•ï¼š</p>
</blockquote>
<pre><code class="language-bash">chmod +x init-redis-cluster.sh
./init-redis-cluster.sh
</code></pre>
<hr>
<h2 id="æ€»ç»“-2">âœ… æ€»ç»“</h2>
<ul>
<li><strong><code>redis:4.0.14</code> å®˜æ–¹é•œåƒä¸­çš„ <code>redis-cli</code> ç¡®å®ä¸æ”¯æŒ <code>--cluster</code> å‘½ä»¤</strong>ï¼Œè¿™æ˜¯éƒ¨ç½²ä¸­çš„å…³é”®éšœç¢ã€‚</li>
<li><strong>å¿…é¡»ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆå¦‚ <code>redis:6.2.6</code>ï¼‰</strong> æ¥ç®¡ç† Redis 4.0.14 é›†ç¾¤ã€‚</li>
<li><strong>åˆå§‹åŒ–æ—¶å¿…é¡»ä½¿ç”¨ Pod IP</strong>ï¼Œé¿å… ClusterIP å¯¼è‡´çš„â€œåŒä¸€ä¸»æœºâ€é”™è¯¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‰ æ­¤æ–‡æ¡£çœŸå®è¿˜åŸäº†æ’é”™è¿‡ç¨‹ï¼Œå¯ä½œä¸ºæ ‡å‡†æ“ä½œæ‰‹å†Œã€‚</p>
</blockquote>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes 1.25 é›†ç¾¤éƒ¨ç½²æŒ‡å—  ]]></title>
        <id>https://orochw.github.io/post/kubernetes-125-ji-qun-bu-shu-zhi-nan/</id>
        <link href="https://orochw.github.io/post/kubernetes-125-ji-qun-bu-shu-zhi-nan/">
        </link>
        <updated>2025-03-25T11:12:37.000Z</updated>
        <content type="html"><![CDATA[<p>æœ¬æŒ‡å—å°†æŒ‡å¯¼æ‚¨å¦‚ä½•ä»å¤´å¼€å§‹è®¾ç½®ä¸€ä¸ªä½¿ç”¨ Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„ Kubernetes 1.25 é›†ç¾¤ã€‚æˆ‘ä»¬å°†æ¶µç›–ä»ç³»ç»Ÿå‡†å¤‡åˆ°é›†ç¾¤åˆå§‹åŒ–çš„æ‰€æœ‰æ­¥éª¤ï¼Œå¹¶æä¾›ä¸€äº›å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ³•ã€‚</p>
<h3 id="æ¶æ„æ¦‚è¿°">æ¶æ„æ¦‚è¿°</h3>
<table>
<thead>
<tr>
<th>èŠ‚ç‚¹ç±»å‹</th>
<th>ä¸»æœºå</th>
<th>IP åœ°å€</th>
<th>è§’è‰²æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master èŠ‚ç‚¹</td>
<td>k8s-master</td>
<td>172.31.7.100</td>
<td>é›†ç¾¤ç®¡ç†èŠ‚ç‚¹ï¼Œè´Ÿè´£é›†ç¾¤çš„åˆå§‹åŒ–ã€è°ƒåº¦ç­‰å·¥ä½œ</td>
</tr>
<tr>
<td>Worker èŠ‚ç‚¹ 1</td>
<td>k8s-node1</td>
<td>172.31.7.101</td>
<td>æ‰§è¡Œå®¹å™¨å·¥ä½œè´Ÿè½½</td>
</tr>
<tr>
<td>Worker èŠ‚ç‚¹ 2</td>
<td>k8s-node2</td>
<td>172.31.7.102</td>
<td>æ‰§è¡Œå®¹å™¨å·¥ä½œè´Ÿè½½</td>
</tr>
<tr>
<td>Worker èŠ‚ç‚¹ 3</td>
<td>k8s-node3</td>
<td>172.31.7.103</td>
<td>æ‰§è¡Œå®¹å™¨å·¥ä½œè´Ÿè½½</td>
</tr>
</tbody>
</table>
<h3 id="å®‰è£…ä¸é…ç½®æ¦‚è§ˆ">å®‰è£…ä¸é…ç½®æ¦‚è§ˆ</h3>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>æ­¥éª¤</th>
<th>ä¸»è¦æ“ä½œ</th>
<th>ç›®æ ‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>å‰ç½®é…ç½®</td>
<td>å…³é—­ swapã€è®¾ç½®ä¸»æœºåè§£æã€åŠ è½½å†…æ ¸æ¨¡å—ç­‰</td>
<td>å‡†å¤‡ç³»ç»Ÿç¯å¢ƒï¼Œç¡®ä¿ Kubernetes èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ</td>
</tr>
<tr>
<td>2</td>
<td>å®‰è£… Docker</td>
<td>æ·»åŠ  Docker APT æºå¹¶å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Docker</td>
<td>æä¾›å®¹å™¨è¿è¡Œæ—¶æ”¯æŒ</td>
</tr>
<tr>
<td>3</td>
<td>å®‰è£… cri-dockerd</td>
<td>ä¸‹è½½å¹¶å®‰è£… <code>cri-dockerd</code>ï¼Œä½¿å…¶å…¼å®¹ Kubernetes CRI æ¥å£</td>
<td>å…è®¸ Docker ä½œä¸º Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶</td>
</tr>
<tr>
<td>4</td>
<td>å®‰è£… Kubernetes ç»„ä»¶</td>
<td>å®‰è£… <code>kubeadm</code>, <code>kubelet</code>, å’Œ <code>kubectl</code></td>
<td>åˆå§‹åŒ–å’Œç®¡ç† Kubernetes é›†ç¾¤</td>
</tr>
<tr>
<td>5</td>
<td>åˆå§‹åŒ– Master èŠ‚ç‚¹</td>
<td>ä½¿ç”¨ <code>kubeadm init</code> å‘½ä»¤åˆå§‹åŒ–é›†ç¾¤</td>
<td>åˆ›å»ºé›†ç¾¤ï¼Œå¹¶ç”ŸæˆåŠ å…¥å‘½ä»¤ä¾›å…¶ä»–èŠ‚ç‚¹ä½¿ç”¨</td>
</tr>
<tr>
<td>6</td>
<td>Worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</td>
<td>åœ¨æ¯ä¸ª Worker èŠ‚ç‚¹ä¸Šæ‰§è¡Œç”Ÿæˆçš„ join å‘½ä»¤</td>
<td>å°† Worker èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­</td>
</tr>
<tr>
<td>7</td>
<td>å®‰è£…ç½‘ç»œæ’ä»¶</td>
<td>ä½¿ç”¨ Calico ç½‘ç»œæ’ä»¶</td>
<td>æä¾› Pod ç½‘ç»œæ”¯æŒ</td>
</tr>
<tr>
<td>8</td>
<td>éªŒè¯é›†ç¾¤çŠ¶æ€</td>
<td>ä½¿ç”¨ <code>kubectl get nodes</code> å’Œ <code>kubectl get pods -n kube-system</code> æŸ¥çœ‹çŠ¶æ€</td>
<td>ç¡®è®¤æ‰€æœ‰èŠ‚ç‚¹å’Œç³»ç»Ÿç»„ä»¶æ­£å¸¸è¿è¡Œ</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="ä¸€-æ‰€æœ‰èŠ‚ç‚¹å‰ç½®é…ç½®æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œ">ä¸€ã€æ‰€æœ‰èŠ‚ç‚¹å‰ç½®é…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash"># å…³é—­ swap
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# è®¾ç½®ä¸»æœºåè§£æï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰
# åœ¨ 100 èŠ‚ç‚¹æ‰§è¡Œï¼š
sudo hostnamectl set-hostname k8s-master
# åœ¨ 101-103 èŠ‚ç‚¹åˆ†åˆ«æ‰§è¡Œï¼š
sudo hostnamectl set-hostname k8s-node1
sudo hostnamectl set-hostname k8s-node2
sudo hostnamectl set-hostname k8s-node3

# æ‰€æœ‰èŠ‚ç‚¹æ·»åŠ  hosts è§£æï¼ˆå¯é€‰ï¼‰
cat &lt;&lt;EOF | sudo tee -a /etc/hosts
172.31.7.100 k8s-master
172.31.7.101 k8s-node1
172.31.7.102 k8s-node2
172.31.7.103 k8s-node3
EOF

# åŠ è½½å†…æ ¸æ¨¡å—
cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

# è®¾ç½®å†…æ ¸å‚æ•°
cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
sudo sysctl --system

# ç¦ç”¨é˜²ç«å¢™ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
sudo ufw disable
</code></pre>
<hr>
<h3 id="äºŒ-å®‰è£…-dockeræ‰€æœ‰èŠ‚ç‚¹">äºŒã€å®‰è£… Dockerï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3>
<pre><code class="language-bash"># å®‰è£… Docker
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce=5:20.10.23~3-0~ubuntu-focal docker-ce-cli=5:20.10.23~3-0~ubuntu-focal containerd.io

# é…ç½® Docker ä½¿ç”¨ systemd
cat &lt;&lt;EOF | sudo tee /etc/docker/daemon.json
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;
}
EOF

sudo systemctl restart docker
sudo systemctl enable docker
</code></pre>
<hr>
<h3 id="ä¸‰-å®‰è£…-cri-dockerdæ‰€æœ‰èŠ‚ç‚¹">ä¸‰ã€å®‰è£… cri-dockerdï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3>
<pre><code class="language-bash"># ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶åŒ…
wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.4/cri-dockerd_0.3.4.3-0.ubuntu-focal_amd64.deb
sudo dpkg -i cri-dockerd_0.3.4.3-0.ubuntu-focal_amd64.deb

# ä¿®æ”¹æœåŠ¡é…ç½®ï¼ˆé€‚é… Kubernetes 1.25ï¼‰
sudo sed -i 's|--network-plugin=cni --cni-bin-dir=/opt/cni/bin|--network-plugin=cni --cni-conf-dir=/etc/cni/net.d|g' /lib/systemd/system/cri-docker.service
sudo systemctl daemon-reload
sudo systemctl enable cri-docker &amp;&amp; sudo systemctl start cri-docker
</code></pre>
<hr>
<h3 id="å››-å®‰è£…-kubeadmkubeletkubectlæ‰€æœ‰èŠ‚ç‚¹">å››ã€å®‰è£… kubeadm/kubelet/kubectlï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3>
<pre><code class="language-bash"># æ·»åŠ é˜¿é‡Œäº‘é•œåƒæº
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -
cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF

# å®‰è£…æŒ‡å®šç‰ˆæœ¬
sudo apt-get update
sudo apt-get install -y kubelet=1.25.7-00 kubeadm=1.25.7-00 kubectl=1.25.7-00
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre>
<hr>
<h3 id="äº”-åˆå§‹åŒ–-master-èŠ‚ç‚¹ä»…åœ¨-master-æ‰§è¡Œ">äº”ã€åˆå§‹åŒ– Master èŠ‚ç‚¹ï¼ˆä»…åœ¨ master æ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash"># ç”Ÿæˆåˆå§‹åŒ–å‘½ä»¤ï¼ˆæ›¿æ¢å®é™…IPï¼‰
sudo kubeadm init \
  --apiserver-advertise-address=172.31.7.100 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.25.7 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=192.168.0.0/16 \
  --cri-socket unix:///var/run/cri-dockerd.sock

# å®ŒæˆåæŒ‰æç¤ºæ“ä½œ
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# ä¿å­˜ join å‘½ä»¤ï¼ˆç¨åç”¨äºèŠ‚ç‚¹åŠ å…¥ï¼‰
kubeadm token create --print-join-command &gt; join-command.txt
</code></pre>
<hr>
<h3 id="å…­-worker-èŠ‚ç‚¹åŠ å…¥é›†ç¾¤åœ¨-101-103-æ‰§è¡Œ">å…­ã€Worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼ˆåœ¨ 101-103 æ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash"># ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„ join å‘½ä»¤ï¼ˆéœ€æ·»åŠ  --cri-socketï¼‰
sudo $(cat join-command.txt) --cri-socket unix:///var/run/cri-dockerd.sock
</code></pre>
<hr>
<h3 id="ä¸ƒ-å®‰è£…ç½‘ç»œæ’ä»¶åœ¨-master-æ‰§è¡Œ">ä¸ƒã€å®‰è£…ç½‘ç»œæ’ä»¶ï¼ˆåœ¨ master æ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash"># å®‰è£… Calicoï¼ˆåŒ¹é… --pod-network-cidr=192.168.0.0/16ï¼‰
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre>
<hr>
<h3 id="å…«-éªŒè¯é›†ç¾¤çŠ¶æ€">å…«ã€éªŒè¯é›†ç¾¤çŠ¶æ€</h3>
<pre><code class="language-bash">kubectl get nodes -o wide
# ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€å˜ä¸º Ready
kubectl get pods -n kube-system
</code></pre>
<h2 id=""><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250325192110.png" alt="" loading="lazy"></h2>
<h3 id="å¸¸è§é—®é¢˜å¤„ç†">å¸¸è§é—®é¢˜å¤„ç†</h3>
<ol>
<li>
<p><strong>é•œåƒæ‹‰å–å¤±è´¥</strong>ï¼š</p>
<pre><code class="language-bash"># æ‰‹åŠ¨æ‹‰å–é•œåƒï¼ˆä¾‹å¦‚ï¼‰
docker pull registry.aliyuncs.com/google_containers/pause:3.8
</code></pre>
</li>
<li>
<p><strong>cri-dockerd æœªå¯åŠ¨</strong>ï¼š</p>
<pre><code class="language-bash">journalctl -u cri-docker -l
</code></pre>
</li>
<li>
<p><strong>èŠ‚ç‚¹ NotReady</strong>ï¼š</p>
<pre><code class="language-bash">journalctl -u kubelet -f
</code></pre>
</li>
</ol>
<hr>
<p>å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªä½¿ç”¨ Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„ Kubernetes 1.25 é›†ç¾¤ã€‚æ‰€æœ‰èŠ‚ç‚¹å‡å¯é€šè¿‡ <code>kubectl</code> å‘½ä»¤åœ¨ Master èŠ‚ç‚¹ç®¡ç†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes Network Policy è¯¦è§£ä¸å®è·µ]]></title>
        <id>https://orochw.github.io/post/kubernetes-network-policy-xiang-jie-yu-shi-jian/</id>
        <link href="https://orochw.github.io/post/kubernetes-network-policy-xiang-jie-yu-shi-jian/">
        </link>
        <updated>2025-02-18T14:12:43.000Z</updated>
        <content type="html"><![CDATA[<hr>
<h1 id="kubernetes-network-policy-è¯¦è§£ä¸å®è·µ">Kubernetes Network Policy è¯¦è§£ä¸å®è·µ</h1>
<p>Kubernetes çš„ <code>NetworkPolicy</code> æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºå®šä¹‰ Pod ä¹‹é—´çš„ç½‘ç»œé€šä¿¡è§„åˆ™ã€‚æœ¬æ–‡å°†é€šè¿‡è¯¦ç»†çš„è§£æå’Œç¤ºä¾‹ï¼Œå¸®åŠ©æ‚¨ç†è§£å¦‚ä½•ä½¿ç”¨ <code>NetworkPolicy</code> æ§åˆ¶ Pod çš„å…¥ç«™ï¼ˆIngressï¼‰å’Œå‡ºç«™ï¼ˆEgressï¼‰æµé‡ã€‚</p>
<hr>
<h2 id="ä¸€-å¼•è¨€">ä¸€ã€å¼•è¨€</h2>
<p>åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œ<code>NetworkPolicy</code> æä¾›äº†ä¸€ç§å£°æ˜å¼çš„æ–¹å¼æ¥æŒ‡å®š Pod é—´çš„é€šä¿¡è§„åˆ™ã€‚é€šè¿‡å®šä¹‰ <code>NetworkPolicy</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç²¾ç»†åœ°æ§åˆ¶ Pod çš„å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œä»è€Œå¢å¼ºé›†ç¾¤çš„å®‰å…¨æ€§ã€‚</p>
<p>æœ¬æ–‡å°†åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><strong>åŸºç¡€æ¦‚å¿µ</strong>ï¼šä»‹ç» <code>NetworkPolicy</code> çš„åŸºæœ¬ç»“æ„å’Œå…³é”®å­—æ®µã€‚</li>
<li><strong>Ingress å’Œ Egress æ¦‚è¿°</strong>ï¼šè®²è§£å…¥ç«™å’Œå‡ºç«™æµé‡çš„æ¦‚å¿µåŠå…¶ç®¡ç†æ–¹å¼ã€‚</li>
<li><strong>ç¤ºä¾‹è¯¦è§£</strong>ï¼šé€šè¿‡ 9 ä¸ªå…·ä½“ç¤ºä¾‹ï¼Œè¯¦ç»†è§£æ <code>NetworkPolicy</code> çš„é…ç½®å’Œä½¿ç”¨æ–¹æ³•ã€‚</li>
<li><strong>æ€»ç»“</strong>ï¼šå›é¡¾å…³é”®ç‚¹å¹¶æä¾›è¿›ä¸€æ­¥å­¦ä¹ çš„å»ºè®®ã€‚</li>
</ol>
<hr>
<h2 id="äºŒ-network-policy-åŸºç¡€">äºŒã€Network Policy åŸºç¡€</h2>
<p><code>NetworkPolicy</code> èµ„æºå¯¹è±¡å®šä¹‰åœ¨ <code>networking.k8s.io/v1</code> API ç‰ˆæœ¬ä¸­ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å…³é”®å­—æ®µï¼š</p>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # èµ„æºç±»å‹ä¸º NetworkPolicy
metadata:
  name: example-networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: default # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: web # åŒ¹é…æ ‡ç­¾ä¸º app: web çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector:
        matchLabels:
          app: db # å…è®¸æ¥æºï¼šæ ‡ç­¾ä¸º app: db çš„ Pod
</code></pre>
<h3 id="å…³é”®å­—æ®µè¯´æ˜">å…³é”®å­—æ®µè¯´æ˜ï¼š</h3>
<ul>
<li><strong>apiVersion</strong>ï¼šæŒ‡å®šä½¿ç”¨çš„ API ç‰ˆæœ¬ã€‚</li>
<li><strong>kind</strong>ï¼šèµ„æºç±»å‹ä¸º <code>NetworkPolicy</code>ã€‚</li>
<li><strong>metadata</strong>ï¼šåŒ…å«ç½‘ç»œç­–ç•¥çš„åç§°å’Œæ‰€åœ¨çš„å‘½åç©ºé—´ã€‚</li>
<li><strong>spec</strong>ï¼šç½‘ç»œç­–ç•¥çš„å…·ä½“è§„åˆ™ï¼ŒåŒ…æ‹¬ <code>policyTypes</code>ã€<code>podSelector</code>ã€<code>ingress</code> å’Œ <code>egress</code> ç­‰ã€‚</li>
</ul>
<hr>
<h2 id="ä¸‰-ingress-å’Œ-egress-æ¦‚è¿°">ä¸‰ã€Ingress å’Œ Egress æ¦‚è¿°</h2>
<h3 id="1-ingresså…¥ç«™æµé‡">1. Ingressï¼ˆå…¥ç«™æµé‡ï¼‰</h3>
<p><code>Ingress</code> æ˜¯ Kubernetes ä¸­ç”¨äºç®¡ç†å¤–éƒ¨è®¿é—®é›†ç¾¤å†…éƒ¨æœåŠ¡çš„ HTTP å’Œ HTTPS è·¯ç”±çš„èµ„æºå¯¹è±¡ã€‚å®ƒå®šä¹‰äº†è·¯ç”±è§„åˆ™ï¼Œæ§åˆ¶æµé‡çš„è·¯ç”±ï¼Œä½†æœ¬èº«ä¸å¤„ç†æµé‡ï¼Œè€Œæ˜¯ä¾èµ–äº <code>Ingress Controller</code> æ¥å®ç°æµé‡å¤„ç†ã€‚</p>
<h4 id="ingress-æ¶æ„">Ingress æ¶æ„</h4>
<p>Ingress æ¶æ„é€šå¸¸åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š</p>
<ul>
<li><strong>Ingress Controller</strong>ï¼šè´Ÿè´£ç›‘å¬ Ingress è§„åˆ™å˜åŒ–å¹¶æ®æ­¤æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®ã€‚</li>
<li><strong>Ingress è§„åˆ™</strong>ï¼šå®šä¹‰äº†å¦‚ä½•å°†å¤–éƒ¨æµé‡è·¯ç”±åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚</li>
</ul>
<h4 id="ç¤ºä¾‹">ç¤ºä¾‹</h4>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ Ingress ç¤ºä¾‹ï¼Œå®šä¹‰äº†ä¸¤ä¸ªè§„åˆ™ï¼š</p>
<ul>
<li>å°†æ‰€æœ‰ <code>/demo</code> è¯·æ±‚å‘é€åˆ° <code>demo-service</code> æœåŠ¡ã€‚</li>
<li>å°†æ‰€æœ‰å…¶ä»–è¯·æ±‚å‘é€åˆ° <code>main-service</code> æœåŠ¡ã€‚</li>
</ul>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: basic-ingress
spec:
  rules:
  - http:
      paths:
      - path: /demo
        pathType: Prefix
        backend:
          service:
            name: demo-service
            port:
              number: 80
  defaultBackend:
    service:
      name: main-service
      port:
        number: 80
</code></pre>
<h3 id="2-egresså‡ºç«™æµé‡">2. Egressï¼ˆå‡ºç«™æµé‡ï¼‰</h3>
<p>ç›¸å¯¹äº <code>Ingress</code>ï¼Œ<code>Egress</code> ä»£è¡¨ç¦»å¼€ Kubernetes é›†ç¾¤çš„æµé‡ã€‚åœ¨ Kubernetes ä¸­ï¼Œ<code>Egress</code> æµé‡é€šå¸¸é€šè¿‡ Node çš„ç½‘ç»œæ¥å£ç›´æ¥å‘é€åˆ°å¤–éƒ¨ç½‘ç»œã€‚è™½ç„¶ <code>Ingress</code> æœ‰ä¸“é—¨çš„æ§åˆ¶å™¨å’Œè§„åˆ™æ¥ç®¡ç†ï¼Œä½† <code>Egress</code> æµé‡åˆ™ç›¸å¯¹ç®€å•ï¼Œé€šå¸¸ä¸éœ€è¦ç‰¹åˆ«çš„æ§åˆ¶å™¨æˆ–è§„åˆ™æ¥ç®¡ç†ï¼ˆé™¤éæœ‰ç‰¹å®šçš„å®‰å…¨æˆ–ç­–ç•¥éœ€æ±‚ï¼‰ã€‚</p>
<hr>
<h2 id="å››-ç¤ºä¾‹è¯¦è§£">å››ã€ç¤ºä¾‹è¯¦è§£</h2>
<p>ä»¥ä¸‹æ˜¯ 9 ä¸ªå…·ä½“çš„ <code>NetworkPolicy</code> ç¤ºä¾‹ï¼Œè¯¦ç»†è§£æå…¶é…ç½®å’Œä½¿ç”¨æ–¹æ³•ã€‚</p>
<h3 id="ç¤ºä¾‹-1åŸºäº-pod-æ ‡ç­¾çš„å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 1ï¼šåŸºäº Pod æ ‡ç­¾çš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™ ä¹Ÿå°±æ˜¯å…è®¸å“ªä¸ª Pod è®¿é—®è¿™ä¸ª Pod
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector:
        matchLabels:
          project: &quot;python&quot; # å…è®¸æ¥æºï¼šæ ‡ç­¾ä¸º project: python çš„ Pod
</code></pre>
<h3 id="ç¤ºä¾‹-1åŸºäº-pod-æ ‡ç­¾çš„å…¥ç«™è§„åˆ™-2">ç¤ºä¾‹ 1ï¼šåŸºäº Pod æ ‡ç­¾çš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector:
        matchLabels:
          project: &quot;python&quot; # å…è®¸æ¥æºï¼šæ ‡ç­¾ä¸º project: python çš„ Pod
</code></pre>
<hr>
<h3 id="ç¤ºä¾‹-2åŸºäº-pod-æ ‡ç­¾å’Œç«¯å£çš„å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 2ï¼šåŸºäº Pod æ ‡ç­¾å’Œç«¯å£çš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector:
        matchLabels:
          project: &quot;python&quot; # å…è®¸æ¥æºï¼šæ ‡ç­¾ä¸º project: python çš„ Pod
    ports:
    - protocol: TCP # æŒ‡å®šåè®®ï¼šTCP
      port: 8080 # æŒ‡å®šç«¯å£ï¼š8080
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>ports</code> å­—æ®µé™åˆ¶äº†å…è®¸è®¿é—®çš„åè®®å’Œç«¯å£ã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸æ¥è‡ªæ ‡ç­¾ä¸º <code>project: python</code> çš„ Pod é€šè¿‡ TCP åè®®è®¿é—®ç›®æ ‡ Pod çš„ 8080 ç«¯å£ã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-3å¤šç«¯å£å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 3ï¼šå¤šç«¯å£å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector: {} # ä¸é™åˆ¶æ¥æº Pod
    ports:
    - protocol: TCP # æŒ‡å®šåè®®ï¼šTCP
      port: 8080 # æŒ‡å®šç«¯å£ï¼š8080
    - protocol: TCP
      port: 3306 # æŒ‡å®šç«¯å£ï¼š3306
    - protocol: TCP
      port: 6379 # æŒ‡å®šç«¯å£ï¼š6379
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>from</code> ä¸­çš„ <code>podSelector: {}</code> è¡¨ç¤ºä¸é™åˆ¶æ¥æº Podã€‚</li>
<li><code>ports</code> åˆ—å‡ºäº†å¤šä¸ªç«¯å£å’Œåè®®ï¼Œå…è®¸è®¿é—®çš„ç›®æ ‡ Pod çš„è¿™äº›ç«¯å£ã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-4ä¸é™åˆ¶æº-pod-çš„å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 4ï¼šä¸é™åˆ¶æº Pod çš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels: {} # åŒ¹é…æ‰€æœ‰ç›®æ ‡ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - podSelector: {} # ä¸é™åˆ¶æ¥æº Pod
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>podSelector: {}</code> è¡¨ç¤ºè¯¥è§„åˆ™é€‚ç”¨äºå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Podã€‚</li>
<li><code>from</code> ä¸­çš„ <code>podSelector: {}</code> è¡¨ç¤ºä¸é™åˆ¶æ¥æº Podã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-5åŸºäº-ip-æ®µçš„å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 5ï¼šåŸºäº IP æ®µçš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - ipBlock:
        cidr: 10.200.0.0/16 # å…è®¸æ¥è‡ª 10.200.0.0/16 ç½‘æ®µçš„ IP åœ°å€
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>ipBlock</code> å®šä¹‰äº†å…è®¸è®¿é—®çš„ IP åœ°å€èŒƒå›´ã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸æ¥è‡ª <code>10.200.0.0/16</code> ç½‘æ®µçš„ IP åœ°å€è®¿é—®ç›®æ ‡ Podã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-6åŸºäº-namespace-æ ‡ç­¾çš„å…¥ç«™è§„åˆ™">ç¤ºä¾‹ 6ï¼šåŸºäº Namespace æ ‡ç­¾çš„å…¥ç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: tomcat-access--networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Ingress # å®šä¹‰å…¥ç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels: {} # åŒ¹é…å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Pod
  ingress: # å…¥ç«™è§„åˆ™
  - from:
    - namespaceSelector:
        matchLabels:
          nsname: linux # å…è®¸æ¥æºï¼šæ ‡ç­¾ä¸º nsname: linux çš„ Namespace
    ports:
    - protocol: TCP # æŒ‡å®šåè®®ï¼šTCP
      port: 8080 # æŒ‡å®šç«¯å£ï¼š8080
    - protocol: TCP
      port: 3306 # æŒ‡å®šç«¯å£ï¼š3306
    - protocol: TCP
      port: 6379 # æŒ‡å®šç«¯å£ï¼š6379
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>namespaceSelector</code> å®šä¹‰äº†å…è®¸è®¿é—®çš„ Namespaceã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸æ¥è‡ªæ ‡ç­¾ä¸º <code>nsname: linux</code> çš„ Namespace ä¸­çš„ Pod è®¿é—®ç›®æ ‡ Pod çš„æŒ‡å®šç«¯å£ã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-7åŸºäº-ip-æ®µçš„å‡ºç«™è§„åˆ™">ç¤ºä¾‹ 7ï¼šåŸºäº IP æ®µçš„å‡ºç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: egress-access-networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Egress # å®šä¹‰å‡ºç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-tomcat-app1-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
  egress: # å‡ºç«™è§„åˆ™
  - to:
    - ipBlock:
        cidr: 10.200.0.0/16 # å…è®¸è®¿é—® 10.200.0.0/16 ç½‘æ®µçš„ IP åœ°å€
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>egress</code> å®šä¹‰äº†å‡ºç«™æµé‡è§„åˆ™ã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸ç›®æ ‡ Pod è®¿é—® <code>10.200.0.0/16</code> ç½‘æ®µçš„ IP åœ°å€ã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-8åŸºäº-pod-æ ‡ç­¾çš„å‡ºç«™è§„åˆ™">ç¤ºä¾‹ 8ï¼šåŸºäº Pod æ ‡ç­¾çš„å‡ºç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: egress-access-networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Egress # å®šä¹‰å‡ºç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-nginx-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-nginx-selector çš„ Pod
  egress: # å‡ºç«™è§„åˆ™
  - to:
    - podSelector:
        matchLabels:
          app: python-tomcat-app1-selector # å…è®¸è®¿é—®ï¼šæ ‡ç­¾ä¸º app: python-tomcat-app1-selector çš„ Pod
    ports:
    - protocol: TCP # æŒ‡å®šåè®®ï¼šTCP
      port: 8080 # æŒ‡å®šç«¯å£ï¼š8080
    - protocol: TCP
      port: 53 # æŒ‡å®šç«¯å£ï¼š53
    - protocol: UDP
      port: 53 # æŒ‡å®šç«¯å£ï¼š53
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>to</code> å®šä¹‰äº†å…è®¸è®¿é—®çš„ç›®æ ‡ Podã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸ç›®æ ‡ Pod è®¿é—®æ ‡ç­¾ä¸º <code>app: python-tomcat-app1-selector</code> çš„ Pod çš„æŒ‡å®šç«¯å£ã€‚</li>
</ul>
<hr>
<h3 id="ç¤ºä¾‹-9åŸºäº-namespace-æ ‡ç­¾çš„å‡ºç«™è§„åˆ™">ç¤ºä¾‹ 9ï¼šåŸºäº Namespace æ ‡ç­¾çš„å‡ºç«™è§„åˆ™</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1 # API ç‰ˆæœ¬
kind: NetworkPolicy # ç½‘ç»œç­–ç•¥èµ„æºç±»å‹
metadata:
  name: egress-access-networkpolicy # ç½‘ç»œç­–ç•¥åç§°
  namespace: python # æ‰€å±å‘½åç©ºé—´
spec:
  policyTypes:
  - Egress # å®šä¹‰å‡ºç«™æµé‡è§„åˆ™
  podSelector: # ç›®æ ‡ Pod çš„é€‰æ‹©å™¨
    matchLabels:
      app: python-nginx-selector # åŒ¹é…æ ‡ç­¾ä¸º app: python-nginx-selector çš„ Pod
  egress: # å‡ºç«™è§„åˆ™
  - to:
    - namespaceSelector:
        matchLabels:
          nsname: python # å…è®¸è®¿é—®ï¼šæ ‡ç­¾ä¸º nsname: python çš„ Namespace
    - namespaceSelector:
        matchLabels:
          nsname: linux # å…è®¸è®¿é—®ï¼šæ ‡ç­¾ä¸º nsname: linux çš„ Namespace
    ports:
    - protocol: TCP # æŒ‡å®šåè®®ï¼šTCP
      port: 8080 # æŒ‡å®šç«¯å£ï¼š8080
    - protocol: TCP
      port: 53 # æŒ‡å®šç«¯å£ï¼š53
    - protocol: UDP
      port: 53 # æŒ‡å®šç«¯å£ï¼š53
</code></pre>
<p><strong>æ³¨é‡Šè¯´æ˜</strong>ï¼š</p>
<ul>
<li><code>namespaceSelector</code> å®šä¹‰äº†å…è®¸è®¿é—®çš„ Namespaceã€‚</li>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä»…å…è®¸ç›®æ ‡ Pod è®¿é—®æ ‡ç­¾ä¸º <code>nsname: python</code> å’Œ <code>nsname: linux</code> çš„ Namespace ä¸­çš„ Pod çš„æŒ‡å®šç«¯å£ã€‚</li>
</ul>
<hr>
<hr>
<h2 id="äº”-æ€»ç»“">äº”ã€æ€»ç»“</h2>
<h3 id="1-æ ¸å¿ƒæ¦‚å¿µå›é¡¾">1. <strong>æ ¸å¿ƒæ¦‚å¿µå›é¡¾</strong></h3>
<ul>
<li><strong>NetworkPolicy</strong>ï¼šç”¨äºå®šä¹‰ Pod é—´é€šä¿¡è§„åˆ™çš„æ ¸å¿ƒèµ„æºå¯¹è±¡ã€‚</li>
<li><strong>Ingress</strong>ï¼šç®¡ç†è¿›å…¥é›†ç¾¤çš„æµé‡ï¼Œé€šå¸¸é€šè¿‡ <code>Ingress Controller</code> å®ç°ã€‚</li>
<li><strong>Egress</strong>ï¼šç®¡ç†ç¦»å¼€é›†ç¾¤çš„æµé‡ï¼Œé€šå¸¸éœ€è¦é¢å¤–çš„å®‰å…¨ç­–ç•¥ã€‚</li>
</ul>
<h3 id="2-å…³é”®å­—æ®µ">2. <strong>å…³é”®å­—æ®µ</strong></h3>
<ul>
<li><strong>apiVersion</strong> å’Œ <strong>kind</strong>ï¼šå®šä¹‰èµ„æºç±»å‹å’Œ API ç‰ˆæœ¬ã€‚</li>
<li><strong>metadata</strong>ï¼šæŒ‡å®šèµ„æºåç§°å’Œå‘½åç©ºé—´ã€‚</li>
<li><strong>spec</strong>ï¼šå®šä¹‰å…·ä½“çš„è§„åˆ™ï¼ŒåŒ…æ‹¬ <code>policyTypes</code>ã€<code>podSelector</code>ã€<code>ingress</code> å’Œ <code>egress</code>ã€‚</li>
</ul>
<h3 id="3-åº”ç”¨åœºæ™¯">3. <strong>åº”ç”¨åœºæ™¯</strong></h3>
<ul>
<li><strong>å®‰å…¨æ€§</strong>ï¼šé€šè¿‡é™åˆ¶ Pod é—´çš„é€šä¿¡ï¼Œé˜²æ­¢æœªç»æˆæƒçš„è®¿é—®ã€‚</li>
<li><strong>æµé‡ç®¡ç†</strong>ï¼šç²¾ç¡®æ§åˆ¶æµé‡çš„æµå‘ï¼Œä¼˜åŒ–èµ„æºåˆ©ç”¨ç‡ã€‚</li>
<li><strong>å¤šç§Ÿæˆ·ç¯å¢ƒ</strong>ï¼šéš”ç¦»ä¸åŒç§Ÿæˆ·çš„ç½‘ç»œé€šä¿¡ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ã€‚</li>
</ul>
<h3 id="4-ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®">4. <strong>ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®</strong></h3>
<ul>
<li>å­¦ä¹ æ›´å¤šå…³äº <code>CNI</code> æ’ä»¶çš„çŸ¥è¯†ï¼Œäº†è§£å®ƒä»¬å¦‚ä½•æ”¯æŒ <code>NetworkPolicy</code>ã€‚</li>
<li>æ¢ç´¢ <code>Ingress Controller</code> çš„é«˜çº§åŠŸèƒ½ï¼Œä¾‹å¦‚ SSL/TLS æ”¯æŒå’Œè´Ÿè½½å‡è¡¡ã€‚</li>
<li>å®è·µå¤æ‚çš„ç½‘ç»œç­–ç•¥ï¼Œç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯è¿›è¡Œä¼˜åŒ–ã€‚</li>
</ul>
<p>å¸Œæœ›æœ¬æ–‡èƒ½å¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£å’Œåº”ç”¨ Kubernetes çš„ <code>NetworkPolicy</code>ï¼å¦‚æœæ‚¨æœ‰ä»»ä½•ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶ç•™è¨€äº¤æµï¼</p>
<hr>
<p>å¦‚æœè¿˜æœ‰å…¶ä»–éœ€æ±‚ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä¸€ä¸ªç®€å•çš„jenkins+harbor+k8sçš„cicd]]></title>
        <id>https://orochw.github.io/post/yi-ge-jian-dan-de-jenkinsharbork8s-de-cicd/</id>
        <link href="https://orochw.github.io/post/yi-ge-jian-dan-de-jenkinsharbork8s-de-cicd/">
        </link>
        <updated>2025-01-16T17:34:19.000Z</updated>
        <content type="html"><![CDATA[<pre><code class="language-markdown"># Kubernetes CI/CD ç¯å¢ƒæ­å»ºæŒ‡å—

ç”±äºå­¦ä¹ K8Sæœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œä¹‹å‰ä½¿ç”¨Jenkins Pipelineå®ç°çš„CI/CDä¹Ÿå·²ç»å¾ˆä¹…æ²¡æœ‰æ›´æ–°ã€‚ç°åœ¨æƒ³å°è¯•ä¸€äº›æ–°çš„ä¸œè¥¿ã€‚

## ç½‘ç»œé…ç½®æ¦‚è§ˆ

| IPåœ°å€      | ä¸»æœºå         | å¤‡æ³¨       |
|-------------|----------------|------------|
| 172.31.7.11 | master1-7-11   | ä¸»Master   |
| 172.31.7.21 | jenkins-7-21   | Jenkins    |
| 172.31.7.22 | gitlab-7-22    | GitLab     |
| 172.31.7.10 | harbor-7-10    | Harbor     |

å¤‡æ³¨ï¼šç³»ç»Ÿå‡ä¸ºUbuntu

---

# ä¸€ã€å‡†å¤‡Jenkinsç¯å¢ƒï¼ˆç‰¹åˆ«æ˜¯JDKï¼‰

### å®‰è£…JDK

```bash
apt install openjdk-17-jdk 
</code></pre>
<h3 id="ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆjenkinså®‰è£…åŒ…">ä¸‹è½½æœ€æ–°ç¨³å®šç‰ˆJenkinså®‰è£…åŒ…</h3>
<p><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117021236.png" alt="ä¸‹è½½é¡µé¢" loading="lazy"><br>
<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117021419.png" alt="é€‰æ‹©ç‰ˆæœ¬" loading="lazy"></p>
<h3 id="å®‰è£…é•¿æœŸæ”¯æŒç‰ˆæœ¬jenkins">å®‰è£…é•¿æœŸæ”¯æŒç‰ˆæœ¬Jenkins</h3>
<pre><code class="language-bash">sudo wget -O /usr/share/keyrings/jenkins-keyring.asc \
  https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
echo &quot;deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc]&quot; \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list &gt; /dev/null
sudo apt-get update
sudo apt-get install jenkins
</code></pre>
<h4 id="ä¿®æ”¹jenkinsé…ç½®æ–‡ä»¶-etcdefaultjenkins">ä¿®æ”¹Jenkinsé…ç½®æ–‡ä»¶ <code>/etc/default/jenkins</code></h4>
<pre><code class="language-bash">vim /etc/default/jenkins
NAME=root
JAVA_ARGS=&quot;-Djava.awt.headless=true&quot;
JENKINS_USER=root
JENKINS_GROUP=root
JENKINS_HOME=/var/lib/$NAME
</code></pre>
<h4 id="ä¿®æ”¹jenkins-systemdæœåŠ¡æ–‡ä»¶-usrlibsystemdsystemjenkinsservice">ä¿®æ”¹Jenkins systemdæœåŠ¡æ–‡ä»¶ <code>/usr/lib/systemd/system/jenkins.service</code></h4>
<pre><code class="language-bash">vim /usr/lib/systemd/system/jenkins.service
User=root # å°†æœåŠ¡å¯åŠ¨çš„ç”¨æˆ·æ”¹ä¸ºroot
Group=root # æœåŠ¡å¯åŠ¨çš„ç»„æ”¹ä¸ºroot
</code></pre>
<p>é‡å¯JenkinsæœåŠ¡ï¼š</p>
<pre><code class="language-bash">systemctl restart jenkins
systemctl daemon-reload
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117022346.png" alt="Jenkins Webç•Œé¢" loading="lazy"></figure>
<hr>
<h1 id="äºŒ-å®‰è£…gitlab">äºŒã€å®‰è£…GitLab</h1>
<h3 id="ä¸‹è½½gitlabå®‰è£…åŒ…">ä¸‹è½½GitLabå®‰è£…åŒ…</h3>
<p>å»<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/apt/packages.gitlab.com/gitlab/gitlab-ce/ubuntu/pool/focal/main/g/gitlab-ce/">æ¸…åå¤§å­¦é•œåƒç«™</a>ä¸‹è½½å–œæ¬¢çš„ç‰ˆæœ¬ã€‚</p>
<h3 id="é…ç½®å¹¶å¯åŠ¨gitlab">é…ç½®å¹¶å¯åŠ¨GitLab</h3>
<p>å‚è€ƒ<a href="https://blog.csdn.net/Hemameba/article/details/133854744">è¿™ç¯‡åšå®¢</a>è¿›è¡Œå®‰è£…ä¸é…ç½®ã€‚</p>
<h3 id="åˆ›å»ºç”¨æˆ·å¹¶ä¿®æ”¹å¯†ç åˆ›å»ºæµ‹è¯•é¡¹ç›®">åˆ›å»ºç”¨æˆ·å¹¶ä¿®æ”¹å¯†ç ï¼Œåˆ›å»ºæµ‹è¯•é¡¹ç›®</h3>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117023112.png" alt="GitLabç”¨æˆ·ç®¡ç†" loading="lazy"></figure>
<pre><code>
### 1. **Kubernetes Deployment YAML æ–‡ä»¶**

è¿™ä¸ªYAMLæ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªKuberneteséƒ¨ç½²ï¼ˆDeploymentï¼‰å’ŒæœåŠ¡ï¼ˆServiceï¼‰ï¼Œç”¨äºåœ¨Kubernetesé›†ç¾¤ä¸­è¿è¡Œä¸€ä¸ªTomcatåº”ç”¨ã€‚

```yaml
kind: Deployment
apiVersion: apps/v1
metadata:
  labels:
    app: item1-tomcat-app1-deployment-label
  name: item1-tomcat-app1-deployment
  namespace: item1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: item1-tomcat-app1-selector
  template:
    metadata:
      labels:
        app: item1-tomcat-app1-selector
    spec:
      imagePullSecrets:
      - name: harbor-secret
      containers:
      - name: item1-tomcat-app1-container
        image: harbor.xtec.com/item1/tomcat:8.5.43_20250117_013112
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
          protocol: TCP
          name: http
        env:
        - name: &quot;password&quot;
          value: &quot;123456&quot;
        - name: &quot;age&quot;
          value: &quot;18&quot;
        resources:
          limits:
            cpu: 1
            memory: &quot;512Mi&quot;
          requests:
            cpu: 500m
            memory: &quot;512Mi&quot;
        volumeMounts:
        - name: item1-images
          mountPath: /usr/local/nginx/html/webapp/images
          readOnly: false
        - name: item1-static
          mountPath: /usr/local/nginx/html/webapp/static
          readOnly: false
      volumes:
      - name: item1-images
        nfs:
          server: 172.31.7.20
          path: /data/k8sdata/item1/images
      - name: item1-static
        nfs:
          server: 172.31.7.20
          path: /data/k8sdata/item1/static

---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: item1-tomcat-app1-service-label
  name: item1-tomcat-app1-service
  namespace: item1
spec:
  type: NodePort
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
    nodePort: 30092
  selector:
    app: item1-tomcat-app1-selector
</code></pre>
<p><strong>åŠŸèƒ½è¯´æ˜</strong>ï¼š</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>item1-tomcat-app1-deployment</code> çš„éƒ¨ç½²ï¼Œä½¿ç”¨ä¸¤ä¸ªå‰¯æœ¬ï¼ˆreplicas: 2ï¼‰ã€‚</li>
<li>æ¯ä¸ªå®¹å™¨ä½¿ç”¨ <code>harbor.xtec.com/item1/tomcat:8.5.43_20250117_013112</code> é•œåƒï¼Œå¹¶æš´éœ²8080ç«¯å£ã€‚</li>
<li>ä½¿ç”¨NFSæŒ‚è½½å·æ¥å­˜å‚¨é™æ€èµ„æºã€‚</li>
<li>å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>item1-tomcat-app1-service</code> çš„æœåŠ¡ï¼Œç±»å‹ä¸º <code>NodePort</code>ï¼Œå°†é›†ç¾¤å†…éƒ¨çš„8080ç«¯å£æ˜ å°„åˆ°èŠ‚ç‚¹ä¸Šçš„30092ç«¯å£ã€‚</li>
</ul>
<h3 id="2-dockerfile">2. <strong>Dockerfile</strong></h3>
<p>è¿™ä¸ªDockerfileåŸºäºHarboré•œåƒä»“åº“ä¸­çš„åŸºç¡€Tomcaté•œåƒæ„å»ºä¸€ä¸ªæ–°çš„Tomcatåº”ç”¨é•œåƒã€‚</p>
<pre><code class="language-dockerfile">FROM harbor.xtec.com/pub-images/tomcat:8.5.43_20250107_235050

# åˆ›å»ºå¹¶è®¾ç½® Tomcat åº”ç”¨ç›®å½•
RUN mkdir -p /data/tomcat/webapps/myapp &amp;&amp; \
    chown -R tomcat:tomcat /data/tomcat/webapps/myapp

# æ¸…ç©ºé»˜è®¤åº”ç”¨ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
COPY catalina.sh /apps/tomcat/bin/catalina.sh
COPY server.xml /apps/tomcat/conf/server.xml
COPY app1.tar.gz /data/tomcat/webapps/myapp/app1.tar.gz
COPY run_tomcat.sh /apps/tomcat/bin/run_tomcat.sh

# è§£å‹åº”ç”¨åŒ…å¹¶è®¾ç½®æƒé™
RUN tar -xzf /data/tomcat/webapps/myapp/app1.tar.gz -C /data/tomcat/webapps/myapp/ &amp;&amp; \
    rm /data/tomcat/webapps/myapp/app1.tar.gz &amp;&amp; \
    chown -R tomcat:tomcat /data/ /apps/ &amp;&amp; \
    chmod +x /apps/tomcat/bin/catalina.sh /apps/tomcat/bin/run_tomcat.sh

# æ¸…ç† Tomcat å·¥ä½œç›®å½•
RUN rm -rf /apps/tomcat/work/Catalina/localhost/*

# å¥åº·æ£€æŸ¥
HEALTHCHECK CMD curl -f http://localhost:8080 || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080 8443

# å¯åŠ¨å‘½ä»¤
CMD [&quot;/apps/tomcat/bin/run_tomcat.sh&quot;]
</code></pre>
<p><strong>åŠŸèƒ½è¯´æ˜</strong>ï¼š</p>
<ul>
<li>åŸºäºåŸºç¡€Tomcaté•œåƒåˆ›å»ºæ–°çš„é•œåƒã€‚</li>
<li>è®¾ç½®åº”ç”¨ç›®å½•å¹¶å¤åˆ¶å¿…è¦çš„é…ç½®æ–‡ä»¶å’Œåº”ç”¨ç¨‹åºåŒ…ã€‚</li>
<li>è§£å‹ç¼©åº”ç”¨ç¨‹åºåŒ…å¹¶è®¾ç½®æ­£ç¡®çš„æƒé™ã€‚</li>
<li>æ¸…ç†Tomcatçš„å·¥ä½œç›®å½•ä»¥ç¡®ä¿å¹²å‡€å¯åŠ¨ã€‚</li>
<li>æ·»åŠ å¥åº·æ£€æŸ¥ä»¥ç¡®ä¿Tomcatæ­£å¸¸è¿è¡Œã€‚</li>
<li>æš´éœ²8080å’Œ8443ç«¯å£ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬å¯åŠ¨Tomcatã€‚</li>
</ul>
<h3 id="3-é•œåƒæ„å»ºè„šæœ¬-build-commandsh">3. <strong>é•œåƒæ„å»ºè„šæœ¬ (<code>build-command.sh</code>)</strong></h3>
<p>è¿™ä¸ªè„šæœ¬ç”¨äºæ„å»ºå’Œæ¨é€Dockeré•œåƒåˆ°Harboré•œåƒä»“åº“ã€‚</p>
<pre><code class="language-bash">#!/bin/bash
# build-command.sh - æ„å»ºå’Œæ¨é€ Docker é•œåƒè„šæœ¬
# Author: orochw
# Updated: 2025-01-16

HARBOR=&quot;harbor.xtec.com&quot;
REPO=&quot;item1&quot;
IMAGE=&quot;tomcat&quot;
FIXED_TAG=&quot;8.5.43&quot;
DOCKERFILE_DIR=&quot;/opt/k8s-data/dockerfile/web/item1/tomcat-app1&quot;

# ç¡®ä¿æ¥æ”¶æ—¶é—´æˆ³å‚æ•°
if [ -z &quot;$1&quot; ]; then
  echo &quot;ERROR: Date timestamp is missing!&quot;
  exit 1
fi
DATE=$1
FULL_IMAGE=&quot;$HARBOR/$REPO/$IMAGE:${FIXED_TAG}_$DATE&quot;

log() {
  echo &quot;[$(date +'%Y-%m-%d %H:%M:%S')] $1&quot;
}

ERROR_exit() {
  echo &quot;[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1&quot;
  exit 1
}

# æ£€æŸ¥ Docker æ˜¯å¦å¯ç”¨
docker -v &gt;/dev/null 2&gt;&amp;1 || ERROR_exit &quot;Docker æœªå®‰è£…æˆ–ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒï¼&quot;

# æ„å»º Docker é•œåƒ
log &quot;å¼€å§‹æ„å»º Docker é•œåƒ: $FULL_IMAGE&quot;
docker build -t $FULL_IMAGE $DOCKERFILE_DIR || ERROR_exit &quot;Docker æ„å»ºå¤±è´¥ï¼&quot;

# æ¨é€ Docker é•œåƒ
log &quot;å¼€å§‹æ¨é€ Docker é•œåƒ: $FULL_IMAGE&quot;
docker push $FULL_IMAGE || ERROR_exit &quot;Docker æ¨é€å¤±è´¥ï¼&quot;

log &quot;Docker é•œåƒæ„å»ºå’Œæ¨é€å®Œæˆ: $FULL_IMAGE&quot;
</code></pre>
<p><strong>åŠŸèƒ½è¯´æ˜</strong>ï¼š</p>
<ul>
<li>ç¡®ä¿ä¼ é€’äº†æ—¶é—´æˆ³å‚æ•°ï¼Œå¹¶ç”Ÿæˆå®Œæ•´çš„é•œåƒåç§°ã€‚</li>
<li>æ£€æŸ¥Dockeræ˜¯å¦å¯ç”¨ã€‚</li>
<li>æ„å»ºå¹¶æ¨é€é•œåƒåˆ°æŒ‡å®šçš„Harborä»“åº“ã€‚</li>
</ul>
<h3 id="4-cicd-è„šæœ¬">4. <strong>CI/CD è„šæœ¬</strong></h3>
<p>è¿™ä¸ªè„šæœ¬å®ç°äº†ä»ä»£ç å…‹éš†ã€æ‰“åŒ…ã€ä¼ è¾“ã€é•œåƒæ„å»ºã€æ›´æ–°Kubernetesé…ç½®åˆ°åº”ç”¨æ›´æ”¹çš„æ•´ä¸ªCI/CDæµç¨‹ã€‚</p>
<pre><code class="language-bash">#!/bin/bash

# é…ç½®éƒ¨åˆ†
HARBOR=&quot;harbor.xtec.com&quot;
REPO=&quot;item1&quot;
IMAGE=&quot;tomcat&quot;
FIXED_TAG=&quot;8.5.43&quot;
K8S_CONTROLLER=&quot;172.31.7.11&quot;
GIT_URL=&quot;git@172.31.7.22:item1/app1.git&quot;
SRC_DIR=&quot;/data/gitdata/item1/app1&quot;
DEST_DIR=&quot;/opt/k8s-data/dockerfile/web/item1/tomcat-app1&quot;
K8S_YAML=&quot;/opt/k8s-data/yaml/item1/tomcat-app1/tomcat-app1.yaml&quot;

# è®°å½•å¼€å§‹æ—¶é—´
starttime=$(date +'%Y-%m-%d %H:%M:%S')

# å‡½æ•°å®šä¹‰
log() {
  echo &quot;[$(date +'%Y-%m-%d %H:%M:%S')] $1&quot;
}

ERROR_exit() {
  echo &quot;[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1&quot;
  exit 1
}

code_clone() {
  log &quot;å¼€å§‹æ‹‰å–ä»£ç åˆ†æ”¯: $BRANCH&quot;
  mkdir -p $(dirname $SRC_DIR)
  rm -rf $SRC_DIR
  git clone -b $BRANCH $GIT_URL $SRC_DIR || ERROR_exit &quot;Git å…‹éš†å¤±è´¥ï¼&quot;
  log &quot;ä»£ç æ‹‰å–å®Œæˆ&quot;
}

package_file() {
  log &quot;å¼€å§‹æ‰“åŒ…ä»£ç æ–‡ä»¶&quot;
  mkdir -p $DEST_DIR
  tar -czf $DEST_DIR/app1.tar.gz -C $SRC_DIR . || ERROR_exit &quot;æ–‡ä»¶æ‰“åŒ…å¤±è´¥ï¼&quot;
  log &quot;æ–‡ä»¶æ‰“åŒ…å®Œæˆ: $DEST_DIR/app1.tar.gz&quot;
}

copy_file() {
  log &quot;å¼€å§‹å¤åˆ¶æ–‡ä»¶åˆ° K8S æ§åˆ¶å™¨: $K8S_CONTROLLER&quot;
  ssh root@$K8S_CONTROLLER &quot;mkdir -p $DEST_DIR&quot;
  scp -r $DEST_DIR/* root@$K8S_CONTROLLER:$DEST_DIR || ERROR_exit &quot;æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼&quot;
  log &quot;æ–‡ä»¶æˆåŠŸå¤åˆ¶åˆ° $K8S_CONTROLLER:$DEST_DIR&quot;
}

build_image() {
  log &quot;å¼€å§‹æ„å»ºå’Œæ¨é€ Docker é•œåƒ: $FULL_IMAGE&quot;
  ssh root@$K8S_CONTROLLER &lt;&lt;EOF
    cd $DEST_DIR
    chmod +x build-command.sh
    ./build-command.sh $DATE || exit 1
EOF
  [ $? -ne 0 ] &amp;&amp; ERROR_exit &quot;Docker é•œåƒæ„å»ºæˆ–æ¨é€å¤±è´¥ï¼&quot;
  log &quot;Docker é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆ: $FULL_IMAGE&quot;
}

update_k8s_yaml() {
  log &quot;å¼€å§‹æ›´æ–° Kubernetes YAML æ–‡ä»¶&quot;
  ssh root@$K8S_CONTROLLER &lt;&lt;EOF
    if [ -f $K8S_YAML ]; then
      sed -i &quot;s|image: $HARBOR/$REPO/$IMAGE:.*|image: $FULL_IMAGE|g&quot; $K8S_YAML
      if ! grep -q 'imagePullSecrets' $K8S_YAML; then
        sed -i '/containers:/i \      imagePullSecrets:\n      - name: harbor-secret' $K8S_YAML
      fi
    else
      echo &quot;ERROR: Kubernetes YAML æ–‡ä»¶ä¸å­˜åœ¨: $K8S_YAML&quot;
      exit 1
    fi
EOF
  [ $? -ne 0 ] &amp;&amp; ERROR_exit &quot;Kubernetes YAML æ–‡ä»¶æ›´æ–°å¤±è´¥ï¼&quot;
  log &quot;Kubernetes YAML æ–‡ä»¶æ›´æ–°å®Œæˆ&quot;
}

apply_k8s_changes() {
  log &quot;åº”ç”¨ Kubernetes éƒ¨ç½²æ›´æ–°&quot;
  ssh root@$K8S_CONTROLLER &quot;kubectl apply -f $K8S_YAML&quot; || ERROR_exit &quot;Kubernetes éƒ¨ç½²æ›´æ–°å¤±è´¥ï¼&quot;
  log &quot;Kubernetes éƒ¨ç½²æ›´æ–°å®Œæˆ&quot;
}

rollback_last_version() {
  log &quot;å¼€å§‹å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬&quot;
  ssh root@$K8S_CONTROLLER &quot;kubectl rollout undo deployment/item1-tomcat-app1-deployment -n item1&quot; || ERROR_exit &quot;å›æ»šå¤±è´¥ï¼&quot;
  log &quot;å›æ»šæˆåŠŸ&quot;
}

# æ˜¾ç¤ºç”¨æ³•
usage() {
  echo &quot;Usage: $0 {deploy|rollback_last_version} [branch]&quot;
}

# å‚æ•°å¤„ç†
OPERATION=${1:-deploy}
BRANCH=${2:-main} # é»˜è®¤åˆ†æ”¯ä¸º main
DATE=$(date +%Y%m%d_%H%M%S)
FULL_IMAGE=&quot;$HARBOR/$REPO/$IMAGE:${FIXED_TAG}_$DATE&quot;

# ä¸»é€»è¾‘
case $OPERATION in
  deploy)
    code_clone
    package_file
    copy_file
    build_image
    update_k8s_yaml
    apply_k8s_changes
    ;;
  rollback_last_version)
    rollback_last_version
    ;;
  *)
    usage
    exit 1
    ;;
esac

# æ˜¾ç¤ºæ€»è€—æ—¶
endtime=$(date +'%Y-%m-%d %H:%M:%S')
start_seconds=$(date --date=&quot;$starttime&quot; +%s)
end_seconds=$(date --date=&quot;$endtime&quot; +%s)
log &quot;æ€»æ‰§è¡Œæ—¶é—´: $((end_seconds - start_seconds)) ç§’&quot;
</code></pre>
<p><strong>åŠŸèƒ½è¯´æ˜</strong>ï¼š</p>
<ul>
<li><strong>code_clone</strong>: ä»æŒ‡å®šGitä»“åº“æ‹‰å–ç‰¹å®šåˆ†æ”¯çš„ä»£ç ã€‚</li>
<li><strong>package_file</strong>: å°†ä»£ç æ‰“åŒ…æˆ<code>.tar.gz</code>æ ¼å¼ã€‚</li>
<li><strong>copy_file</strong>: å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å¤åˆ¶åˆ°Kubernetesæ§åˆ¶å™¨èŠ‚ç‚¹ã€‚</li>
<li><strong>build_image</strong>: åœ¨Kubernetesæ§åˆ¶å™¨ä¸Šæ„å»ºå¹¶æ¨é€Dockeré•œåƒã€‚</li>
<li><strong>update_k8s_yaml</strong>: æ›´æ–°Kubernetes YAMLæ–‡ä»¶ä¸­çš„é•œåƒåœ°å€ï¼Œå¹¶æ·»åŠ <code>imagePullSecrets</code>éƒ¨åˆ†ã€‚</li>
<li><strong>apply_k8s_changes</strong>: åº”ç”¨æ›´æ–°åçš„YAMLæ–‡ä»¶åˆ°Kubernetesé›†ç¾¤ã€‚</li>
<li><strong>rollback_last_version</strong>: å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ã€‚</li>
<li><strong>ä¸»é€»è¾‘</strong>: æ ¹æ®ä¼ å…¥çš„æ“ä½œç±»å‹ï¼ˆ<code>deploy</code>æˆ–<code>rollback_last_version</code>ï¼‰æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</li>
</ul>
<h3 id="è„šæœ¬ä¸­çš„å‡½æ•°åŠå…¶ä½œç”¨">è„šæœ¬ä¸­çš„å‡½æ•°åŠå…¶ä½œç”¨</h3>
<p>ä»¥ä¸‹æ˜¯è„šæœ¬ä¸­å®šä¹‰çš„ä¸»è¦å‡½æ•°åŠå…¶ä½œç”¨ï¼š</p>
<ol>
<li>
<p><strong><code>log()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: æ‰“å°å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œè¿½è¸ªè„šæœ¬æ‰§è¡Œè¿‡ç¨‹ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">log &quot;å¼€å§‹æ„å»º Docker é•œåƒ: $FULL_IMAGE&quot;
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>ERROR_exit()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: å½“å‘ç”Ÿé”™è¯¯æ—¶æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºè„šæœ¬æ‰§è¡Œï¼Œç¡®ä¿é—®é¢˜ä¸ä¼šè¢«å¿½ç•¥ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">ERROR_exit &quot;Docker æ„å»ºå¤±è´¥ï¼&quot;
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>code_clone()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: ä»æŒ‡å®šGitä»“åº“å…‹éš†ä»£ç åˆ°æœ¬åœ°ç›®å½•ï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¯ä»¥è®¿é—®è¿™äº›ä»£ç è¿›è¡Œæ‰“åŒ…å’Œæ„å»ºã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">code_clone
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>package_file()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: å°†å…‹éš†ä¸‹æ¥çš„ä»£ç æ‰“åŒ…æˆå‹ç¼©æ–‡ä»¶ï¼ˆå¦‚<code>.tar.gz</code>ï¼‰ï¼Œä»¥ä¾¿ä¼ è¾“åˆ°Kubernetesæ§åˆ¶å™¨èŠ‚ç‚¹ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">package_file
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>copy_file()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: ä½¿ç”¨<code>scp</code>å‘½ä»¤å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å¤åˆ¶åˆ°Kubernetesæ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šçš„æŒ‡å®šç›®å½•ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">copy_file
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>build_image()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: åœ¨Kubernetesæ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šè¿è¡Œ<code>build-command.sh</code>è„šæœ¬ï¼Œå®é™…æ‰§è¡Œé•œåƒçš„æ„å»ºå’Œæ¨é€æ“ä½œã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">build_image
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>update_k8s_yaml()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: æ›´æ–°Kubernetes YAMLé…ç½®æ–‡ä»¶ï¼Œç¡®ä¿å…¶å¼•ç”¨çš„æ˜¯æœ€æ–°æ„å»ºçš„é•œåƒã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">update_k8s_yaml
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>apply_k8s_changes()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: åº”ç”¨æ›´æ–°åçš„Kubernetes YAMLé…ç½®æ–‡ä»¶ï¼Œè§¦å‘é›†ç¾¤å†…çš„éƒ¨ç½²æ›´æ–°ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">apply_k8s_changes
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong><code>rollback_last_version()</code></strong>:</p>
<ul>
<li><strong>ä½œç”¨</strong>: å›æ»šåˆ°å‰ä¸€ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œä½¿ç”¨Kubernetesçš„<code>rollout undo</code>å‘½ä»¤å®ç°ã€‚</li>
<li><strong>ç¤ºä¾‹è°ƒç”¨</strong>:<pre><code class="language-bash">rollback_last_version
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="è¿™äº›å‡½æ•°å…±åŒæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ä½¿å¾—ä»ä»£ç æäº¤åˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å˜å¾—æ›´åŠ é«˜æ•ˆä¸”å¯ç®¡ç†">è¿™äº›å‡½æ•°å…±åŒæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œä½¿å¾—ä»ä»£ç æäº¤åˆ°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å˜å¾—æ›´åŠ é«˜æ•ˆä¸”å¯ç®¡ç†ã€‚</h2>
<h1 id="å››-åˆ›å»ºjenkinsä»»åŠ¡">å››ã€åˆ›å»ºJenkinsä»»åŠ¡</h1>
<h2 id="1-å®‰è£…sshæ’ä»¶åŠé…ç½®å‡­æ®">1. å®‰è£…SSHæ’ä»¶åŠé…ç½®å‡­æ®</h2>
<h3 id="æ’ä»¶å®‰è£…">æ’ä»¶å®‰è£…</h3>
<ul>
<li><strong>æ­¥éª¤</strong>ï¼šåœ¨Jenkinsä¸­å®‰è£…SSHæ’ä»¶ã€‚</li>
<li><strong>æˆªå›¾</strong>ï¼š<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117024646.png" alt="æ’ä»¶å®‰è£…" loading="lazy"></li>
</ul>
<h3 id="è¿œç¨‹ä¸»æœºè®¾ç½®">è¿œç¨‹ä¸»æœºè®¾ç½®</h3>
<ul>
<li><strong>åˆ›å»ºæ–°çš„å‡­æ®</strong>ï¼š
<ul>
<li>ç™»å½•Jenkins -&gt; ç³»ç»Ÿç®¡ç† -&gt; å‡­æ® -&gt; å…¨å±€ -&gt; æ–°å¢å‡­æ®</li>
<li>ç»“æœå¦‚å›¾ï¼š<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117024756.png" alt="è¿œç¨‹ä¸»æœºè®¾ç½®" loading="lazy"></li>
</ul>
</li>
<li><strong>ç³»ç»Ÿç®¡ç†</strong> -&gt; <strong>ç³»ç»Ÿ</strong> -&gt; <strong>SSH Remote Hosts</strong>
<ul>
<li>è®¾ç½®å¦‚å›¾ï¼š<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117024934.png" alt="SSHè¿œç¨‹ä¸»æœº" loading="lazy"></li>
</ul>
</li>
</ul>
<h2 id="2-åˆ›å»ºä»»åŠ¡">2. åˆ›å»ºä»»åŠ¡</h2>
<ul>
<li><strong>æ–°å»ºä»»åŠ¡</strong>ï¼šé€‰æ‹©â€œè‡ªç”±é£æ ¼é¡¹ç›®â€ç±»å‹ã€‚
<ul>
<li>æˆªå›¾ï¼š<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117024436.png" alt="åˆ›å»ºä»»åŠ¡" loading="lazy"></li>
<li>é…ç½®Gitä»“åº“åœ°å€å’Œåˆ†æ”¯ã€‚</li>
<li>æ„å»ºè§¦å‘å™¨ï¼šå¯ä»¥è®¾ç½®å®šæ—¶æ„å»ºã€è½®è¯¢SCMç­‰è§¦å‘æ¡ä»¶ã€‚</li>
<li>æ„å»ºç¯å¢ƒï¼šå¦‚æœéœ€è¦ï¼Œå¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ç­‰ã€‚</li>
<li>æ„å»ºï¼šæ·»åŠ æ‰§è¡ŒShellè„šæœ¬çš„æ­¥éª¤ï¼Œè°ƒç”¨å‰é¢å‡†å¤‡å¥½çš„CI/CDè„šæœ¬è¿›è¡Œæ„å»ºã€æ‰“åŒ…ã€æ¨é€é•œåƒä»¥åŠæ›´æ–°Kubernetes YAMLæ–‡ä»¶ç­‰æ“ä½œã€‚</li>
</ul>
</li>
</ul>
<h1 id="äº”-æµ‹è¯•cicdæµç¨‹">äº”ã€æµ‹è¯•CI/CDæµç¨‹</h1>
<h2 id="æ›´æ–°æµ‹è¯•">æ›´æ–°æµ‹è¯•</h2>
<h3 id="ä¿®æ”¹indexhtml">ä¿®æ”¹index.html</h3>
<ul>
<li>å¯¹åº”ç”¨çš„<code>index.html</code>æ–‡ä»¶è¿›è¡Œäº†ä¿®æ”¹ï¼Œä½œä¸ºç‰ˆæœ¬æ›´æ–°çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>è§¦å‘Jenkinsä»»åŠ¡æ‰§è¡Œæ›´æ–°æµç¨‹ã€‚</li>
<li>æ§åˆ¶å°è¾“å‡ºæ˜¾ç¤ºäº†ä»å…‹éš†ä»£ç ã€æ‰“åŒ…ã€ä¼ è¾“æ–‡ä»¶ã€æ„å»ºå’Œæ¨é€Dockeré•œåƒã€æ›´æ–°Kubernetes YAMLæ–‡ä»¶åˆ°æœ€ååº”ç”¨æ›´æ”¹çš„å…¨è¿‡ç¨‹ï¼Œå¹¶ä¸”æœ€ç»ˆç»“æœæ˜¾ç¤ºä¸ºSUCCESSã€‚</li>
</ul>
<pre><code class="language-bash">Started by user root
Running as SYSTEM
Building in workspace /var/lib/jenkins/workspace/bash-update-item1-tomcat-app1-deploy
...
Successfully built a524b7dbb530
Successfully tagged harbor.xtec.com/item1/tomcat:8.5.43_20250117_025158
...
deployment.apps/item1-tomcat-app1-deployment configured
service/item1-tomcat-app1-service unchanged
[2025-01-17 02:52:09] Kubernetes ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
[2025-01-17 02:52:09] ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½: 11 ï¿½ï¿½ï¿½
Finished: SUCCESS
</code></pre>
<h3 id="æŸ¥çœ‹æ›´æ–°å‰åçš„ç»“æœ">æŸ¥çœ‹æ›´æ–°å‰åçš„ç»“æœ</h3>
<ul>
<li>æˆªå›¾ï¼š<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117025413.png" alt="æ›´æ–°å‰åå¯¹æ¯”" loading="lazy"></li>
<li><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20250117025433.png" alt="æ›´æ–°å‰åå¯¹æ¯”" loading="lazy"></li>
</ul>
<h2 id="æµ‹è¯•å›æ»š">æµ‹è¯•å›æ»š</h2>
<pre><code class="language-bash">Started by user root
Running as SYSTEM
Building in workspace /var/lib/jenkins/workspace/bash-update-item1-tomcat-app1-deploy
...
deployment.apps/item1-tomcat-app1-deployment rolled back
[2025-01-17 01:32:03] ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
[2025-01-17 01:32:03] ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½: 0 ï¿½ï¿½ï¿½
Finished: SUCCESS
</code></pre>
<hr>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[sshç»ˆç«¯tabbyè¯­æ³•é«˜äº®]]></title>
        <id>https://orochw.github.io/post/ssh-zhong-duan-tabby-yu-fa-gao-liang/</id>
        <link href="https://orochw.github.io/post/ssh-zhong-duan-tabby-yu-fa-gao-liang/">
        </link>
        <updated>2025-01-06T18:10:10.000Z</updated>
        <content type="html"><![CDATA[<pre><code>{
    &quot;id&quot;: &quot;60606be0-c0ff-42bc-bf77-de8a2435447f&quot;,
    &quot;name&quot;: &quot;Default&quot;,
    &quot;keywords&quot;: [
      {
        &quot;text&quot;: &quot;([_a-z0-9-]+(\\.[_a-z0-9-]+)*@[a-z0-9-]+(\\.[a-z0-9-]+)*)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;14&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(?=(\\b|\\D))(((\\d{1,2})|(1\\d{1,2})|(2[0-4]\\d)|(25[0-5]))\\.){3}((\\d{1,2})|(1\\d{1,2})|(2[0-4]\\d)|(25[0-5]))(?=(\\b|\\D))\\s*&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;4&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(http(s)?://[a-zA-Z0-9_.&amp;?=%~#{}()@:+/-]+)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;4&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(\\berror\\b)|(\\bfail(ed)?\\b)|(\\bfalse\\b)|(\\bdown\\b)|(\\blocked\\b)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;1&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(\\bactive(d)?\\b)|(\\bsuccess(ful(ly)?)?\\b)|(\\btrue\\b)|(\\bok\\b)|(\\bup\\b)|(\\brunning\\b)|(\\bdeployed\\b)|(\\bunlocked\\b)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;10&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(\\bstart(ed|ing)?\\b)|(\\bbegin(ning)?\\b)|(\\benable(d)?\\b)|(\\bcreate(d)?\\b)|(\\bopen\\b)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;10&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(\\bstop(ped)?\\b)|(\\bend\\b)|(\\bfinish(ed)?\\b)|(\\bdisable(d)?\\b)|(\\bdelete(d)?\\b)|(\\bclose(d)?\\b)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;13&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;(\\bwarn(ing)?\\b)|(\\binactive\\b)|(\\bunknown\\b)&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;11&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;\\bDEBUG\\b&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;13&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;\\binfo\\b&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;6&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      },
      {
        &quot;text&quot;: &quot;\\/\\b(\\d|([1-9]\\d)|(1[01]\\d)|(12[0-8]))\\b&quot;,
        &quot;enabled&quot;: true,
        &quot;background&quot;: false,
        &quot;backgroundColor&quot;: &quot;0&quot;,
        &quot;foregroundColor&quot;: &quot;4&quot;,
        &quot;isRegExp&quot;: true,
        &quot;foreground&quot;: true,
        &quot;isCaseSensitive&quot;: false
      }
    ]
  }
  
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubernetes v1.29.0 æ”¯æŒdockerçš„å®‰è£…é…ç½®]]></title>
        <id>https://orochw.github.io/post/kubernetes-v1290-zhi-chi-docker-de-an-zhuang-pei-zhi/</id>
        <link href="https://orochw.github.io/post/kubernetes-v1290-zhi-chi-docker-de-an-zhuang-pei-zhi/">
        </link>
        <updated>2024-11-29T21:36:18.000Z</updated>
        <content type="html"><![CDATA[<h1 id="kubernetes-å®‰è£…å’Œé…ç½®æŒ‡å—">Kubernetes å®‰è£…å’Œé…ç½®æŒ‡å—</h1>
<p>Kubernetes æœ¬èº«å¹¶ä¸ç›´æ¥æ”¯æŒ Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œæ˜¯é€šè¿‡ Container Runtime Interface (CRI) æ¥ä¸ä¸åŒçš„å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œäº¤äº’ã€‚CRI æ˜¯ Kubernetes å®šä¹‰çš„ä¸€ç§æ ‡å‡†æ¥å£ï¼Œå…è®¸ Kubernetes ä¸å¤šç§å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ containerdã€CRI-O ç­‰ï¼‰è¿›è¡Œé€šä¿¡ã€‚</p>
<p>Docker å…¬å¸å¼€å‘äº†ä¸€ä¸ªé€‚é…å™¨ <code>cri-dockerd</code>ï¼Œä½¿å¾— Kubernetes å¯ä»¥é€šè¿‡ CRI æ¥å£ä¸ Docker è¿›è¡Œé€šä¿¡ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸æ˜¯å®˜æ–¹æ¨èçš„æ–¹å¼ï¼Œå¹¶ä¸”å­˜åœ¨ä¸€äº›æ½œåœ¨çš„é—®é¢˜å’Œé™åˆ¶ï¼š</p>
<ol>
<li><strong>ç»´æŠ¤å’Œæ”¯æŒ</strong>ï¼š<code>cri-dockerd</code> å¹¶ä¸æ˜¯ç”± Kubernetes ç¤¾åŒºå®˜æ–¹ç»´æŠ¤çš„é¡¹ç›®ï¼Œå› æ­¤åœ¨é‡åˆ°é—®é¢˜æ—¶å¯èƒ½å¾—ä¸åˆ°åŠæ—¶çš„æ”¯æŒã€‚</li>
<li><strong>æ€§èƒ½å’Œç¨³å®šæ€§</strong>ï¼šç”±äºé¢å¤–çš„é€‚é…å±‚ï¼Œä½¿ç”¨ <code>cri-dockerd</code> å¯èƒ½ä¼šå¯¼è‡´ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¹¶ä¸”å¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜ã€‚</li>
<li><strong>åŠŸèƒ½å…¼å®¹æ€§</strong>ï¼šæŸäº›é«˜çº§åŠŸèƒ½å’Œä¼˜åŒ–å¯èƒ½æ— æ³•å®Œå…¨é€šè¿‡ <code>cri-dockerd</code> å®ç°ï¼Œå¯¼è‡´æ— æ³•å……åˆ†åˆ©ç”¨ Kubernetes çš„å…¨éƒ¨æ½œåŠ›ã€‚</li>
<li><strong>ç¤¾åŒºè¶‹åŠ¿</strong>ï¼šå¤§å¤šæ•° Kubernetes ç”¨æˆ·å’Œç¤¾åŒºéƒ½åœ¨è½¬å‘ä½¿ç”¨ containerd æˆ– CRI-Oï¼Œè¿™äº›æ˜¯ Kubernetes å®˜æ–¹æ¨èçš„å®¹å™¨è¿è¡Œæ—¶ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ <code>cri-dockerd</code> åœ¨ Kubernetes ä¸­ä½¿ç”¨ Dockerï¼Œä½†ä¸ºäº†æ›´å¥½çš„æ€§èƒ½ã€ç¨³å®šæ€§å’Œç¤¾åŒºæ”¯æŒï¼Œå»ºè®®ä½¿ç”¨å®˜æ–¹æ¨èçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚ containerd æˆ– CRI-Oã€‚</p>
<p>å¦‚æœä½ ä»ç„¶å¸Œæœ›ç»§ç»­ä½¿ç”¨ Dockerï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ­¥éª¤å®‰è£…å’Œé…ç½® <code>cri-dockerd</code>ï¼š</p>
<h3 id="å®‰è£…-containerd">å®‰è£… containerd</h3>
<p>containerd æ˜¯ä¸€ä¸ªè½»é‡çº§çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œä¹Ÿæ˜¯ Kubernetes å®˜æ–¹æ¨èçš„é»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä¹‹ä¸€ã€‚</p>
<pre><code class="language-bash"># é…ç½® containerd çš„ yum æº
cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/containerd.repo
[containerd]
name=containerd NEAR Repo
baseurl=https://download.opensuse.org/repositories/home:/kubic:/project:/containers:/stable:/cri-o-1.29/CentOS_8/
enabled=1
gpgcheck=1
gpgkey=https://download.opensuse.org/repositories/home:/kubic:/project:/containers:/stable:/cri-o-1.29/CentOS_8/repodata/repomd.xml.key
EOF

# å®‰è£… containerd
sudo yum install -y containerd

# é…ç½® containerd
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml

# å¯åŠ¨å¹¶å¯ç”¨ containerd æœåŠ¡
sudo systemctl restart containerd
sudo systemctl enable containerd
</code></pre>
<h3 id="é…ç½®-kubernetes-ä½¿ç”¨-containerd">é…ç½® Kubernetes ä½¿ç”¨ containerd</h3>
<p>ç¼–è¾‘ <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> æ–‡ä»¶ï¼Œç¡®ä¿ <code>--container-runtime</code> è®¾ç½®ä¸º <code>remote</code>ï¼Œå¹¶ä¸” <code>--container-runtime-endpoint</code> è®¾ç½®ä¸º <code>unix:///run/containerd/containerd.sock</code>ã€‚</p>
<pre><code class="language-bash"># ç¼–è¾‘ kubelet é…ç½®æ–‡ä»¶
sudo sed -i 's/--container-runtime=docker/--container-runtime=remote/' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
sudo sed -i 's/--container-runtime-endpoint=unix:\/\/\/var\/run\/docker.sock/--container-runtime-endpoint=unix:\/\/\/run\/containerd\/containerd.sock/' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

# é‡å¯ kubelet æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart kubelet
</code></pre>
<p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥å°† Kubernetes é…ç½®ä¸ºä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œä»è€Œè·å¾—æ›´å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚</p>
<h2 id="1-ä¿®æ”¹ä¸»æœºå">1. ä¿®æ”¹ä¸»æœºå</h2>
<pre><code class="language-bash">hostnamectl set-hostname &lt;your-hostname&gt;
</code></pre>
<h2 id="2-å®‰è£…-ipvs">2. å®‰è£… IPVS</h2>
<pre><code class="language-bash">yum install -y ipvsadm
</code></pre>
<h2 id="3-å¼€å¯è·¯ç”±è½¬å‘">3. å¼€å¯è·¯ç”±è½¬å‘</h2>
<pre><code class="language-bash">echo &quot;net.ipv4.ip_forward=1&quot; &gt;&gt; /etc/sysctl.conf
yum install -y epel-release
yum install -y bridge-utils
modprobe br_netfilter
echo 'br_netfilter' &gt;&gt; /etc/modules-load.d/bridge.conf
echo 'net.bridge.bridge-nf-call-iptables=1' &gt;&gt; /etc/sysctl.conf
echo 'net.bridge.bridge-nf-call-ip6tables=1' &gt;&gt; /etc/sysctl.conf
sysctl -p
</code></pre>
<h2 id="4-å®‰è£…-docker">4. å®‰è£… Docker</h2>
<pre><code class="language-bash">sudo dnf config-manager --add-repo https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo
cd /etc/yum.repos.d
sed -i 's|download.docker.com|mirrors.ustc.edu.cn/docker-ce|g' docker-ce.repo
yum -y install docker-ce

cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  &quot;data-root&quot;: &quot;/data/docker&quot;,
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;,
    &quot;max-file&quot;: &quot;100&quot;
  },
  &quot;insecure-registries&quot;: [&quot;harbor.xinxainghf.com&quot;],
  &quot;registry-mirrors&quot;: [&quot;https://kfp63jaj.mirror.aliyuncs.com&quot;]
}
EOF

mkdir -p /etc/systemd/system/docker.service.d
systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl enable docker
</code></pre>
<h2 id="5-å®‰è£…-cri-dockerd-cri-ç¿»è¯‘å™¨">5. å®‰è£… cri-dockerd -&gt; CRI ç¿»è¯‘å™¨</h2>
<pre><code class="language-bash">wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.9/cri-dockerd-0.3.9.amd64.tgz
tar -xf cri-dockerd-0.3.9.amd64.tgz
cp cri-dockerd/cri-dockerd /usr/bin/
chmod +x /usr/bin/cri-dockerd
</code></pre>
<h2 id="6-é…ç½®å¥—æ¥å­—å’Œç¼–å†™å¯åŠ¨é…ç½®">6. é…ç½®å¥—æ¥å­—å’Œç¼–å†™å¯åŠ¨é…ç½®</h2>
<pre><code class="language-bash">cat &gt; /usr/lib/systemd/system/cri-docker.service &lt;&lt;EOF
[Unit]
Description=CRI Interface for Docker Application Container Engine
Documentation=https://docs.mirantis.com
After=network-online.target firewalld.service docker.service
Wants=network-online.target
Requires=cri-docker.socket

[Service]
Type=notify
ExecStart=/usr/bin/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.8
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always
StartLimitBurst=3
StartLimitInterval=60s
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
Delegate=yes
KillMode=process

[Install]
WantedBy=multi-user.target
EOF

cat &gt; /usr/lib/systemd/system/cri-docker.socket &lt;&lt;EOF
[Unit]
Description=CRI Docker socket for the API
PartOf=cri-docker.service

[Socket]
ListenStream=%t/cri-dockerd.sock
SocketMode=0660
SocketUser=root
SocketGroup=docker

[Install]
WantedBy=sockets.target
EOF
</code></pre>
<h2 id="7-æ£€æŸ¥æœåŠ¡">7. æ£€æŸ¥æœåŠ¡</h2>
<pre><code class="language-bash">systemctl daemon-reload
systemctl enable cri-docker
systemctl start cri-docker
systemctl is-active cri-docker
</code></pre>
<h2 id="8-å®‰è£…-kubernetes">8. å®‰è£… Kubernetes</h2>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
enabled=1
gpgcheck=1
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
EOF

yum install -y kubelet-1.29.0 kubectl-1.29.0 kubeadm-1.29.0
systemctl enable kubelet.service
</code></pre>
<h2 id="9-åˆå§‹åŒ–-master-èŠ‚ç‚¹">9. åˆå§‹åŒ– Master èŠ‚ç‚¹</h2>
<p>åœ¨ Master èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">kubeadm init --apiserver-advertise-address=192.168.234.11 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version 1.29.1 --service-cidr=10.10.0.0/12 --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=all --cri-socket unix:///var/run/cri-dockerd.sock
</code></pre>
<h2 id="10-åŠ å…¥-worker-èŠ‚ç‚¹">10. åŠ å…¥ Worker èŠ‚ç‚¹</h2>
<p>åœ¨ Worker èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">kubeadm join 192.168.234.11:6443 --token vglwnn.qy5s0raiun1yufdi --discovery-token-ca-cert-hash sha256:951d73488711366cbc3028d93c4cdc52c240d78ff49b32fbef942e1eee9c7454 --cri-socket unix:///var/run/cri-dockerd.sock
</code></pre>
<h2 id="11-å®‰è£…ç½‘ç»œæ’ä»¶-calico">11. å®‰è£…ç½‘ç»œæ’ä»¶ Calico</h2>
<p>ç¼–è¾‘ Calico å®‰è£… YAML æ–‡ä»¶å¹¶åº”ç”¨ï¼š</p>
<pre><code class="language-bash">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</code></pre>
<p>æ ¹æ®éœ€è¦ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š</p>
<pre><code class="language-yaml">- name: CALICO_IPV4POOL_CIDR
  value: &quot;10.244.0.0/16&quot;

- name: CALICO_IPV4POOL_VXLAN
  value: &quot;Always&quot;
</code></pre>
<h2 id="12-å®‰è£…-kubernetes-å‘½ä»¤å¢å¼ºè¡¥å…¨">12. å®‰è£… Kubernetes å‘½ä»¤å¢å¼ºè¡¥å…¨</h2>
<pre><code class="language-bash">yum install bash-completion -y
echo &quot;source /usr/share/bash-completion/bash_completion&quot; &gt;&gt; ~/.bashrc
echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc
source ~/.bashrc
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[rsyncåŒæ­¥]]></title>
        <id>https://orochw.github.io/post/rsync-tong-bu/</id>
        <link href="https://orochw.github.io/post/rsync-tong-bu/">
        </link>
        <updated>2024-10-19T17:21:10.000Z</updated>
        <content type="html"><![CDATA[<h1 id="rsync">rsync</h1>
<h2 id="ä¸€-ä»‹ç»">ä¸€ã€ä»‹ç»</h2>
<p><code>rsync</code> æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ã€é«˜æ•ˆçš„ç”¨äºæ•°æ®é•œåƒï¼ˆå¤‡ä»½ï¼‰ã€æ–‡ä»¶ä¼ è¾“å’ŒåŒæ­¥çš„å·¥å…·ã€‚å®ƒå¯ä»¥åœ¨æœ¬åœ°ä¸»æœºå’Œè¿œç¨‹ä¸»æœºä¹‹é—´è¿›è¡Œå¿«é€ŸåŒæ­¥ï¼Œå¹¶ä¸”åªä¼ è¾“ä¸¤ä¸ªæœºå™¨ä¹‹é—´ä¸åŒçš„éƒ¨åˆ†ã€‚</p>
<h3 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h3>
<pre><code class="language-bash">rsync [é€‰é¡¹] æºç›®å½• ç›®æ ‡ç›®å½•
</code></pre>
<ul>
<li><strong>æºç›®å½•</strong>ï¼šè¦åŒæ­¥çš„æºæ–‡ä»¶æˆ–ç›®å½•ã€‚</li>
<li><strong>ç›®æ ‡ç›®å½•</strong>ï¼šåŒæ­¥çš„ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•ã€‚</li>
</ul>
<h3 id="å¸¸ç”¨é€‰é¡¹">å¸¸ç”¨é€‰é¡¹</h3>
<ul>
<li><code>-a</code>ï¼šå½’æ¡£æ¨¡å¼ï¼Œä¿ç•™æ‰€æœ‰æ–‡ä»¶å±æ€§ï¼ŒåŒ…æ‹¬æƒé™ã€æ—¶é—´ã€ç»„ã€æ‰€æœ‰è€…ç­‰ã€‚ç­‰åŒäº <code>-rlptgoD</code>ã€‚</li>
<li><code>-r</code>ï¼šé€’å½’å¤„ç†ç›®å½•ã€‚</li>
<li><code>-l</code>ï¼šä¿ç•™è½¯é“¾æ¥ã€‚</li>
<li><code>-p</code>ï¼šä¿ç•™æƒé™ã€‚</li>
<li><code>-t</code>ï¼šä¿ç•™ä¿®æ”¹æ—¶é—´ã€‚</li>
<li><code>-g</code>ï¼šä¿ç•™ç»„ã€‚</li>
<li><code>-o</code>ï¼šä¿ç•™æ‰€æœ‰è€…ã€‚</li>
<li><code>-D</code>ï¼šä¿ç•™è®¾å¤‡æ–‡ä»¶å’Œç‰¹æ®Šæ–‡ä»¶ã€‚</li>
<li><code>-v</code>ï¼šè¯¦ç»†æ¨¡å¼ï¼Œæ˜¾ç¤ºè¯¦ç»†çš„ä¼ è¾“è¿‡ç¨‹ã€‚</li>
<li><code>-z</code>ï¼šå‹ç¼©ä¼ è¾“æ•°æ®ï¼Œå¯ä»¥åŠ å¿«ä¼ è¾“é€Ÿåº¦ï¼Œå°¤å…¶æ˜¯å¯¹äºæ–‡æœ¬æ–‡ä»¶ã€‚</li>
<li><code>-e</code>ï¼šæŒ‡å®šè¿œç¨‹ shellï¼Œé€šå¸¸ä¸º <code>ssh</code>ã€‚</li>
<li><code>--delete</code>ï¼šåˆ é™¤ç›®æ ‡ç›®å½•ä¸­ä¸å­˜åœ¨äºæºç›®å½•çš„æ–‡ä»¶ã€‚</li>
<li><code>--exclude=PATTERN</code>ï¼šæ’é™¤ç¬¦åˆ PATTERN çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li>
<li><code>--include=PATTERN</code>ï¼šä»…åŒ…å«ç¬¦åˆ PATTERN çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li>
</ul>
<h2 id="äºŒ-å®‰è£…é…ç½®">äºŒã€å®‰è£…é…ç½®</h2>
<h3 id="1-æ£€æŸ¥æ˜¯å¦å®‰è£…">1. æ£€æŸ¥æ˜¯å¦å®‰è£…</h3>
<pre><code class="language-bash">[root@234-12 ~]# rpm -qa | grep rsync
rsync-3.1.2-12.el7_9.x86_64
</code></pre>
<p>å¦‚æœå‘½ä»¤ç»“æœä¸ºç©ºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š</p>
<pre><code class="language-bash">yum install -y rsync
</code></pre>
<h3 id="2-é…ç½®æ–‡ä»¶è§£æ">2. é…ç½®æ–‡ä»¶è§£æ</h3>
<h4 id="æŸ¥çœ‹-rsync-å®‰è£…æ–‡ä»¶æƒ…å†µ">æŸ¥çœ‹ rsync å®‰è£…æ–‡ä»¶æƒ…å†µ</h4>
<pre><code class="language-bash">[root@234-12 ~]# rpm -ql rsync
/etc/rsyncd.conf          # é…ç½®æ–‡ä»¶
/etc/sysconfig/rsyncd     # å®ˆæŠ¤è¿›ç¨‹é…ç½®
/usr/bin/rsync            # å‘½ä»¤æ‰€åœ¨ç›®å½•
/usr/lib/systemd/system/rsyncd.service  # systemctl æœåŠ¡ç®¡ç†
/usr/lib/systemd/system/rsyncd.socket    # è¿›ç¨‹ç”Ÿæˆçš„å¥—æ¥å­—æ–‡ä»¶
/usr/lib/systemd/system/rsyncd@.service
/usr/share/doc/rsync-3.1.2
/usr/share/doc/rsync-3.1.2/COPYING
/usr/share/doc/rsync-3.1.2/NEWS
/usr/share/doc/rsync-3.1.2/OLDNEWS
/usr/share/doc/rsync-3.1.2/README
/usr/share/doc/rsync-3.1.2/support
/usr/share/doc/rsync-3.1.2/support/Makefile
/usr/share/doc/rsync-3.1.2/support/atomic-rsync
/usr/share/doc/rsync-3.1.2/support/cvs2includes
/usr/share/doc/rsync-3.1.2/support/deny-rsync
/usr/share/doc/rsync-3.1.2/support/file-attr-restore
/usr/share/doc/rsync-3.1.2/support/files-to-excludes
/usr/share/doc/rsync-3.1.2/support/git-set-file-times
/usr/share/doc/rsync-3.1.2/support/instant-rsyncd
/usr/share/doc/rsync-3.1.2/support/logfilter
/usr/share/doc/rsync-3.1.2/support/lsh
/usr/share/doc/rsync-3.1.2/support/lsh.sh
/usr/share/doc/rsync-3.1.2/support/mapfrom
/usr/share/doc/rsync-3.1.2/support/mapto
/usr/share/doc/rsync-3.1.2/support/mnt-excl
/usr/share/doc/rsync-3.1.2/support/munge-symlinks
/usr/share/doc/rsync-3.1.2/support/rrsync
/usr/share/doc/rsync-3.1.2/support/rsync-no-vanished
/usr/share/doc/rsync-3.1.2/support/rsync-slash-strip
/usr/share/doc/rsync-3.1.2/support/rsyncstats
/usr/share/doc/rsync-3.1.2/support/savetransfer.c
/usr/share/doc/rsync-3.1.2/tech_report.tex
/usr/share/man/man1/rsync.1.gz
/usr/share/man/man5/rsyncd.conf.5.gz
</code></pre>
<h4 id="rsync-é…ç½®æ–‡ä»¶è¯¦è§£">rsync é…ç½®æ–‡ä»¶è¯¦è§£</h4>
<pre><code class="language-bash"># rsync é…ç½®æ–‡ä»¶è¯¦è§£

# uid = nobody  # æŒ‡å®š rsyncd è¿è¡Œæ—¶çš„ç”¨æˆ·
# gid = nobody  # æŒ‡å®š rsyncd è¿è¡Œæ—¶çš„ç»„
# use chroot = yes  # å¯ç”¨ chroot åŠŸèƒ½ï¼Œæé«˜å®‰å…¨æ€§
# max connections = 4  # é™åˆ¶åŒæ—¶å¯ä»¥è¿æ¥åˆ° rsyncd çš„æœ€å¤§è¿æ¥æ•°
# pid file = /var/run/rsyncd.pid  # æŒ‡å®š rsyncd è¿›ç¨‹çš„ PID æ–‡ä»¶
# exclude = lost+found/  # æ’é™¤ lost+found ç›®å½•
# transfer logging = yes  # å¯ç”¨ä¼ è¾“æ—¥å¿—è®°å½•
# timeout = 900  # è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´
# ignore nonreadable = yes  # å¿½ç•¥æ— æ³•è¯»å–çš„æ–‡ä»¶
# dont compress = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2  # ä¸å‹ç¼©æŸäº›ç±»å‹çš„æ–‡ä»¶

# [ftp]
#       path = /home/ftp  # æŒ‡å®š &quot;ftp&quot; æ¨¡å—çš„åŒæ­¥æ ¹ç›®å½•
#       comment = ftp export area  # æ³¨é‡Šï¼Œè¯´æ˜ &quot;ftp&quot; æ¨¡å—çš„ä½œç”¨
</code></pre>
<h2 id="ä¸‰-æœ¬åœ°åŒæ­¥">ä¸‰ã€æœ¬åœ°åŒæ­¥</h2>
<p>ä»¥ä¸‹æ˜¯å®ç°æ–‡ä»¶ç›‘æ§å’Œè‡ªåŠ¨åŒæ­¥çš„æ–¹æ¡ˆï¼š</p>
<h3 id="1-å®‰è£…-inotify-tools">1. å®‰è£… inotify-tools</h3>
<p><code>inotify-tools</code> æ˜¯ä¸€ä¸ª Linux å®æ—¶æ–‡ä»¶ç³»ç»Ÿç›‘æ§å·¥å…·ï¼Œå¯ä»¥ç›‘æ§ç›®å½•çš„æ–‡ä»¶å˜åŠ¨ã€‚é¦–å…ˆï¼Œä½ éœ€è¦åœ¨ CentOS ä¸Šå®‰è£…å®ƒã€‚</p>
<pre><code class="language-bash">sudo yum install inotify-tools -y
</code></pre>
<h3 id="2-åˆ›å»ºç›‘æ§å’ŒåŒæ­¥è„šæœ¬">2. åˆ›å»ºç›‘æ§å’ŒåŒæ­¥è„šæœ¬</h3>
<p>ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œå½“ <code>/home/zhangsan</code>ã€<code>/home/lisi</code>ã€<code>/home/wangwu</code> ç›®å½•å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘ <code>rsync</code> åŒæ­¥åˆ° <code>/backup</code> ç›®å½•ã€‚</p>
<h4 id="è„šæœ¬ç¤ºä¾‹rsync_inotify_syncsh">è„šæœ¬ç¤ºä¾‹ï¼š<code>rsync_inotify_sync.sh</code></h4>
<pre><code class="language-bash">#!/bin/bash

# å®šä¹‰è¦ç›‘æ§çš„ç›®å½•
SOURCE_DIRS=(&quot;/home/zhangsan&quot; &quot;/home/lisi&quot; &quot;/home/wangwu&quot;)
BACKUP_DIR=&quot;/backup&quot;

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p &quot;$BACKUP_DIR&quot;

# ç›‘æ§ç›®å½•å¹¶å®æ—¶åŒæ­¥
for dir in &quot;${SOURCE_DIRS[@]}&quot;; do
    # è·å–å½“å‰ç›®å½•çš„åç§°
    BASENAME=$(basename &quot;$dir&quot;)

    echo &quot;æ­£åœ¨ç›‘æ§ç›®å½•ï¼š$dir&quot;

    # ä½¿ç”¨ inotifywait ç›‘æ§åˆ›å»ºã€ä¿®æ”¹å’Œåˆ é™¤äº‹ä»¶
    inotifywait -mrq -e modify,create,delete &quot;$dir&quot; | while read path action file; do
        echo &quot;æ£€æµ‹åˆ° $dir ä¸­çš„å˜åŒ–ï¼Œæ­£åœ¨åŒæ­¥åˆ° $BACKUP_DIR/$BASENAME&quot;
        # ä½¿ç”¨ rsync åŒæ­¥å˜åŒ–çš„ç›®å½•
        rsync -av --delete &quot;$dir/&quot; &quot;$BACKUP_DIR/$BASENAME/&quot;
        echo &quot;[$(date)] $dir åŒæ­¥åˆ° $BACKUP_DIR/$BASENAME å®Œæˆ&quot;
    done &amp;
done
</code></pre>
<h4 id="èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™">èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™</h4>
<p>å°†è„šæœ¬ä¿å­˜ä¸º <code>/usr/local/bin/rsync_inotify_sync.sh</code>ï¼Œå¹¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼š</p>
<pre><code class="language-bash">sudo chmod +x /usr/local/bin/rsync_inotify_sync.sh
</code></pre>
<h3 id="3-åå°è¿è¡Œè„šæœ¬">3. åå°è¿è¡Œè„šæœ¬</h3>
<p>ä¸ºäº†è®©ç›‘æ§å’ŒåŒæ­¥è„šæœ¬é•¿æœŸè¿è¡Œï¼Œä½ å¯ä»¥å°†å…¶æ”¾åœ¨åå°æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ <code>nohup</code> æˆ– <code>&amp;</code> è®©è„šæœ¬åœ¨åå°è¿è¡Œï¼š</p>
<pre><code class="language-bash">nohup /usr/local/bin/rsync_inotify_sync.sh &gt; /var/log/rsync_inotify_sync.log 2&gt;&amp;1 &amp;
</code></pre>
<p>è¿™é‡Œä½¿ç”¨ <code>nohup</code> ç¡®ä¿è„šæœ¬åœ¨ä½ é€€å‡ºç»ˆç«¯åä»ç„¶è¿è¡Œã€‚æ—¥å¿—å°†è®°å½•åœ¨ <code>/var/log/rsync_inotify_sync.log</code> ä¸­ã€‚</p>
<h3 id="4-ä½¿ç”¨-systemd-å®ç°è‡ªåŠ¨å¯åŠ¨">4. ä½¿ç”¨ systemd å®ç°è‡ªåŠ¨å¯åŠ¨</h3>
<p>å¦‚æœä½ å¸Œæœ›ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹æ–‡ä»¶ç›‘æ§ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª systemd æœåŠ¡ã€‚</p>
<h4 id="åˆ›å»º-systemd-æœåŠ¡æ–‡ä»¶">åˆ›å»º systemd æœåŠ¡æ–‡ä»¶</h4>
<p>åˆ›å»ºä¸€ä¸ªæœåŠ¡æ–‡ä»¶ <code>/etc/systemd/system/rsync_inotify.service</code>ï¼š</p>
<pre><code class="language-bash">[Unit]
Description=Rsync Inotify File Sync
After=network.target

[Service]
ExecStart=/usr/local/bin/rsync_inotify_sync.sh
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre>
<h4 id="å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡">å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡</h4>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å¯ç”¨å¹¶å¯åŠ¨è¯¥æœåŠ¡ï¼š</p>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable rsync_inotify.service
sudo systemctl start rsync_inotify.service
</code></pre>
<h3 id="5-æ—¥å¿—ç®¡ç†">5. æ—¥å¿—ç®¡ç†</h3>
<p>è„šæœ¬è¿è¡Œæ—¶ä¼šäº§ç”Ÿæ—¥å¿—ã€‚ä½ å¯ä»¥ä½¿ç”¨ <code>logrotate</code> æ¥ç®¡ç†æ—¥å¿—æ–‡ä»¶ï¼Œä»¥é˜²æ—¥å¿—è¿‡å¤§ã€‚åˆ›å»º <code>logrotate</code> é…ç½®æ–‡ä»¶ <code>/etc/logrotate.d/rsync_inotify_sync</code>ï¼š</p>
<pre><code class="language-bash">/var/log/rsync_inotify_sync.log {
    weekly
    rotate 4
    compress
    missingok
    notifempty
    create 640 root root
}
</code></pre>
<h2 id="å››-è¿œç«¯åŒæ­¥-æœåŠ¡å™¨-a-å’ŒæœåŠ¡å™¨-b-é…ç½®æ–‡æ¡£">å››ã€è¿œç«¯åŒæ­¥ æœåŠ¡å™¨ A å’ŒæœåŠ¡å™¨ B é…ç½®æ–‡æ¡£</h2>
<h3 id="æœåŠ¡å™¨ä¿¡æ¯">æœåŠ¡å™¨ä¿¡æ¯</h3>
<table>
<thead>
<tr>
<th>æœåŠ¡å™¨</th>
<th>IP åœ°å€</th>
<th>è§’è‰²</th>
<th>å®‰è£…çš„è½¯ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœåŠ¡å™¨ A</td>
<td>192.168.234.11</td>
<td>æºæœåŠ¡å™¨ï¼šè´Ÿè´£ç›‘æ§ <code>/data/nfs_share</code> ç›®å½•çš„å˜åŒ–ï¼Œå¹¶é€šè¿‡ <code>rsync</code> å°†å˜åŒ–åŒæ­¥åˆ°æœåŠ¡å™¨ B</td>
<td><code>nfs-utils</code>, <code>rsync</code>, <code>sersync</code></td>
</tr>
<tr>
<td>æœåŠ¡å™¨ B</td>
<td>192.168.234.12</td>
<td>ç›®æ ‡æœåŠ¡å™¨ï¼šæ¥æ”¶æ¥è‡ªæœåŠ¡å™¨ A çš„æ–‡ä»¶åŒæ­¥ï¼Œå¹¶å­˜å‚¨åœ¨ <code>/data/backup</code> ç›®å½•ä¸­</td>
<td><code>nfs-utils</code>, <code>rsync</code></td>
</tr>
</tbody>
</table>
<h3 id="æœåŠ¡å™¨-a-19216823411">æœåŠ¡å™¨ A (192.168.234.11)</h3>
<h4 id="è§’è‰²">è§’è‰²</h4>
<ul>
<li><strong>æºæœåŠ¡å™¨</strong>ï¼šè´Ÿè´£ç›‘æ§ <code>/data/nfs_share</code> ç›®å½•çš„å˜åŒ–ï¼Œå¹¶é€šè¿‡ <code>rsync</code> å°†å˜åŒ–åŒæ­¥åˆ°æœåŠ¡å™¨ Bã€‚</li>
</ul>
<h4 id="æµç¨‹">æµç¨‹</h4>
<ol>
<li>
<p><strong>å®‰è£…å¿…è¦çš„è½¯ä»¶</strong></p>
<ul>
<li><code>nfs-utils</code>ï¼šç”¨äºè®¾ç½® NFS å…±äº«ã€‚</li>
<li><code>rsync</code>ï¼šç”¨äºæ–‡ä»¶åŒæ­¥ã€‚</li>
<li><code>sersync</code>ï¼šç”¨äºå®æ—¶ç›‘æ§ç›®å½•å˜åŒ–å¹¶è§¦å‘ <code>rsync</code> åŒæ­¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>è®¾ç½®ç³»ç»Ÿå‚æ•°</strong></p>
<ul>
<li>è®¾ç½® <code>inotify</code> å‚æ•°ä»¥æ”¯æŒæ›´å¤šçš„æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ç›‘å¬ã€‚
<ul>
<li>è®¾ç½® <code>inotify</code> å‚æ•°ï¼š
<ul>
<li><code>fs.inotify.max_user_watches=50000000</code></li>
<li><code>fs.inotify.max_queued_events=327679</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>é…ç½® NFS å…±äº«</strong></p>
<ul>
<li>åˆ›å»ºå…±äº«ç›®å½• <code>/data/nfs_share</code>ã€‚</li>
<li>ç¼–è¾‘ <code>/etc/exports</code> æ–‡ä»¶ï¼Œå…è®¸æœåŠ¡å™¨ B è®¿é—®å…±äº«ç›®å½•ã€‚</li>
<li>å¯åŠ¨ NFS æœåŠ¡å¹¶å¯¼å‡ºå…±äº«ç›®å½•ã€‚
<ul>
<li>åˆ›å»ºå…±äº«ç›®å½• <code>/data/nfs_share</code> å¹¶è®¾ç½®æƒé™ã€‚</li>
<li>ç¼–è¾‘ <code>/etc/exports</code> æ–‡ä»¶ï¼Œæ·»åŠ å…±äº«ç›®å½•é…ç½®ã€‚</li>
<li>å¯åŠ¨ NFS æœåŠ¡å¹¶å¯¼å‡ºå…±äº«ç›®å½•ã€‚</li>
<li>æŸ¥çœ‹å¯¼å‡ºçš„ç›®å½•ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>é…ç½® <code>rsync</code></strong></p>
<ul>
<li>åˆ›å»º <code>rsync</code> å¯†ç æ–‡ä»¶ <code>/etc/rsync.password</code>ã€‚
<ul>
<li>åˆ›å»ºå¯†ç æ–‡ä»¶å¹¶è®¾ç½®æƒé™ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>é…ç½® <code>sersync</code></strong></p>
<ul>
<li>è§£å‹ <code>sersync</code> è½¯ä»¶åŒ…å¹¶å°†å…¶ç§»åŠ¨åˆ° <code>/app/sersync2</code>ã€‚</li>
<li>ç¼–è¾‘ <code>sersync</code> é…ç½®æ–‡ä»¶ <code>/app/sersync2/confxml.xml</code>ï¼Œé…ç½®ç›‘æ§ç›®å½•å’Œè¿œç¨‹æœåŠ¡å™¨ä¿¡æ¯ã€‚</li>
<li>å¯åŠ¨ <code>sersync</code> æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ã€‚
<ul>
<li>ç¼–è¾‘ <code>sersync</code> é…ç½®æ–‡ä»¶ã€‚</li>
<li>å¯åŠ¨ <code>sersync</code> æœåŠ¡ã€‚</li>
<li>è®¾ç½® <code>sersync</code> å¼€æœºè‡ªå¯åŠ¨ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="å®‰è£…çš„è½¯ä»¶">å®‰è£…çš„è½¯ä»¶</h4>
<ul>
<li><code>nfs-utils</code></li>
<li><code>rsync</code></li>
<li><code>sersync</code></li>
</ul>
<h4 id="è„šæœ¬aå¹¶æ‰§è¡Œ">è„šæœ¬Aå¹¶æ‰§è¡Œ</h4>
<pre><code class="language-bash">#!/bin/bash

# è®¾ç½®ç³»ç»Ÿå‚æ•°
echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches
echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events

# æ°¸ä¹…è®¾ç½®ç³»ç»Ÿå‚æ•°
echo 'fs.inotify.max_user_watches=50000000' | sudo tee -a /etc/sysctl.conf
echo 'fs.inotify.max_queued_events=327679' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# è§£å‹ sersync è½¯ä»¶åŒ…å¹¶è®¾ç½®è·¯å¾„
cd /app
# ç¡®ä¿è§£å‹åˆ°æ­£ç¡®çš„ç›®å½•ï¼Œå¹¶å‘½åä¸º sersync2
tar -xzvf sersync2.5.4_64bit_binary_stable_final.tar.gz
# æ£€æŸ¥è§£å‹åçš„æ–‡ä»¶å¤¹
if [ -d &quot;GNU-Linux-x86&quot; ]; then
    mv GNU-Linux-x86 sersync2
else
    echo &quot;sersync è§£å‹å¤±è´¥ï¼Œæ£€æŸ¥è½¯ä»¶åŒ…è·¯å¾„æˆ–å‹ç¼©æ–‡ä»¶ã€‚&quot;
    exit 1
fi

# æ·»åŠ  sersync2 åˆ° PATH
echo 'export PATH=$PATH:/app/sersync2' | sudo tee -a /etc/profile
source /etc/profile

# å®‰è£…å’Œé…ç½® NFS æœåŠ¡
sudo yum install -y nfs-utils

# åˆ›å»ºå…±äº«ç›®å½•
sudo mkdir -p /data/nfs_share
sudo chown -R nobody:nobody /data/nfs_share
sudo chmod -R 777 /data/nfs_share

# ç¼–è¾‘ NFS é…ç½®æ–‡ä»¶
echo '/data/nfs_share 192.168.234.12(rw,sync,no_subtree_check)' | sudo tee -a /etc/exports

# å¯åŠ¨å’Œé…ç½® NFS æœåŠ¡
sudo systemctl start rpcbind
sudo systemctl start nfs-server
sudo systemctl enable rpcbind
sudo systemctl enable nfs-server

# å¯¼å‡ºå…±äº«ç›®å½•
sudo exportfs -a

# æŸ¥çœ‹å¯¼å‡ºçš„ç›®å½•
sudo showmount -e

# å®‰è£… rsync
sudo yum install -y rsync

# ç¼–è¾‘ sersync é…ç½®æ–‡ä»¶
sudo tee /app/sersync2/confxml.xml &lt;&lt;EOF
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;head version=&quot;2.5&quot;&gt;
    &lt;!-- ä¸»æœºé…ç½®ï¼Œç›‘å¬æœ¬åœ°çš„ 8008 ç«¯å£ --&gt;
    &lt;host hostip=&quot;localhost&quot; port=&quot;8008&quot;&gt;&lt;/host&gt;

    &lt;!-- è°ƒè¯•æ¨¡å¼ï¼Œå…³é—­è°ƒè¯• --&gt;
    &lt;debug start=&quot;false&quot;/&gt;

    &lt;!-- æ–‡ä»¶ç³»ç»Ÿé…ç½®ï¼Œå…³é—­å¯¹ XFS æ–‡ä»¶ç³»ç»Ÿçš„æ”¯æŒ --&gt;
    &lt;fileSystem xfs=&quot;false&quot;/&gt;

    &lt;!-- æ–‡ä»¶è¿‡æ»¤è§„åˆ™ï¼Œå½“å‰å…³é—­æ–‡ä»¶è¿‡æ»¤åŠŸèƒ½ --&gt;
    &lt;filter start=&quot;false&quot;&gt;
        &lt;exclude expression=&quot;(.*)\.svn&quot;&gt;&lt;/exclude&gt; &lt;!-- æ’é™¤ .svn ç›®å½• --&gt;
        &lt;exclude expression=&quot;(.*)\.gz&quot;&gt;&lt;/exclude&gt; &lt;!-- æ’é™¤ .gz æ–‡ä»¶ --&gt;
        &lt;exclude expression=&quot;^info/*&quot;&gt;&lt;/exclude&gt; &lt;!-- æ’é™¤ info ç›®å½•ä¸‹çš„æ–‡ä»¶ --&gt;
        &lt;exclude expression=&quot;^static/*&quot;&gt;&lt;/exclude&gt; &lt;!-- æ’é™¤ static ç›®å½•ä¸‹çš„æ–‡ä»¶ --&gt;
    &lt;/filter&gt;

    &lt;!-- inotify äº‹ä»¶ç›‘å¬é…ç½®ï¼Œå¯ç”¨å…³é”®æ–‡ä»¶äº‹ä»¶ç›‘å¬ --&gt;
    &lt;inotify&gt;
        &lt;delete start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬æ–‡ä»¶åˆ é™¤äº‹ä»¶ --&gt;
        &lt;createFolder start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬ç›®å½•åˆ›å»ºäº‹ä»¶ --&gt;
        &lt;createFile start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬æ–‡ä»¶åˆ›å»ºäº‹ä»¶ --&gt;
        &lt;closeWrite start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬æ–‡ä»¶å…³é—­å†™å…¥äº‹ä»¶ --&gt;
        &lt;moveFrom start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬æ–‡ä»¶ç§»åŠ¨å‰äº‹ä»¶ --&gt;
        &lt;moveTo start=&quot;true&quot;/&gt; &lt;!-- ç›‘å¬æ–‡ä»¶ç§»åŠ¨åäº‹ä»¶ --&gt;
        &lt;attrib start=&quot;false&quot;/&gt; &lt;!-- å…³é—­æ–‡ä»¶å±æ€§å˜æ›´äº‹ä»¶çš„ç›‘å¬ --&gt;
        &lt;modify start=&quot;false&quot;/&gt; &lt;!-- å…³é—­æ–‡ä»¶ä¿®æ”¹äº‹ä»¶çš„ç›‘å¬ --&gt;
    &lt;/inotify&gt;

    &lt;!-- sersync é…ç½® --&gt;
    &lt;sersync&gt;
        &lt;!-- æœ¬åœ°è·¯å¾„ç›‘å¬ --&gt;
        &lt;localpath watch=&quot;/data/nfs_share&quot;&gt;
            &lt;!-- è¿œç¨‹æœåŠ¡å™¨é…ç½®ï¼Œå¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨ --&gt;
            &lt;remote ip=&quot;192.168.234.12&quot; name=&quot;backup&quot;/&gt;
        &lt;/localpath&gt;

        &lt;!-- rsync é…ç½® --&gt;
        &lt;rsync&gt;
            &lt;commonParams params=&quot;-avz&quot;/&gt; &lt;!-- rsync å¸¸ç”¨å‚æ•°ï¼Œå‹ç¼©å¹¶è¯¦ç»†è¾“å‡º --&gt;
            &lt;auth start=&quot;true&quot; users=&quot;rsync_user&quot; passwordfile=&quot;/etc/rsync.password&quot;/&gt; &lt;!-- å¯ç”¨è®¤è¯ï¼Œä½¿ç”¨å¯†ç æ–‡ä»¶ --&gt;
            &lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt; &lt;!-- è‡ªå®šä¹‰ç«¯å£ï¼Œæœªå¯ç”¨ --&gt;
            &lt;timeout start=&quot;false&quot; time=&quot;100&quot;/&gt; &lt;!-- è¶…æ—¶æ—¶é—´é…ç½®ï¼Œæœªå¯ç”¨ --&gt;
            &lt;ssh start=&quot;false&quot;/&gt; &lt;!-- ä¸ä½¿ç”¨ SSH è¿›è¡ŒåŒæ­¥ --&gt;
        &lt;/rsync&gt;

        &lt;!-- å¤±è´¥æ—¥å¿—é…ç½® --&gt;
        &lt;failLog path=&quot;/tmp/rsync_fail_log.sh&quot; timeToExecute=&quot;60&quot;/&gt; &lt;!-- å®šæœŸæ‰§è¡Œå¤±è´¥æ—¥å¿—å¤„ç†ï¼Œæ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡ --&gt;

        &lt;!-- å®šæ—¶ä»»åŠ¡é…ç½®ï¼Œå½“å‰æœªå¯ç”¨ --&gt;
        &lt;crontab start=&quot;false&quot; schedule=&quot;600&quot;&gt;
            &lt;crontabfilter start=&quot;false&quot;&gt;
                &lt;exclude expression=&quot;*.php&quot;/&gt; &lt;!-- æ’é™¤ .php æ–‡ä»¶ --&gt;
                &lt;exclude expression=&quot;info/*&quot;/&gt; &lt;!-- æ’é™¤ info ç›®å½•ä¸‹çš„æ–‡ä»¶ --&gt;
            &lt;/crontabfilter&gt;
        &lt;/crontab&gt;

        &lt;!-- æ’ä»¶é…ç½®ï¼Œå½“å‰æœªå¯ç”¨ --&gt;
        &lt;plugin start=&quot;false&quot; name=&quot;command&quot;/&gt;
    &lt;/sersync&gt;
&lt;/head&gt;

EOF

# åˆ›å»ºå¯†ç æ–‡ä»¶
echo &quot;123456&quot; | sudo tee /etc/rsync.password
sudo chmod 600 /etc/rsync.password

# å¯åŠ¨ sersync æœåŠ¡
if [ -f &quot;/app/sersync2/sersync2&quot; ]; then
    /app/sersync2/sersync2 -r -d -o /app/sersync2/confxml.xml
else
    echo &quot;sersync2 ç¨‹åºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è½¯ä»¶åŒ…è§£å‹è·¯å¾„ã€‚&quot;
    exit 1
fi

# è®¾ç½® sersync å¼€æœºè‡ªå¯åŠ¨
sudo tee -a /etc/rc.local &lt;&lt;EOF
#!/bin/bash
/app/sersync2/sersync2 -r -d -o /app/sersync2/confxml.xml
EOF
sudo chmod +x /etc/rc.local

</code></pre>
<h3 id="æœåŠ¡å™¨-b-19216823412">æœåŠ¡å™¨ B (192.168.234.12)</h3>
<h4 id="è§’è‰²-2">è§’è‰²</h4>
<ul>
<li><strong>ç›®æ ‡æœåŠ¡å™¨</strong>ï¼šæ¥æ”¶æ¥è‡ªæœåŠ¡å™¨ A çš„æ–‡ä»¶åŒæ­¥ï¼Œå¹¶å­˜å‚¨åœ¨ <code>/data/backup</code> ç›®å½•ä¸­ã€‚</li>
</ul>
<h4 id="æµç¨‹-2">æµç¨‹</h4>
<ol>
<li>
<p><strong>å®‰è£…å¿…è¦çš„è½¯ä»¶</strong></p>
<ul>
<li><code>nfs-utils</code>ï¼šç”¨äºæŒ‚è½½ NFS å…±äº«ã€‚</li>
<li><code>rsync</code>ï¼šç”¨äºæ¥æ”¶æ–‡ä»¶åŒæ­¥ã€‚</li>
</ul>
</li>
<li>
<p><strong>æŒ‚è½½ NFS å…±äº«</strong></p>
<ul>
<li>åˆ›å»ºæŒ‚è½½ç‚¹ <code>/data/backup</code>ã€‚</li>
<li>ç¼–è¾‘ <code>/etc/fstab</code> æ–‡ä»¶ï¼Œè‡ªåŠ¨æŒ‚è½½ NFS å…±äº«ã€‚</li>
<li>æŒ‚è½½ NFS å…±äº«ã€‚</li>
</ul>
</li>
<li>
<p><strong>é…ç½® <code>rsync</code></strong></p>
<ul>
<li>åˆ›å»º <code>rsync</code> å¯†ç æ–‡ä»¶ <code>/etc/rsync.password</code>ã€‚
<ul>
<li>åˆ›å»ºå¯†ç æ–‡ä»¶å¹¶è®¾ç½®æƒé™ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>æµ‹è¯•åŒæ­¥</strong></p>
<ul>
<li>æ‰‹åŠ¨è¿è¡Œ <code>rsync</code> å‘½ä»¤æµ‹è¯•åŒæ­¥ã€‚</li>
<li>ç¡®è®¤åŒæ­¥æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡ <code>sersync</code> è‡ªåŠ¨åŒæ­¥ã€‚</li>
</ul>
</li>
</ol>
<h4 id="å®‰è£…çš„è½¯ä»¶-2">å®‰è£…çš„è½¯ä»¶</h4>
<ul>
<li><code>nfs-utils</code></li>
<li><code>rsync</code></li>
</ul>
<h4 id="è„šæœ¬bå¹¶æ‰§è¡Œ">è„šæœ¬Bå¹¶æ‰§è¡Œ</h4>
<pre><code class="language-bash">#!/bin/bash

# è®¾ç½®ç³»ç»Ÿå‚æ•°
echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches
echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events

# æ°¸ä¹…è®¾ç½®ç³»ç»Ÿå‚æ•°
echo 'fs.inotify.max_user_watches=50000000' | sudo tee -a /etc/sysctl.conf
echo 'fs.inotify.max_queued_events=327679' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# å®‰è£…å’Œé…ç½® NFS å®¢æˆ·ç«¯
sudo yum install -y nfs-utils

# åˆ›å»ºæŒ‚è½½ç‚¹
sudo mkdir -p /mnt/nfs_share

# æŒ‚è½½ NFS å…±äº«ç›®å½•
sudo mount 192.168.234.11:/data/nfs_share /mnt/nfs_share

# éªŒè¯æŒ‚è½½æ˜¯å¦æˆåŠŸ
df -h

# å®‰è£… rsync
sudo yum install -y rsync

# ç¼–è¾‘ rsync é…ç½®æ–‡ä»¶
sudo tee /etc/rsyncd.conf &lt;&lt;EOF
uid = root
gid = root
use chroot = no
max connections = 4
timeout = 600
pid file = /var/run/rsyncd.pid
lock file = /var/run/rsync.lock
log file = /var/log/rsync.log

[backup]
path = /data/backup
comment = backup data
read only = no
auth users = rsync_user
secrets file = /etc/rsyncd.secrets
hosts allow = 192.168.234.11
EOF

# åˆ›å»ºå¯†ç æ–‡ä»¶
echo &quot;rsync:123456&quot; | sudo tee /etc/rsyncd.secrets
sudo chmod 600 /etc/rsyncd.secrets

# åˆ›å»ºå¤‡ä»½ç›®å½•
sudo mkdir -p /data/backup
sudo chown -R nobody:nobody /data/backup
sudo chmod -R 777 /data/backup

# åˆ›å»º rsync çš„ systemd æœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/rsync.service &lt;&lt;EOF
[Unit]
Description=rsync daemon
After=network.target

[Service]
Type=forking
ExecStart=/usr/bin/rsync --daemon --config=/etc/rsyncd.conf
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# é‡æ–°åŠ è½½ systemd é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨å¹¶å¯ç”¨ rsync æœåŠ¡
sudo systemctl start rsync
sudo systemctl enable rsync

# è®¾ç½® rsync å¼€æœºè‡ªå¯åŠ¨
sudo tee -a /etc/rc.local &lt;&lt;EOF
#!/bin/bash
systemctl start rsync
EOF
sudo chmod +x /etc/rc.local

</code></pre>
<h4 id="åœ¨æœåŠ¡å™¨-b-ä¸ŠéªŒè¯åŒæ­¥ç»“æœ">åœ¨æœåŠ¡å™¨ B ä¸ŠéªŒè¯åŒæ­¥ç»“æœ</h4>
<pre><code class="language-bash"># æ£€æŸ¥ `/data/backup` ç›®å½•ä¸­çš„æ–‡ä»¶æ˜¯å¦ä¸æœåŠ¡å™¨ A çš„ `/data/nfs_share` ç›®å½•ä¸€è‡´
ls -l /data/backup
</code></pre>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ol>
<li><strong>å®‰è£… rsync å’Œ inotify-tools</strong>ï¼šç”¨ <code>yum</code> å®‰è£…ã€‚</li>
<li><strong>ç¼–å†™è„šæœ¬</strong>ï¼šç”¨ <code>inotifywait</code> ç›‘æ§æ–‡ä»¶å˜åŒ–ï¼Œå¹¶ç”¨ <code>rsync</code> å®æ—¶åŒæ­¥ã€‚</li>
<li><strong>åå°è¿è¡Œ</strong>ï¼šä½¿ç”¨ <code>nohup</code> æˆ– <code>systemd</code> å°†è„šæœ¬ä½œä¸ºåå°æœåŠ¡è¿è¡Œã€‚</li>
<li><strong>æ—¥å¿—ç®¡ç†</strong>ï¼šé€šè¿‡ <code>logrotate</code> ç®¡ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…æ—¥å¿—è¿‡å¤§ã€‚</li>
<li><strong>è¿œç«¯åŒæ­¥</strong>ï¼šé…ç½®æœåŠ¡å™¨ A å’ŒæœåŠ¡å™¨ Bï¼Œå®ç°æ–‡ä»¶çš„å®æ—¶åŒæ­¥ã€‚</li>
<li><strong>æµ‹è¯•åŒæ­¥</strong>ï¼šæ‰‹åŠ¨è§¦å‘åŒæ­¥å¹¶éªŒè¯ç»“æœï¼Œç¡®ä¿é…ç½®æ­£ç¡®ã€‚</li>
</ol>
<p>è¿™æ ·ï¼Œä½ å°±å¯ä»¥å®ç°åŸºäºæ–‡ä»¶å˜åŒ–çš„å®æ—¶åŒæ­¥äº†ã€‚æ¯å½“ <code>zhangsan</code>ã€<code>lisi</code> æˆ– <code>wangwu</code> ç›®å½•æœ‰æ–‡ä»¶æ›´æ”¹æ—¶ï¼Œä¼šè‡ªåŠ¨åŒæ­¥åˆ°å¤‡ä»½ç›®å½•ã€‚åŒæ—¶ï¼ŒæœåŠ¡å™¨ A å’ŒæœåŠ¡å™¨ B ä¹‹é—´çš„æ–‡ä»¶ä¹Ÿå¯ä»¥å®ç°è¿œç«¯åŒæ­¥ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[è‡ªåŠ¨åŒ–è¿ç»´ Ansible]]></title>
        <id>https://orochw.github.io/post/zi-dong-hua-yun-wei-ansible/</id>
        <link href="https://orochw.github.io/post/zi-dong-hua-yun-wei-ansible/">
        </link>
        <updated>2023-03-01T17:14:28.000Z</updated>
        <content type="html"><![CDATA[<h1 id="è¿ç»´è‡ªåŠ¨åŒ–ä¹‹ansible">è¿ç»´è‡ªåŠ¨åŒ–ä¹‹ANSIBLE</h1>
<h3 id="æœ¬ç« å†…å®¹">æœ¬ç« å†…å®¹</h3>
<ul>
<li>è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨</li>
<li>Ansibleå‘½ä»¤ä½¿ç”¨</li>
<li>Ansibleå¸¸ç”¨æ¨¡å—è¯¦è§£</li>
<li>YAMLè¯­æ³•ç®€ä»‹</li>
<li>Ansible playbookåŸºç¡€</li>
<li>Playbookå˜é‡ã€tagsã€handlersä½¿ç”¨</li>
<li>Playbookæ¨¡æ¿templates</li>
<li>Playbookæ¡ä»¶åˆ¤æ–­ when</li>
<li>Playbookå­—å…¸ with_items</li>
<li>Ansible Roles</li>
</ul>
<h3 id="è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨">è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨</h3>
<figure data-type="image" tabindex="1"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011711.png" alt="" loading="lazy"></figure>
<h3 id="ä¼ä¸šå®é™…åº”ç”¨åœºæ™¯åˆ†æ">ä¼ä¸šå®é™…åº”ç”¨åœºæ™¯åˆ†æ</h3>
<pre><code>Devå¼€å‘ç¯å¢ƒ
    ä½¿ç”¨è€…ï¼šç¨‹åºå‘˜
    åŠŸèƒ½ï¼šç¨‹åºå‘˜å¼€å‘è½¯ä»¶ï¼Œæµ‹è¯•BUGçš„ç¯å¢ƒ
    ç®¡ç†è€…ï¼šç¨‹åºå‘˜

æµ‹è¯•ç¯å¢ƒ    
    ä½¿ç”¨è€…ï¼šQAæµ‹è¯•å·¥ç¨‹å¸ˆ
    åŠŸèƒ½ï¼šæµ‹è¯•ç»è¿‡Devç¯å¢ƒæµ‹è¯•é€šè¿‡çš„è½¯ä»¶çš„åŠŸèƒ½
    ç®¡ç†è€…ï¼šè¿ç»´

è¯´æ˜ï¼šæµ‹è¯•ç¯å¢ƒå¾€å¾€æœ‰å¤šå¥—,æµ‹è¯•ç¯å¢ƒæ»¡è¶³æµ‹è¯•åŠŸèƒ½å³å¯ï¼Œä¸å®œè¿‡å¤š
1ã€æµ‹è¯•äººå‘˜å¸Œæœ›æµ‹è¯•ç¯å¢ƒæœ‰å¤šå¥—,å…¬å¸çš„äº§å“å¤šäº§å“çº¿å¹¶å‘ï¼Œå³å¤šä¸ªç‰ˆæœ¬ï¼Œæ„å‘³ç€å¤šä¸ªç‰ˆæœ¬åŒæ­¥æµ‹è¯•
2ã€é€šå¸¸æµ‹è¯•ç¯å¢ƒæœ‰å¤šå°‘å¥—å’Œäº§å“çº¿æ•°é‡ä¿æŒä¸€æ ·

å‘å¸ƒç¯å¢ƒï¼šä»£ç å‘å¸ƒæœºï¼Œæœ‰äº›å…¬å¸ä¸ºå ¡å’æœºï¼ˆå®‰å…¨å±éšœï¼‰
    ä½¿ç”¨è€…ï¼šè¿ç»´
    åŠŸèƒ½ï¼šå‘å¸ƒä»£ç è‡³ç”Ÿäº§ç¯å¢ƒ
    ç®¡ç†è€…ï¼šè¿ç»´ï¼ˆæœ‰ç»éªŒï¼‰
    å‘å¸ƒæœºï¼šå¾€å¾€éœ€è¦æœ‰2å°ï¼ˆä¸»å¤‡ï¼‰

ç”Ÿäº§ç¯å¢ƒ
    ä½¿ç”¨è€…ï¼šè¿ç»´ï¼Œå°‘æ•°æƒ…å†µå¼€æ”¾æƒé™ç»™æ ¸å¿ƒå¼€å‘äººå‘˜ï¼Œæå°‘æ•°å…¬å¸å°†æƒé™å®Œå…¨
    å¼€æ”¾ç»™å¼€å‘äººå‘˜å¹¶å…¶ç»´æŠ¤
    åŠŸèƒ½ï¼šå¯¹ç”¨æˆ·æä¾›å…¬å¸äº§å“çš„æœåŠ¡

ç®¡ç†è€…ï¼šåªèƒ½æ˜¯è¿ç»´
    ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨æ•°é‡ï¼šä¸€èˆ¬æ¯”è¾ƒå¤šï¼Œä¸”åº”ç”¨éå¸¸é‡è¦ã€‚å¾€å¾€éœ€è¦è‡ªåŠ¨å·¥å…·ååŠ©éƒ¨ç½²é…ç½®åº”ç”¨

ç°åº¦ç¯å¢ƒï¼ˆç”Ÿäº§ç¯å¢ƒçš„ä¸€éƒ¨åˆ†ï¼‰
    ä½¿ç”¨è€…ï¼šè¿ç»´
    åŠŸèƒ½ï¼šåœ¨å…¨é‡å‘å¸ƒä»£ç å‰å°†ä»£ç çš„åŠŸèƒ½é¢å‘å°‘é‡ç²¾å‡†ç”¨æˆ·å‘å¸ƒçš„ç¯å¢ƒ,å¯åŸº
    äºä¸»æœºæˆ–ç”¨æˆ·æ‰§è¡Œç°åº¦å‘å¸ƒ
    æ¡ˆä¾‹ï¼šå…±100å°ç”Ÿäº§æœåŠ¡å™¨ï¼Œå…ˆå‘å¸ƒå…¶ä¸­çš„10å°æœåŠ¡å™¨ï¼Œè¿™10å°æœåŠ¡å™¨å°±æ˜¯ç°åº¦æœåŠ¡å™¨
    ç®¡ç†è€…ï¼šè¿ç»´
    ç°åº¦ç¯å¢ƒï¼šå¾€å¾€è¯¥ç‰ˆæœ¬åŠŸèƒ½å˜æ›´è¾ƒå¤§ï¼Œä¸ºä¿é™©èµ·è§ç‰¹æ„å…ˆè®©ä¸€éƒ¨åˆ†ç”¨æˆ·ä¼˜åŒ–ä½“éªŒè¯¥åŠŸèƒ½ï¼Œ
              å¾…è¿™éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ²¡æœ‰é‡å¤§é—®é¢˜çš„æ—¶å€™ï¼Œå†å…¨é‡å‘å¸ƒè‡³æ‰€æœ‰æœåŠ¡å™¨
</code></pre>
<h3 id="ç¨‹åºå‘å¸ƒ">ç¨‹åºå‘å¸ƒ</h3>
<pre><code>ç¨‹åºå‘å¸ƒè¦æ±‚ï¼š
    ä¸èƒ½å¯¼è‡´ç³»ç»Ÿæ•…éšœæˆ–é€ æˆç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
    ä¸èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
é¢„å‘å¸ƒéªŒè¯ï¼š
    æ–°ç‰ˆæœ¬çš„ä»£ç å…ˆå‘å¸ƒåˆ°æœåŠ¡å™¨ï¼ˆè·Ÿçº¿ä¸Šç¯å¢ƒé…ç½®å®Œå…¨ç›¸åŒï¼Œåªæ˜¯æœªæ¥å…¥åˆ°è°ƒåº¦å™¨ï¼‰
ç°åº¦å‘å¸ƒï¼š
    åŸºäºä¸»æœºï¼Œç”¨æˆ·ï¼Œä¸šåŠ¡
å‘å¸ƒè·¯å¾„ï¼š
    /webapp/tuangou
    /webapp/tuangou-1.1
    /webapp/tuangou-1.2
å‘å¸ƒè¿‡ç¨‹ï¼šåœ¨è°ƒåº¦å™¨ä¸Šä¸‹çº¿ä¸€æ‰¹ä¸»æœº(æ ‡è®°ä¸ºmaintananceçŠ¶æ€) --&gt; å…³é—­æœåŠ¡ --&gt;
          éƒ¨ç½²æ–°ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åº --&gt; å¯åŠ¨æœåŠ¡ --&gt; åœ¨è°ƒåº¦å™¨ä¸Šå¯ç”¨è¿™ä¸€æ‰¹æœåŠ¡å™¨
è‡ªåŠ¨åŒ–ç°åº¦å‘å¸ƒï¼šè„šæœ¬ã€å‘å¸ƒå¹³å°
</code></pre>
<h3 id="è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨-2">è¿ç»´è‡ªåŠ¨åŒ–å‘å±•å†ç¨‹åŠæŠ€æœ¯åº”ç”¨</h3>
<figure data-type="image" tabindex="2"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011813.png" alt="" loading="lazy"></figure>
<h3 id="è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯">è‡ªåŠ¨åŒ–è¿ç»´åº”ç”¨åœºæ™¯</h3>
<pre><code>æ–‡ä»¶ä¼ è¾“
åº”ç”¨éƒ¨ç½²
é…ç½®ç®¡ç†
ä»»åŠ¡æµç¼–æ’
</code></pre>
<h3 id="å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·">å¸¸ç”¨è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·</h3>
<pre><code>Ansibleï¼špythonï¼ŒAgentlessï¼Œä¸­å°å‹åº”ç”¨ç¯å¢ƒ
Saltstackï¼špythonï¼Œä¸€èˆ¬éœ€éƒ¨ç½²agentï¼Œæ‰§è¡Œæ•ˆç‡æ›´é«˜
Puppetï¼šruby, åŠŸèƒ½å¼ºå¤§ï¼Œé…ç½®å¤æ‚ï¼Œé‡å‹,é€‚åˆå¤§å‹ç¯å¢ƒ
Fabricï¼špythonï¼Œagentless
Chefï¼šrubyï¼Œå›½å†…åº”ç”¨å°‘
Cfengine
func
</code></pre>
<h3 id="ä¼ä¸šçº§è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·åº”ç”¨å®æˆ˜ansible">ä¼ä¸šçº§è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·åº”ç”¨å®æˆ˜ansible</h3>
<pre><code>å…¬å¸è®¡åˆ’åœ¨å¹´åº•åšä¸€æ¬¡å¤§å‹å¸‚åœºä¿ƒé”€æ´»åŠ¨ï¼Œå…¨é¢å†²åˆºä¸‹äº¤æ˜“é¢ï¼Œä¸ºæ˜å¹´çš„ä¸Šå¸‚åšå‡†å¤‡ã€‚
å…¬å¸è¦æ±‚å„ä¸šåŠ¡ç»„å¯¹å¹´åº•å¤§ä¿ƒåšå‡†å¤‡ï¼Œè¿ç»´éƒ¨è¦æ±‚æ‰€æœ‰ä¸šåŠ¡å®¹é‡è¿›è¡Œä¸‰å€çš„æ‰©å®¹ï¼Œ
å¹¶æ­å»ºå‡ºå¤šå¥—ç¯å¢ƒå¯ä»¥å…±å¼€å‘å’Œæµ‹è¯•äººå‘˜åšæµ‹è¯•ï¼Œè¿ç»´è€å¤§ä¸ºäº†åœ¨å¹´åº•æœ‰æ‰€è¡¨ç°ï¼Œ
è¦æ±‚è¿ç»´éƒ¨é—¨åŒå­¦å°½å¿«å®ç°ï¼Œå½“ä½ æ¥åˆ°è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œæœ‰æ²¡æœ‰æ›´å¿«çš„è§£å†³æ–¹æ¡ˆï¼Ÿ
</code></pre>
<h3 id="ansibleå‘å±•å²">Ansibleå‘å±•å²</h3>
<pre><code>Ansible
Michael DeHaanï¼ˆ Cobbler ä¸ Func ä½œè€…ï¼‰
åç§°æ¥è‡ªã€Šå®‰å¾·çš„æ¸¸æˆã€‹ä¸­è·¨è¶Šæ—¶ç©ºçš„å³æ—¶é€šä¿¡å·¥å…·
2012-03-09ï¼Œå‘å¸ƒ0.0.1ç‰ˆï¼Œ2015-10-17ï¼ŒRed Hatå®£å¸ƒæ”¶è´­
å®˜ç½‘ï¼šhttps://www.ansible.com/
å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.ansible.com/
åŒç±»è‡ªåŠ¨åŒ–å·¥å…·GitHubå…³æ³¨ç¨‹åº¦ï¼ˆ2016-07-10ï¼‰
</code></pre>
<figure data-type="image" tabindex="3"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011838.png" alt="" loading="lazy"></figure>
<h3 id="ç‰¹æ€§">ç‰¹æ€§</h3>
<pre><code>1&gt; æ¨¡å—åŒ–ï¼šè°ƒç”¨ç‰¹å®šçš„æ¨¡å—ï¼Œå®Œæˆç‰¹å®šä»»åŠ¡
2&gt; Paramikoï¼ˆpythonå¯¹sshçš„å®ç°ï¼‰ï¼ŒPyYAMLï¼ŒJinja2ï¼ˆæ¨¡æ¿è¯­è¨€ï¼‰ä¸‰ä¸ªå…³é”®æ¨¡å—
3&gt; æ”¯æŒè‡ªå®šä¹‰æ¨¡å—
4&gt; åŸºäºPythonè¯­è¨€å®ç°
5&gt; éƒ¨ç½²ç®€å•ï¼ŒåŸºäºpythonå’ŒSSH(é»˜è®¤å·²å®‰è£…)ï¼Œagentless
6&gt; å®‰å…¨ï¼ŒåŸºäºOpenSSH
7&gt; æ”¯æŒplaybookç¼–æ’ä»»åŠ¡
8&gt; å¹‚ç­‰æ€§ï¼šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ1éå’Œæ‰§è¡Œnéæ•ˆæœä¸€æ ·ï¼Œä¸å› é‡å¤æ‰§è¡Œå¸¦æ¥æ„å¤–æƒ…å†µ
9&gt; æ— éœ€ä»£ç†ä¸ä¾èµ–PKIï¼ˆæ— éœ€sslï¼‰
10&gt; å¯ä½¿ç”¨ä»»ä½•ç¼–ç¨‹è¯­è¨€å†™æ¨¡å—
11&gt; YAMLæ ¼å¼ï¼Œç¼–æ’ä»»åŠ¡ï¼Œæ”¯æŒä¸°å¯Œçš„æ•°æ®ç»“æ„
12&gt; è¾ƒå¼ºå¤§çš„å¤šå±‚è§£å†³æ–¹æ¡ˆ
</code></pre>
<h3 id="ansibleæ¶æ„">Ansibleæ¶æ„</h3>
<figure data-type="image" tabindex="4"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011849.png" alt="" loading="lazy"></figure>
<pre><code>ansibleçš„ä½œç”¨ä»¥åŠå·¥ä½œç»“æ„
1ã€ansibleç®€ä»‹ï¼š
ansibleæ˜¯æ–°å‡ºç°çš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ŒåŸºäºPythonå¼€å‘ï¼Œ
é›†åˆäº†ä¼—å¤šè¿ç»´å·¥å…·ï¼ˆpuppetã€cfengineã€chefã€funcã€fabricï¼‰çš„ä¼˜ç‚¹ï¼Œ
å®ç°äº†æ‰¹é‡ç³»ç»Ÿé…ç½®ã€æ‰¹é‡ç¨‹åºéƒ¨ç½²ã€æ‰¹é‡è¿è¡Œå‘½ä»¤ç­‰åŠŸèƒ½ã€‚
ansibleæ˜¯åŸºäºæ¨¡å—å·¥ä½œçš„ï¼Œæœ¬èº«æ²¡æœ‰æ‰¹é‡éƒ¨ç½²çš„èƒ½åŠ›ã€‚
çœŸæ­£å…·æœ‰æ‰¹é‡éƒ¨ç½²çš„æ˜¯ansibleæ‰€è¿è¡Œçš„æ¨¡å—ï¼Œansibleåªæ˜¯æä¾›ä¸€ç§æ¡†æ¶ã€‚
ä¸»è¦åŒ…æ‹¬ï¼š
    (1)ã€è¿æ¥æ’ä»¶connection pluginsï¼šè´Ÿè´£å’Œè¢«ç›‘æ§ç«¯å®ç°é€šä¿¡ï¼›
    (2)ã€host inventoryï¼šæŒ‡å®šæ“ä½œçš„ä¸»æœºï¼Œæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶é‡Œé¢å®šä¹‰ç›‘æ§çš„ä¸»æœºï¼›
    (3)ã€å„ç§æ¨¡å—æ ¸å¿ƒæ¨¡å—ã€commandæ¨¡å—ã€è‡ªå®šä¹‰æ¨¡å—ï¼›
    (4)ã€å€ŸåŠ©äºæ’ä»¶å®Œæˆè®°å½•æ—¥å¿—é‚®ä»¶ç­‰åŠŸèƒ½ï¼›
    (5)ã€playbookï¼šå‰§æœ¬æ‰§è¡Œå¤šä¸ªä»»åŠ¡æ—¶ï¼Œéå¿…éœ€å¯ä»¥è®©èŠ‚ç‚¹ä¸€æ¬¡æ€§è¿è¡Œå¤šä¸ªä»»åŠ¡ã€‚

2ã€ansibleçš„æ¶æ„ï¼šè¿æ¥å…¶ä»–ä¸»æœºé»˜è®¤ä½¿ç”¨sshåè®®	
</code></pre>
<h3 id="ansibleå·¥ä½œåŸç†">Ansibleå·¥ä½œåŸç†</h3>
<figure data-type="image" tabindex="5"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011905.png" alt="" loading="lazy"></figure>
<h3 id="ansibleä¸»è¦ç»„æˆéƒ¨åˆ†">Ansibleä¸»è¦ç»„æˆéƒ¨åˆ†</h3>
<pre><code>ANSIBLE PLAYBOOKSï¼šä»»åŠ¡å‰§æœ¬ï¼ˆä»»åŠ¡é›†ï¼‰ï¼Œç¼–æ’å®šä¹‰Ansibleä»»åŠ¡é›†çš„é…ç½®æ–‡ä»¶ï¼Œ
                   ç”±Ansibleé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œé€šå¸¸æ˜¯JSONæ ¼å¼çš„YMLæ–‡ä»¶
INVENTORYï¼šAnsibleç®¡ç†ä¸»æœºçš„æ¸…å•  /etc/anaible/hosts
MODULESï¼š  Ansibleæ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤šæ•°ä¸ºå†…ç½®æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿå¯è‡ªå®šä¹‰
PLUGINSï¼š  æ¨¡å—åŠŸèƒ½çš„è¡¥å……ï¼Œå¦‚è¿æ¥ç±»å‹æ’ä»¶ã€å¾ªç¯æ’ä»¶ã€å˜é‡æ’ä»¶ã€è¿‡æ»¤æ’ä»¶ç­‰ï¼Œè¯¥åŠŸèƒ½ä¸å¸¸ç”¨
APIï¼š      ä¾›ç¬¬ä¸‰æ–¹ç¨‹åºè°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ 
ANSIBLEï¼š  ç»„åˆINVENTORYã€APIã€MODULESã€PLUGINSçš„ç»¿æ¡†ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ansibleå‘½ä»¤å·¥å…·ï¼Œå…¶ä¸ºæ ¸å¿ƒæ‰§è¡Œå·¥å…·
</code></pre>
<pre><code>Ansibleå‘½ä»¤æ‰§è¡Œæ¥æºï¼š
    1&gt; USERï¼Œæ™®é€šç”¨æˆ·ï¼Œå³SYSTEM ADMINISTRATOR
    2&gt; CMDBï¼ˆé…ç½®ç®¡ç†æ•°æ®åº“ï¼‰ API è°ƒç”¨
    3&gt; PUBLIC/PRIVATE CLOUD APIè°ƒç”¨  (å…¬æœ‰ç§æœ‰äº‘çš„APIæ¥å£è°ƒç”¨)
    4&gt; USER-&gt; Ansible Playbook -&gt; Ansibile

åˆ©ç”¨ansibleå®ç°ç®¡ç†çš„æ–¹å¼ï¼š
    1&gt; Ad-Hoc å³ansibleå•æ¡å‘½ä»¤ï¼Œä¸»è¦ç”¨äºä¸´æ—¶å‘½ä»¤ä½¿ç”¨åœºæ™¯
    2&gt; Ansible-playbook ä¸»è¦ç”¨äºé•¿æœŸè§„åˆ’å¥½çš„ï¼Œå¤§å‹é¡¹ç›®çš„åœºæ™¯ï¼Œéœ€è¦æœ‰å‰æœŸçš„è§„åˆ’è¿‡ç¨‹
</code></pre>
<pre><code>Ansible-playbookï¼ˆå‰§æœ¬ï¼‰æ‰§è¡Œè¿‡ç¨‹
    å°†å·²æœ‰ç¼–æ’å¥½çš„ä»»åŠ¡é›†å†™å…¥Ansible-Playbook
    é€šè¿‡ansible-playbookå‘½ä»¤åˆ†æ‹†ä»»åŠ¡é›†è‡³é€æ¡ansibleå‘½ä»¤ï¼ŒæŒ‰é¢„å®šè§„åˆ™é€æ¡æ‰§è¡Œ

Ansibleä¸»è¦æ“ä½œå¯¹è±¡
   HOSTSä¸»æœº
   NETWORKINGç½‘ç»œè®¾å¤‡

æ³¨æ„äº‹é¡¹:
   æ‰§è¡Œansibleçš„ä¸»æœºä¸€èˆ¬ç§°ä¸ºä¸»æ§ç«¯ï¼Œä¸­æ§ï¼Œmasteræˆ–å ¡å’æœº
   ä¸»æ§ç«¯Pythonç‰ˆæœ¬éœ€è¦2.6æˆ–ä»¥ä¸Š
   è¢«æ§ç«¯Pythonç‰ˆæœ¬å°äº2.4éœ€è¦å®‰è£…python-simplejson
   è¢«æ§ç«¯å¦‚å¼€å¯SELinuxéœ€è¦å®‰è£…libselinux-python
   windowsä¸èƒ½åšä¸ºä¸»æ§ç«¯
   ansibleä¸æ˜¯æœåŠ¡,ä¸ä¼šä¸€ç›´å¯åŠ¨,åªæ˜¯éœ€è¦çš„æ—¶å€™å¯åŠ¨
</code></pre>
<h3 id="å®‰è£…">å®‰è£…</h3>
<pre><code>rpmåŒ…å®‰è£…: EPELæº
    yum install ansible

ç¼–è¯‘å®‰è£…:
    yum -y install python-jinja2 PyYAML python-paramiko python-babel
    python-crypto
    tar xf ansible-1.5.4.tar.gz
    cd ansible-1.5.4
    python setup.py build
    python setup.py install
    mkdir /etc/ansible
    cp -r examples/* /etc/ansible


Gitæ–¹å¼:
    git clone git://github.com/ansible/ansible.git --recursive
    cd ./ansible
    source ./hacking/env-setup

pipå®‰è£…ï¼š pipæ˜¯å®‰è£…PythonåŒ…çš„ç®¡ç†å™¨ï¼Œç±»ä¼¼yum
    yum install python-pip python-devel
    yum install gcc glibc-devel zibl-devel rpm-bulid openssl-devel
    pip install --upgrade pip
    pip install ansible --upgrade

ç¡®è®¤å®‰è£…ï¼š
    ansible --version
</code></pre>
<h3 id="ç›¸å…³æ–‡ä»¶">ç›¸å…³æ–‡ä»¶</h3>
<pre><code>é…ç½®æ–‡ä»¶
    /etc/ansible/ansible.cfg  ä¸»é…ç½®æ–‡ä»¶,é…ç½®ansibleå·¥ä½œç‰¹æ€§(ä¸€èˆ¬æ— éœ€ä¿®æ”¹)
    /etc/ansible/hosts        ä¸»æœºæ¸…å•(å°†è¢«ç®¡ç†çš„ä¸»æœºæ”¾åˆ°æ­¤æ–‡ä»¶)
    /etc/ansible/roles/       å­˜æ”¾è§’è‰²çš„ç›®å½•

ç¨‹åº
    /usr/bin/ansible          ä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·
    /usr/bin/ansible-doc      æŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·
    /usr/bin/ansible-galaxy   ä¸‹è½½/ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å°
    /usr/bin/ansible-playbook å®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·
    /usr/bin/ansible-pull     è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·
    /usr/bin/ansible-vault    æ–‡ä»¶åŠ å¯†å·¥å…·
    /usr/bin/ansible-console  åŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·
</code></pre>
<h3 id="ä¸»æœºæ¸…å•inventory">ä¸»æœºæ¸…å•inventory</h3>
<pre><code>Inventory ä¸»æœºæ¸…å•
1&gt; ansibleçš„ä¸»è¦åŠŸç”¨åœ¨äºæ‰¹é‡ä¸»æœºæ“ä½œï¼Œä¸ºäº†ä¾¿æ·åœ°ä½¿ç”¨å…¶ä¸­çš„éƒ¨åˆ†ä¸»æœºï¼Œå¯ä»¥åœ¨inventory fileä¸­å°†å…¶åˆ†ç»„å‘½å 
2&gt; é»˜è®¤çš„inventory fileä¸º/etc/ansible/hosts
3&gt; inventory fileå¯ä»¥æœ‰å¤šä¸ªï¼Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡Dynamic Inventoryæ¥åŠ¨æ€ç”Ÿæˆ

/etc/ansible/hostsæ–‡ä»¶æ ¼å¼
inventoryæ–‡ä»¶éµå¾ªINIæ–‡ä»¶é£æ ¼ï¼Œä¸­æ‹¬å·ä¸­çš„å­—ç¬¦ä¸ºç»„åã€‚
å¯ä»¥å°†åŒä¸€ä¸ªä¸»æœºåŒæ—¶å½’å¹¶åˆ°å¤šä¸ªä¸åŒçš„ç»„ä¸­ï¼›
æ­¤å¤–ï¼Œå½“å¦‚è‹¥ç›®æ ‡ä¸»æœºä½¿ç”¨äº†éé»˜è®¤çš„SSHç«¯å£ï¼Œè¿˜å¯ä»¥åœ¨ä¸»æœºåç§°ä¹‹åä½¿ç”¨å†’å·åŠ ç«¯å£å·æ¥æ ‡æ˜
    ntp.ansible.com   ä¸åˆ†ç»„,ç›´æ¥åŠ 
    
    [webservers]     webserversç»„
    www1.ansible.com:2222  å¯ä»¥æŒ‡å®šç«¯å£
    www2.ansible.com
    
    [dbservers]
    db1.ansible.com
    db2.ansible.com
    db3.ansible.com

å¦‚æœä¸»æœºåç§°éµå¾ªç›¸ä¼¼çš„å‘½åæ¨¡å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åˆ—è¡¨çš„æ–¹å¼æ ‡è¯†å„ä¸»æœº
ç¤ºä¾‹ï¼š
    [websrvs]
    www[1:100].example.com   ip: 1-100
    
    [dbsrvs]
    db-[a:f].example.com     dba-dbff
</code></pre>
<h3 id="ansible-é…ç½®æ–‡ä»¶">ansible é…ç½®æ–‡ä»¶</h3>
<pre><code>Ansible é…ç½®æ–‡ä»¶/etc/ansible/ansible.cfg ï¼ˆä¸€èˆ¬ä¿æŒé»˜è®¤ï¼‰

vim /etc/ansible/ansible.cfg

[defaults]
#inventory     = /etc/ansible/hosts      # ä¸»æœºåˆ—è¡¨é…ç½®æ–‡ä»¶
#library       = /usr/share/my_modules/  # åº“æ–‡ä»¶å­˜æ”¾ç›®å½•
#remote_tmp    = $HOME/.ansible/tmp      # ä¸´æ—¶pyå‘½ä»¤æ–‡ä»¶å­˜æ”¾åœ¨è¿œç¨‹ä¸»æœºç›®å½•
#local_tmp     = $HOME/.ansible/tmp      # æœ¬æœºçš„ä¸´æ—¶å‘½ä»¤æ‰§è¡Œç›®å½•  
#forks         = 5                       # é»˜è®¤å¹¶å‘æ•°,åŒæ—¶å¯ä»¥æ‰§è¡Œ5æ¬¡
#sudo_user     = root                    # é»˜è®¤sudo ç”¨æˆ·
#ask_sudo_pass = True                    # æ¯æ¬¡æ‰§è¡Œansibleå‘½ä»¤æ˜¯å¦è¯¢é—®sshå¯†ç 
#ask_pass      = True                    # æ¯æ¬¡æ‰§è¡Œansibleå‘½ä»¤æ˜¯å¦è¯¢é—®sshå£ä»¤
#remote_port   = 22                      # è¿œç¨‹ä¸»æœºçš„ç«¯å£å·(é»˜è®¤22)

å»ºè®®ä¼˜åŒ–é¡¹ï¼š 
host_key_checking = False               # æ£€æŸ¥å¯¹åº”æœåŠ¡å™¨çš„host_keyï¼Œå»ºè®®å–æ¶ˆæ³¨é‡Š
log_path=/var/log/ansible.log           # æ—¥å¿—æ–‡ä»¶,å»ºè®®å–æ¶ˆæ³¨é‡Š
module_name   = command                 # é»˜è®¤æ¨¡å—
</code></pre>
<h3 id="ansibleç³»åˆ—å‘½ä»¤">ansibleç³»åˆ—å‘½ä»¤</h3>
<pre><code>Ansibleç³»åˆ—å‘½ä»¤
    ansible ansible-doc ansible-playbook ansible-vault ansible-console
    ansible-galaxy ansible-pull

ansible-doc: æ˜¾ç¤ºæ¨¡å—å¸®åŠ©
    ansible-doc [options] [module...]
        -a            æ˜¾ç¤ºæ‰€æœ‰æ¨¡å—çš„æ–‡æ¡£
        -l, --list    åˆ—å‡ºå¯ç”¨æ¨¡å—
        -s, --snippet æ˜¾ç¤ºæŒ‡å®šæ¨¡å—çš„playbookç‰‡æ®µ(ç®€åŒ–ç‰ˆ,ä¾¿äºæŸ¥æ‰¾è¯­æ³•)

ç¤ºä¾‹ï¼š
    ansible-doc -l      åˆ—å‡ºæ‰€æœ‰æ¨¡å—
    ansible-doc ping    æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•
    ansible-doc -s ping æŸ¥çœ‹æŒ‡å®šæ¨¡å—å¸®åŠ©ç”¨æ³•
</code></pre>
<h3 id="ansible">ansible</h3>
<pre><code>ansibleé€šè¿‡sshå®ç°é…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€ä»»åŠ¡æ‰§è¡Œç­‰åŠŸèƒ½ï¼Œ
å»ºè®®é…ç½®ansibleç«¯èƒ½åŸºäºå¯†é’¥è®¤è¯çš„æ–¹å¼è”ç³»å„è¢«ç®¡ç†èŠ‚ç‚¹

ansible &lt;host-pattern&gt; [-m module_name] [-a args]
ansible +è¢«ç®¡ç†çš„ä¸»æœº(ALL) +æ¨¡å—  +å‚æ•°
    --version              æ˜¾ç¤ºç‰ˆæœ¬
    -m module              æŒ‡å®šæ¨¡å—ï¼Œé»˜è®¤ä¸ºcommand
    -v                     è¯¦ç»†è¿‡ç¨‹ â€“vv -vvvæ›´è¯¦ç»†
    --list-hosts           æ˜¾ç¤ºä¸»æœºåˆ—è¡¨ï¼Œå¯ç®€å†™ --list
    -k, --ask-pass         æç¤ºè¾“å…¥sshè¿æ¥å¯†ç ,é»˜è®¤KeyéªŒè¯
    -C, --check            æ£€æŸ¥ï¼Œå¹¶ä¸æ‰§è¡Œ
    -T, --timeout=TIMEOUT  æ‰§è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´,é»˜è®¤10s
    -u, --user=REMOTE_USER æ‰§è¡Œè¿œç¨‹æ‰§è¡Œçš„ç”¨æˆ·
    -b, --become           ä»£æ›¿æ—§ç‰ˆçš„sudoåˆ‡æ¢
        --become-user=USERNAME æŒ‡å®šsudoçš„runasç”¨æˆ·,é»˜è®¤ä¸ºroot
    -K, --ask-become-pass  æç¤ºè¾“å…¥sudoæ—¶çš„å£ä»¤
</code></pre>
<pre><code>ansible all --list  åˆ—å‡ºæ‰€æœ‰ä¸»æœº
pingæ¨¡å—: æ¢æµ‹ç½‘ç»œä¸­è¢«ç®¡ç†ä¸»æœºæ˜¯å¦èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨  èµ°sshåè®®
          å¦‚æœå¯¹æ–¹ä¸»æœºç½‘ç»œæ­£å¸¸,è¿”å›pong
ansible-doc -s ping   æŸ¥çœ‹pingæ¨¡å—çš„è¯­æ³• 

æ£€æµ‹æ‰€æœ‰ä¸»æœºçš„ç½‘ç»œçŠ¶æ€
1&gt;  é»˜è®¤æƒ…å†µä¸‹è¿æ¥è¢«ç®¡ç†çš„ä¸»æœºæ˜¯sshåŸºäºkeyéªŒè¯,å¦‚æœæ²¡æœ‰é…ç½®key,æƒé™å°†ä¼šè¢«æ‹’ç»
    å› æ­¤éœ€è¦æŒ‡å®šä»¥è°çš„èº«ä»½è¿æ¥,è¾“å…¥ç”¨æˆ·å¯†ç ,å¿…é¡»ä¿è¯è¢«ç®¡ç†ä¸»æœºç”¨æˆ·å¯†ç ä¸€è‡´
    ansible all -m ping -k

2&gt; æˆ–è€…å®ç°åŸºäºkeyéªŒè¯ å°†å…¬é’¥ssh-copy-idåˆ°è¢«ç®¡ç†çš„ä¸»æœºä¸Š , å®ç°å…å¯†ç™»å½•
   ansible all -m ping
</code></pre>
<h3 id="ansibleçš„host-pattern">ansibleçš„Host-pattern</h3>
<pre><code>ansibleçš„Host-pattern
åŒ¹é…ä¸»æœºçš„åˆ—è¡¨
    All ï¼šè¡¨ç¤ºæ‰€æœ‰Inventoryä¸­çš„æ‰€æœ‰ä¸»æœº
        ansible all â€“m ping
    * :é€šé…ç¬¦
        ansible &quot;*&quot; -m ping  (*è¡¨ç¤ºæ‰€æœ‰ä¸»æœº)
        ansible 192.168.1.* -m ping
        ansible &quot;*srvs&quot; -m ping
    æˆ–å…³ç³» &quot;:&quot;
        ansible &quot;websrvs:appsrvs&quot; -m ping
        ansible â€œ192.168.1.10:192.168.1.20â€ -m ping
    é€»è¾‘ä¸ &quot;:&amp;&quot;
        ansible &quot;websrvs:&amp;dbsrvs&quot; â€“m ping
        åœ¨websrvsç»„å¹¶ä¸”åœ¨dbsrvsç»„ä¸­çš„ä¸»æœº
    é€»è¾‘é &quot;:!&quot;
        ansible 'websrvs:!dbsrvs' â€“m ping
        åœ¨websrvsç»„ï¼Œä½†ä¸åœ¨dbsrvsç»„ä¸­çš„ä¸»æœº
        æ³¨æ„ï¼šæ­¤å¤„ä¸ºå•å¼•å·
    ç»¼åˆé€»è¾‘
        ansible 'websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs' â€“m ping
    æ­£åˆ™è¡¨è¾¾å¼
        ansible &quot;websrvs:&amp;dbsrvs&quot; â€“m ping
        ansible &quot;~(web|db).*\.ansible\.com&quot; â€“m ping
</code></pre>
<h3 id="ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹">ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</h3>
<pre><code>ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹
    1. åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶ é»˜è®¤/etc/ansible/ansible.cfg
    2. åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚command
    3. é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶ï¼Œ
       å¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨çš„å¯¹åº”æ‰§è¡Œç”¨æˆ·$HOME/.ansible/tmp/ansible-tmp-æ•°å­—/XXX.PYæ–‡ä»¶
    4. ç»™æ–‡ä»¶+xæ‰§è¡Œ
    5. æ‰§è¡Œå¹¶è¿”å›ç»“æœ
    6. åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œsleep 0é€€å‡º

æ‰§è¡ŒçŠ¶æ€ï¼š
    ç»¿è‰²ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”ä¸éœ€è¦åšæ”¹å˜çš„æ“ä½œ
    é»„è‰²ï¼šæ‰§è¡ŒæˆåŠŸå¹¶ä¸”å¯¹ç›®æ ‡ä¸»æœºåšå˜æ›´
    çº¢è‰²ï¼šæ‰§è¡Œå¤±è´¥
</code></pre>
<h3 id="ansibleä½¿ç”¨ç¤ºä¾‹">ansibleä½¿ç”¨ç¤ºä¾‹</h3>
<pre><code>ç¤ºä¾‹
    ä»¥wangç”¨æˆ·æ‰§è¡Œpingå­˜æ´»æ£€æµ‹
        ansible all -m ping -u wang -k
    ä»¥wang sudoè‡³rootæ‰§è¡Œpingå­˜æ´»æ£€æµ‹
        ansible all -m ping -u wang -k -b
    ä»¥wang sudoè‡³ansibleç”¨æˆ·æ‰§è¡Œpingå­˜æ´»æ£€æµ‹
        ansible all -m ping -u wang -k -b --become-user=ansible
    ä»¥wang sudoè‡³rootç”¨æˆ·æ‰§è¡Œls
        ansible all -m command -u wang -a 'ls /root' -b --become-user=root -k -K

ansible pingæ¨¡å—æµ‹è¯•è¿æ¥
    ansible 192.168.38.126,192.168.38.127 -m ping -k 
</code></pre>
<h3 id="ansibleå¸¸ç”¨æ¨¡å—">ansibleå¸¸ç”¨æ¨¡å—</h3>
<pre><code>æ¨¡å—æ–‡æ¡£ï¼šhttps://docs.ansible.com/ansible/latest/modules/modules_by_category.html

Commandï¼šåœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œé»˜è®¤æ¨¡å—ï¼Œå¯å¿½ç•¥-mé€‰é¡¹
    &gt; ansible srvs -m command -a 'service vsftpd start'
    &gt; ansible srvs -m command -a 'echo adong |passwd --stdin 123456'
æ­¤å‘½ä»¤ä¸æ”¯æŒ $VARNAME &lt; &gt; | ; &amp; ç­‰,ç”¨shellæ¨¡å—å®ç°

    chdir:   è¿›å…¥åˆ°è¢«ç®¡ç†ä¸»æœºç›®å½•
    creates: å¦‚æœæœ‰ä¸€ä¸ªç›®å½•æ˜¯å­˜åœ¨çš„,æ­¥éª¤å°†ä¸ä¼šè¿è¡ŒCommandå‘½ä»¤
    ansible websrvs -a 'chdir=/data/ ls'

Shellï¼šå’Œcommandç›¸ä¼¼ï¼Œç”¨shellæ‰§è¡Œå‘½ä»¤
    &gt; ansible all -m shell  -a 'getenforce'  æŸ¥çœ‹SELINUXçŠ¶æ€
    &gt;  ansible all -m shell  -a &quot;sed -i 's/SELINUX=.*/SELINUX=disabled' /etc/selinux/config&quot;
    &gt; ansible srv -m shell -a 'echo ansible |passwd â€“stdin wang'
      
    è°ƒç”¨bashæ‰§è¡Œå‘½ä»¤ ç±»ä¼¼ cat /tmp/stanley.md | awk -F'|' '{print $1,$2}' &amp;&gt; /tmp/example.txt     
    è¿™äº›å¤æ‚å‘½ä»¤ï¼Œå³ä½¿ä½¿ç”¨shellä¹Ÿå¯èƒ½ä¼šå¤±è´¥ï¼Œ
    è§£å†³åŠæ³•ï¼šå†™åˆ°è„šæœ¬æ—¶ï¼Œcopyåˆ°è¿œç¨‹æ‰§è¡Œï¼Œå†æŠŠéœ€è¦çš„ç»“æœæ‹‰å›æ‰§è¡Œå‘½ä»¤çš„æœºå™¨

    ä¿®æ”¹é…ç½®æ–‡ä»¶,ä½¿shellä½œä¸ºé»˜è®¤æ¨¡å—    
        vim /etc/ansible/ansible.cfg
        module_name = shell

Scriptï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡ŒansibleæœåŠ¡å™¨ä¸Šçš„è„šæœ¬
    &gt; -a &quot;/PATH/TO/SCRIPT_FILE&quot;
    &gt; ansible websrvs -m script -a /data/test.sh

Copyï¼šä»ä¸»æ§ç«¯å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº
      src : æºæ–‡ä»¶  æŒ‡å®šæ‹·è´æ–‡ä»¶çš„æœ¬åœ°è·¯å¾„  (å¦‚æœæœ‰/ åˆ™æ‹·è´ç›®å½•å†…å®¹,æ¯”æ‹·è´ç›®å½•æœ¬èº«)
      dest: æŒ‡å®šç›®æ ‡è·¯å¾„
      mode: è®¾ç½®æƒé™
      backup: å¤‡ä»½æºæ–‡ä»¶
      content: ä»£æ›¿src  æŒ‡å®šæœ¬æœºæ–‡ä»¶å†…å®¹,ç”Ÿæˆç›®æ ‡ä¸»æœºæ–‡ä»¶
      
      &gt; ansible websrvs -m copy -a &quot;src=/root/test1.sh dest=/tmp/test2.showner=wang mode=600 backup=yes&quot;
        å¦‚æœç›®æ ‡å­˜åœ¨ï¼Œé»˜è®¤è¦†ç›–ï¼Œæ­¤å¤„æŒ‡å®šå…ˆå¤‡ä»½
      &gt; ansible websrvs -m copy -a &quot;content='test content\nxxx' dest=/tmp/test.txt&quot;
        æŒ‡å®šå†…å®¹ï¼Œç›´æ¥ç”Ÿæˆç›®æ ‡æ–‡ä»¶

Fetchï¼šä»è¿œç¨‹ä¸»æœºæå–æ–‡ä»¶è‡³ä¸»æ§ç«¯ï¼Œcopyç›¸åï¼Œç›®å‰ä¸æ”¯æŒç›®å½•,å¯ä»¥å…ˆæ‰“åŒ…,å†æå–æ–‡ä»¶
     &gt; ansible websrvs -m fetch -a 'src=/root/test.sh dest=/data/scripts'
     ä¼šç”Ÿæˆæ¯ä¸ªè¢«ç®¡ç†ä¸»æœºä¸åŒç¼–å·çš„ç›®å½•,ä¸ä¼šå‘ç”Ÿæ–‡ä»¶åå†²çª
     
     &gt; ansible all -m shell -a 'tar jxvf test.tar.gz /root/test.sh'
     &gt; ansible all -m fetch -a 'src=/root/test.tar.gz dest=/data/'

Fileï¼šè®¾ç½®æ–‡ä»¶å±æ€§
    path: è¦ç®¡ç†çš„æ–‡ä»¶è·¯å¾„ (å¼ºåˆ¶æ·»åŠ )
    recurse: é€’å½’,æ–‡ä»¶å¤¹è¦ç”¨é€’å½’
    src:  åˆ›å»ºç¡¬é“¾æ¥,è½¯é“¾æ¥æ—¶,æŒ‡å®šæºç›®æ ‡,é…åˆ'state=link' 'state=hard' è®¾ç½®è½¯é“¾æ¥,ç¡¬é“¾æ¥
    state: çŠ¶æ€
          absent ç¼ºå¸­,åˆ é™¤
          
    &gt; ansible websrvs -m file -a 'path=/app/test.txt state=touch'       åˆ›å»ºæ–‡ä»¶
    &gt; ansible websrvs -m file -a &quot;path=/data/testdir state=directory&quot;   åˆ›å»ºç›®å½•    
    &gt; ansible websrvs -m file -a &quot;path=/root/test.sh owner=wang mode=755&quot;  è®¾ç½®æƒé™755
    &gt; ansible websrvs -m file -a 'src=/data/testfile dest=/data/testfile-link state=link' åˆ›å»ºè½¯é“¾æ¥
    
    
unarchiveï¼šè§£åŒ…è§£å‹ç¼©ï¼Œæœ‰ä¸¤ç§ç”¨æ³•ï¼š
    1ã€å°†ansibleä¸»æœºä¸Šçš„å‹ç¼©åŒ…ä¼ åˆ°è¿œç¨‹ä¸»æœºåè§£å‹ç¼©è‡³ç‰¹å®šç›®å½•ï¼Œè®¾ç½®copy=yes.
    2ã€å°†è¿œç¨‹ä¸»æœºä¸Šçš„æŸä¸ªå‹ç¼©åŒ…è§£å‹ç¼©åˆ°æŒ‡å®šè·¯å¾„ä¸‹ï¼Œè®¾ç½®copy=no

    å¸¸è§å‚æ•°ï¼š
        copyï¼šé»˜è®¤ä¸ºyesï¼Œå½“copy=yesï¼Œæ‹·è´çš„æ–‡ä»¶æ˜¯ä»ansibleä¸»æœºå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šï¼Œ
              å¦‚æœè®¾ç½®ä¸ºcopy=noï¼Œä¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šå¯»æ‰¾srcæºæ–‡ä»¶
        srcï¼š æºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ansibleä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œ
              å¦‚æœæ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½®copy=no
        destï¼šè¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„
        modeï¼šè®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™
    
    ç¤ºä¾‹ï¼š
        ansible websrvs -m unarchive -a 'src=foo.tgz dest=/var/lib/foo'  
          #é»˜è®¤copyä¸ºyes ,å°†æœ¬æœºç›®å½•æ–‡ä»¶è§£å‹åˆ°ç›®æ ‡ä¸»æœºå¯¹åº”ç›®å½•ä¸‹
        ansible websrvs -m unarchive -a 'src=/tmp/foo.zip dest=/data copy=no mode=0777'
          # è§£å‹è¢«ç®¡ç†ä¸»æœºçš„foo.zipåˆ°dataç›®å½•ä¸‹, å¹¶è®¾ç½®æƒé™777
        ansible websrvs -m unarchive -a 'src=https://example.com/example.zip dest=/data copy=no'

Archiveï¼šæ‰“åŒ…å‹ç¼©
    &gt; ansible all -m archive -a 'path=/etc/sysconfig dest=/data/sysconfig.tar.bz2 format=bz2 owner=wang mode=0777'
    å°†è¿œç¨‹ä¸»æœºç›®å½•æ‰“åŒ… 
        path:   æŒ‡å®šè·¯å¾„
        dest:   æŒ‡å®šç›®æ ‡æ–‡ä»¶
        format: æŒ‡å®šæ‰“åŒ…æ ¼å¼
        owner:  æŒ‡å®šæ‰€å±è€…
        mode:   è®¾ç½®æƒé™

Hostnameï¼šç®¡ç†ä¸»æœºå
    ansible appsrvs -m hostname -a &quot;name=app.adong.com&quot;  æ›´æ”¹ä¸€ç»„çš„ä¸»æœºå
    ansible 192.168.38.103 -m hostname -a &quot;name=app2.adong.com&quot; æ›´æ”¹å•ä¸ªä¸»æœºå

Cronï¼šè®¡åˆ’ä»»åŠ¡
    æ”¯æŒæ—¶é—´ï¼šminute,hour,day,month,weekday
    &gt; ansible websrvs -m cron -a &quot;minute=*/5 job='/usr/sbin/ntpdate 172.16.0.1 &amp;&gt;/dev/null' name=Synctime&quot; 
    åˆ›å»ºä»»åŠ¡
    &gt; ansible websrvs -m cron -a 'state=absent name=Synctime' 
    åˆ é™¤ä»»åŠ¡
    &gt; ansible websrvs -m cron -a 'minute=*/10 job='/usr/sbin/ntpdate 172.30.0.100&quot; name=synctime disabled=yes'
    æ³¨é‡Šä»»åŠ¡,ä¸åœ¨ç”Ÿæ•ˆ

Yumï¼šç®¡ç†åŒ…
    ansible websrvs -m yum -a 'list=httpd'  æŸ¥çœ‹ç¨‹åºåˆ—è¡¨
    
    ansible websrvs -m yum -a 'name=httpd state=present' å®‰è£…
    ansible websrvs -m yum -a 'name=httpd state=absent'  åˆ é™¤
    å¯ä»¥åŒæ—¶å®‰è£…å¤šä¸ªç¨‹åºåŒ…
    
Serviceï¼šç®¡ç†æœåŠ¡
    ansible srv -m service -a 'name=httpd state=stopped'  åœæ­¢æœåŠ¡
    ansible srv -m service -a 'name=httpd state=started enabled=yes' å¯åŠ¨æœåŠ¡,å¹¶è®¾ä¸ºå¼€æœºè‡ªå¯
    ansible srv -m service -a 'name=httpd state=reloaded'  é‡æ–°åŠ è½½
    ansible srv -m service -a 'name=httpd state=restarted' é‡å¯æœåŠ¡

Userï¼šç®¡ç†ç”¨æˆ·
    home   æŒ‡å®šå®¶ç›®å½•è·¯å¾„
    system æŒ‡å®šç³»ç»Ÿè´¦å·
    group  æŒ‡å®šç»„
    remove æ¸…é™¤è´¦æˆ·
    shell  æŒ‡å®šshellç±»å‹
    
    ansible websrvs -m user -a 'name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root'
    ansible websrvs -m user -a 'name=sysuser1 system=yes home=/app/sysuser1'
    ansible websrvs -m user -a 'name=user1 state=absent remove=yes'  æ¸…ç©ºç”¨æˆ·æ‰€æœ‰æ•°æ®
    ansible websrvs -m user -a 'name=app uid=88 system=yes home=/app groups=root shell=/sbin/nologin password=&quot;$1$zfVojmPy$ZILcvxnXljvTI2PhP2Iqv1&quot;'  åˆ›å»ºç”¨æˆ·
    ansible websrvs -m user -a 'name=app state=absent'  ä¸ä¼šåˆ é™¤å®¶ç›®å½•
    
    å®‰è£…mkpasswd 
    yum insatll expect 
    mkpasswd ç”Ÿæˆå£ä»¤
    openssl passwd -1  ç”ŸæˆåŠ å¯†å£ä»¤
    

åˆ é™¤ç”¨æˆ·åŠå®¶ç›®å½•ç­‰æ•°æ®
    Groupï¼šç®¡ç†ç»„
        ansible srv -m group -a &quot;name=testgroup system=yes&quot;   åˆ›å»ºç»„
        ansible srv -m group -a &quot;name=testgroup state=absent&quot; åˆ é™¤ç»„
</code></pre>
<h3 id="ansibleç³»åˆ—å‘½ä»¤-2">ansibleç³»åˆ—å‘½ä»¤</h3>
<pre><code>å¯ä»¥é€šè¿‡ç½‘ä¸Šå†™å¥½çš„
ansible-galaxy
    &gt; è¿æ¥ https://galaxy.ansible.com 
      ä¸‹è½½ç›¸åº”çš„roles(è§’è‰²)
    
    &gt; åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„galaxy
        ansible-galaxy list
    
    &gt; å®‰è£…galaxy
        ansible-galaxy install geerlingguy.redis
    
    &gt; åˆ é™¤galaxy
        ansible-galaxy remove geerlingguy.redis
        
ansible-pull
    æ¨é€å‘½ä»¤è‡³è¿œç¨‹ï¼Œæ•ˆç‡æ— é™æå‡ï¼Œå¯¹è¿ç»´è¦æ±‚è¾ƒé«˜
    

ansible-playbook  å¯ä»¥å¼•ç”¨æŒ‰ç…§æ ‡å‡†çš„ymlè¯­è¨€å†™çš„è„šæœ¬
    æ‰§è¡Œplaybook
    ç¤ºä¾‹ï¼šansible-playbook hello.yml
        cat hello.yml
        #hello world yml file
        - hosts: websrvs
          remote_user: root
          tasks:
            - name: hello world
              command: /usr/bin/wall hello world

ansible-vault  (äº†è§£)
åŠŸèƒ½ï¼šç®¡ç†åŠ å¯†è§£å¯†ymlæ–‡ä»¶
    ansible-vault [create|decrypt|edit|encrypt|rekey|view]
        ansible-vault encrypt hello.yml åŠ å¯†
        ansible-vault decrypt hello.yml è§£å¯†
        ansible-vault view hello.yml    æŸ¥çœ‹
        ansible-vault edit hello.yml    ç¼–è¾‘åŠ å¯†æ–‡ä»¶
        ansible-vault rekey hello.yml   ä¿®æ”¹å£ä»¤
        ansible-vault create new.yml    åˆ›å»ºæ–°æ–‡ä»¶


Ansible-consoleï¼š2.0+æ–°å¢ï¼Œå¯äº¤äº’æ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒtab  (äº†è§£)

    root@test (2)[f:10] $
    æ‰§è¡Œç”¨æˆ·@å½“å‰æ“ä½œçš„ä¸»æœºç»„ (å½“å‰ç»„çš„ä¸»æœºæ•°é‡)[f:å¹¶å‘æ•°]$

    è®¾ç½®å¹¶å‘æ•°ï¼š         forks n   ä¾‹å¦‚ï¼š forks 10
    åˆ‡æ¢ç»„ï¼š             cd ä¸»æœºç»„ ä¾‹å¦‚ï¼š cd web
    åˆ—å‡ºå½“å‰ç»„ä¸»æœºåˆ—è¡¨ï¼š list
    åˆ—å‡ºæ‰€æœ‰çš„å†…ç½®å‘½ä»¤ï¼š ?æˆ–help
    ç¤ºä¾‹ï¼š
        root@all (2)[f:5]$ list
        root@all (2)[f:5]$ cd appsrvs
        root@appsrvs (2)[f:5]$ list
        root@appsrvs (2)[f:5]$ yum name=httpd state=present
        root@appsrvs (2)[f:5]$ service name=httpd state=started
</code></pre>
<h3 id="playbook">playbook</h3>
<pre><code>&gt; playbookæ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ª&quot;play&quot;ç»„æˆçš„åˆ—è¡¨
&gt; playçš„ä¸»è¦åŠŸèƒ½åœ¨äºå°†é¢„å®šä¹‰çš„ä¸€ç»„ä¸»æœºï¼Œè£…æ‰®æˆäº‹å…ˆé€šè¿‡ansibleä¸­çš„taskå®šä¹‰å¥½çš„è§’è‰²ã€‚
  Taskå®é™…æ˜¯è°ƒç”¨ansibleçš„ä¸€ä¸ªmoduleï¼Œå°†å¤šä¸ªplayç»„ç»‡åœ¨ä¸€ä¸ªplaybookä¸­ï¼Œ
  å³å¯ä»¥è®©å®ƒä»¬è”åˆèµ·æ¥ï¼ŒæŒ‰äº‹å…ˆç¼–æ’çš„æœºåˆ¶æ‰§è¡Œé¢„å®šä¹‰çš„åŠ¨ä½œ
&gt; Playbooké‡‡ç”¨YAMLè¯­è¨€ç¼–å†™
</code></pre>
<h3 id="playbookå›¾è§£">playbookå›¾è§£</h3>
<figure data-type="image" tabindex="6"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011931.png" alt="" loading="lazy"></figure>
<pre><code>ç”¨æˆ·é€šè¿‡ansibleå‘½ä»¤ç›´æ¥è°ƒç”¨ymlè¯­è¨€å†™å¥½çš„playbook,playbookç”±å¤šæ¡playç»„æˆ
æ¯æ¡playéƒ½æœ‰ä¸€ä¸ªä»»åŠ¡(task)ç›¸å¯¹åº”çš„æ“ä½œ,ç„¶åè°ƒç”¨æ¨¡å—modulesï¼Œåº”ç”¨åœ¨ä¸»æœºæ¸…å•ä¸Š,é€šè¿‡sshè¿œç¨‹è¿æ¥
ä»è€Œæ§åˆ¶è¿œç¨‹ä¸»æœºæˆ–è€…ç½‘ç»œè®¾å¤‡
</code></pre>
<h3 id="yamlä»‹ç»">YAMLä»‹ç»</h3>
<pre><code>YAMLæ˜¯ä¸€ä¸ªå¯è¯»æ€§é«˜çš„ç”¨æ¥è¡¨è¾¾èµ„æ–™åºåˆ—çš„æ ¼å¼ã€‚
    YAMLå‚è€ƒäº†å…¶ä»–å¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬ï¼šXMLã€Cè¯­è¨€ã€Pythonã€Perlä»¥åŠç”µå­é‚®ä»¶æ ¼å¼RFC2822ç­‰ã€‚
    Clark Evansåœ¨2001å¹´åœ¨é¦–æ¬¡å‘è¡¨äº†è¿™ç§è¯­è¨€ï¼Œå¦å¤–Ingy dÃ¶t Netä¸Oren Ben-Kikiä¹Ÿæ˜¯è¿™è¯­è¨€çš„å…±åŒè®¾è®¡è€…

YAML Ain't Markup Languageï¼Œå³YAMLä¸æ˜¯XMLã€‚
ä¸è¿‡ï¼Œåœ¨å¼€å‘çš„è¿™ç§è¯­è¨€æ—¶ï¼ŒYAMLçš„æ„æ€å…¶å®æ˜¯ï¼š&quot;Yet Another Markup Language&quot;ï¼ˆä»æ˜¯ä¸€ç§æ ‡è®°è¯­è¨€ï¼‰

ç‰¹æ€§
    YAMLçš„å¯è¯»æ€§å¥½
    YAMLå’Œè„šæœ¬è¯­è¨€çš„äº¤äº’æ€§å¥½
    YAMLä½¿ç”¨å®ç°è¯­è¨€çš„æ•°æ®ç±»å‹
    YAMLæœ‰ä¸€ä¸ªä¸€è‡´çš„ä¿¡æ¯æ¨¡å‹
    YAMLæ˜“äºå®ç°
    YAMLå¯ä»¥åŸºäºæµæ¥å¤„ç†
    YAMLè¡¨è¾¾èƒ½åŠ›å¼ºï¼Œæ‰©å±•æ€§å¥½

æ›´å¤šçš„å†…å®¹åŠè§„èŒƒå‚è§ï¼šhttp://www.yaml.org
</code></pre>
<h3 id="yamlè¯­æ³•ç®€ä»‹">YAMLè¯­æ³•ç®€ä»‹</h3>
<pre><code>&gt; åœ¨å•ä¸€æ¡£æ¡ˆä¸­ï¼Œå¯ç”¨è¿ç»­ä¸‰ä¸ªè¿å­—å·(â€”â€”)åŒºåˆ†å¤šä¸ªæ¡£æ¡ˆã€‚
  å¦å¤–ï¼Œè¿˜æœ‰é€‰æ‹©æ€§çš„è¿ç»­ä¸‰ä¸ªç‚¹å·( ... )ç”¨æ¥è¡¨ç¤ºæ¡£æ¡ˆç»“å°¾
&gt; æ¬¡è¡Œå¼€å§‹æ­£å¸¸å†™Playbookçš„å†…å®¹ï¼Œä¸€èˆ¬å»ºè®®å†™æ˜è¯¥Playbookçš„åŠŸèƒ½
&gt; ä½¿ç”¨#å·æ³¨é‡Šä»£ç 
&gt; ç¼©è¿›å¿…é¡»æ˜¯ç»Ÿä¸€çš„ï¼Œä¸èƒ½ç©ºæ ¼å’Œtabæ··ç”¨
&gt; ç¼©è¿›çš„çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„ç¼©è¿›ä»£è¡¨åŒæ ·çš„çº§åˆ«ï¼Œç¨‹åºåˆ¤åˆ«é…ç½®çš„çº§åˆ«æ˜¯é€šè¿‡ç¼©è¿›ç»“åˆæ¢è¡Œæ¥å®ç°çš„
&gt; YAMLæ–‡ä»¶å†…å®¹æ˜¯åŒºåˆ«å¤§å°å†™çš„ï¼Œk/vçš„å€¼å‡éœ€å¤§å°å†™æ•æ„Ÿ
&gt; å¤šä¸ªk/vå¯åŒè¡Œå†™ä¹Ÿå¯æ¢è¡Œå†™ï¼ŒåŒè¡Œä½¿ç”¨:åˆ†éš”
&gt; vå¯æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯æ˜¯å¦ä¸€ä¸ªåˆ—è¡¨[]
&gt; ä¸€ä¸ªå®Œæ•´çš„ä»£ç å—åŠŸèƒ½éœ€æœ€å°‘å…ƒç´ éœ€åŒ…æ‹¬ name å’Œ task
&gt; ä¸€ä¸ªnameåªèƒ½åŒ…æ‹¬ä¸€ä¸ªtask
&gt; YAMLæ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸ºymlæˆ–yaml
</code></pre>
<h3 id="yamlè¯­æ³•ç®€ä»‹-2">YAMLè¯­æ³•ç®€ä»‹</h3>
<pre><code>Listï¼šåˆ—è¡¨ï¼Œå…¶æ‰€æœ‰å…ƒç´ å‡ä½¿ç”¨â€œ-â€æ‰“å¤´
      åˆ—è¡¨ä»£è¡¨åŒä¸€ç±»å‹çš„å…ƒç´ 
ç¤ºä¾‹ï¼š
# A list of tasty fruits
- Apple
- Orange
- Strawberry
- Mango

Dictionaryï¼šå­—å…¸ï¼Œé€šå¸¸ç”±å¤šä¸ªkeyä¸valueæ„æˆ é”®å€¼å¯¹
ç¤ºä¾‹ï¼š
---
# An employee record
name: Example Developer
job: Developer
skill: Elite

ä¹Ÿå¯ä»¥å°†key:valueæ”¾ç½®äº{}ä¸­è¿›è¡Œè¡¨ç¤ºï¼Œç”¨,åˆ†éš”å¤šä¸ªkey:value
ç¤ºä¾‹ï¼š
---
# An employee record
{name: Example Developer, job: Developer, skill: Elite}  æœ‰ç©ºæ ¼
</code></pre>
<h3 id="yamlè¯­æ³•">YAMLè¯­æ³•</h3>
<pre><code>YAMLçš„è¯­æ³•å’Œå…¶ä»–é«˜é˜¶è¯­è¨€ç±»ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥ç®€å•è¡¨è¾¾æ¸…å•ã€æ•£åˆ—è¡¨ã€æ ‡é‡ç­‰æ•°æ®ç»“æ„ã€‚
å…¶ç»“æ„ï¼ˆStructureï¼‰é€šè¿‡ç©ºæ ¼æ¥å±•ç¤ºï¼Œåºåˆ—ï¼ˆSequenceï¼‰é‡Œçš„é¡¹ç”¨&quot;-&quot;æ¥ä»£è¡¨ï¼ŒMapé‡Œçš„é”®å€¼å¯¹ç”¨&quot;:&quot;åˆ†éš”
ç¤ºä¾‹
    name: John Smith
    age: 41
    gender: Male
    spouse:
      name: Jane Smith
      age: 37
      gender: Female
    children:
      - name: Jimmy Smith
        age: 17
        gender: Male
      - name: Jenny Smith
        age 13
        gender: Female
</code></pre>
<h3 id="ä¸‰ç§å¸¸è§çš„æ•°æ®äº¤æ¢æ ¼å¼">ä¸‰ç§å¸¸è§çš„æ•°æ®äº¤æ¢æ ¼å¼</h3>
<figure data-type="image" tabindex="7"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302011946.png" alt="" loading="lazy"></figure>
<h3 id="playbookæ ¸å¿ƒå…ƒç´ ">Playbookæ ¸å¿ƒå…ƒç´ </h3>
<pre><code>Hosts          æ‰§è¡Œçš„è¿œç¨‹ä¸»æœºåˆ—è¡¨(åº”ç”¨åœ¨å“ªäº›ä¸»æœºä¸Š)

Tasks          ä»»åŠ¡é›†

Variables      å†…ç½®å˜é‡æˆ–è‡ªå®šä¹‰å˜é‡åœ¨playbookä¸­è°ƒç”¨

Templatesæ¨¡æ¿  å¯æ›¿æ¢æ¨¡æ¿æ–‡ä»¶ä¸­çš„å˜é‡å¹¶å®ç°ä¸€äº›ç®€å•é€»è¾‘çš„æ–‡ä»¶

Handlerså’Œnotifyç»“åˆä½¿ç”¨ï¼Œç”±ç‰¹å®šæ¡ä»¶è§¦å‘çš„æ“ä½œï¼Œæ»¡è¶³æ¡ä»¶æ–¹æ‰æ‰§è¡Œï¼Œå¦åˆ™ä¸æ‰§è¡Œ

tagsæ ‡ç­¾       æŒ‡å®šæŸæ¡ä»»åŠ¡æ‰§è¡Œï¼Œç”¨äºé€‰æ‹©è¿è¡Œplaybookä¸­çš„éƒ¨åˆ†ä»£ç ã€‚
                ansibleå…·æœ‰å¹‚ç­‰æ€§ï¼Œå› æ­¤ä¼šè‡ªåŠ¨è·³è¿‡æ²¡æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œ
                å³ä¾¿å¦‚æ­¤ï¼Œæœ‰äº›ä»£ç ä¸ºæµ‹è¯•å…¶ç¡®å®æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ä¾ç„¶ä¼šéå¸¸åœ°é•¿ã€‚
                æ­¤æ—¶ï¼Œå¦‚æœç¡®ä¿¡å…¶æ²¡æœ‰å˜åŒ–ï¼Œå°±å¯ä»¥é€šè¿‡tagsè·³è¿‡æ­¤äº›ä»£ç ç‰‡æ–­
                ansible-playbook -t tagsname useradd.yml
</code></pre>
<h3 id="playbookåŸºç¡€ç»„ä»¶">playbookåŸºç¡€ç»„ä»¶</h3>
<pre><code>Hostsï¼š
    &gt; playbookä¸­çš„æ¯ä¸€ä¸ªplayçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†è®©ç‰¹å®šä¸»æœºä»¥æŸä¸ªæŒ‡å®šçš„ç”¨æˆ·èº«ä»½æ‰§è¡Œä»»åŠ¡ã€‚
      hostsç”¨äºæŒ‡å®šè¦æ‰§è¡ŒæŒ‡å®šä»»åŠ¡çš„ä¸»æœºï¼Œé¡»äº‹å…ˆå®šä¹‰åœ¨ä¸»æœºæ¸…å•ä¸­

    &gt; å¯ä»¥æ˜¯å¦‚ä¸‹å½¢å¼ï¼š
        one.example.com
        one.example.com:two.example.com
        192.168.1.50
        192.168.1.*
    &gt; Websrvs:dbsrvs       æˆ–è€…ï¼Œä¸¤ä¸ªç»„çš„å¹¶é›†
    &gt; Websrvs:&amp;dbsrvs      ä¸ï¼Œä¸¤ä¸ªç»„çš„äº¤é›†
    &gt; webservers:!phoenix  åœ¨websrvsç»„ï¼Œä½†ä¸åœ¨dbsrvsç»„
    ç¤ºä¾‹: - hosts: websrvsï¼šdbsrvs

remote_user: 
    å¯ç”¨äºHostå’Œtaskä¸­ã€‚
    ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå…¶é€šè¿‡sudoçš„æ–¹å¼åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå…¶å¯ç”¨äºplayå…¨å±€æˆ–æŸä»»åŠ¡ï¼›
    æ­¤å¤–ï¼Œç”šè‡³å¯ä»¥åœ¨sudoæ—¶ä½¿ç”¨sudo_useræŒ‡å®šsudoæ—¶åˆ‡æ¢çš„ç”¨æˆ·
    - hosts: websrvs
        remote_user: root   (å¯çœç•¥,é»˜è®¤ä¸ºroot)  ä»¥rootèº«ä»½è¿æ¥
      tasks:    æŒ‡å®šä»»åŠ¡
    - name: test connection
        ping:
        remote_user: ansible
        sudo: yes           é»˜è®¤sudoä¸ºroot
        sudo_user:wang      sudoä¸ºwang
    
taskåˆ—è¡¨å’Œaction
    ä»»åŠ¡åˆ—è¡¨task:ç”±å¤šä¸ªåŠ¨ä½œ,å¤šä¸ªä»»åŠ¡ç»„åˆèµ·æ¥çš„,æ¯ä¸ªä»»åŠ¡éƒ½è°ƒç”¨çš„æ¨¡å—,ä¸€ä¸ªæ¨¡å—ä¸€ä¸ªæ¨¡å—æ‰§è¡Œ
    1&gt; playçš„ä¸»ä½“éƒ¨åˆ†æ˜¯task listï¼Œtask listä¸­çš„å„ä»»åŠ¡æŒ‰æ¬¡åºé€ä¸ªåœ¨hostsä¸­æŒ‡å®šçš„æ‰€æœ‰ä¸»æœºä¸Šæ‰§è¡Œï¼Œ
       å³åœ¨æ‰€æœ‰ä¸»æœºä¸Šå®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡åï¼Œå†å¼€å§‹ç¬¬äºŒä¸ªä»»åŠ¡

    2&gt; taskçš„ç›®çš„æ˜¯ä½¿ç”¨æŒ‡å®šçš„å‚æ•°æ‰§è¡Œæ¨¡å—ï¼Œè€Œåœ¨æ¨¡å—å‚æ•°ä¸­å¯ä»¥ä½¿ç”¨å˜é‡ã€‚
       æ¨¡å—æ‰§è¡Œæ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€å¤šæ¬¡æ‰§è¡Œæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ç»“æœå‡ä¸€è‡´

    3&gt; æ¯ä¸ªtaskéƒ½åº”è¯¥æœ‰å…¶nameï¼Œç”¨äºplaybookçš„æ‰§è¡Œç»“æœè¾“å‡ºï¼Œå»ºè®®å…¶å†…å®¹èƒ½æ¸…æ™°åœ°æè¿°ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ã€‚
       å¦‚æœæœªæä¾›nameï¼Œåˆ™actionçš„ç»“æœå°†ç”¨äºè¾“å‡º
</code></pre>
<pre><code>tasksï¼šä»»åŠ¡åˆ—è¡¨
ä¸¤ç§æ ¼å¼ï¼š
    (1) action: module arguments
    (2) module: arguments å»ºè®®ä½¿ç”¨  æ¨¡å—: å‚æ•°
    æ³¨æ„ï¼šshellå’Œcommandæ¨¡å—åé¢è·Ÿå‘½ä»¤ï¼Œè€Œékey=value

æŸä»»åŠ¡çš„çŠ¶æ€åœ¨è¿è¡Œåä¸ºchangedæ—¶ï¼Œå¯é€šè¿‡&quot;notify&quot;é€šçŸ¥ç»™ç›¸åº”çš„handlers

ä»»åŠ¡å¯ä»¥é€šè¿‡&quot;tags&quot;æ‰“æ ‡ç­¾ï¼Œå¯åœ¨ansible-playbookå‘½ä»¤ä¸Šä½¿ç”¨-tæŒ‡å®šè¿›è¡Œè°ƒç”¨
ç¤ºä¾‹ï¼š
tasks:
  - name: disable selinux   æè¿°
    command: /sbin/setenforce 0   æ¨¡å—å: æ¨¡å—å¯¹åº”çš„å‚æ•°

</code></pre>
<pre><code>å¦‚æœå‘½ä»¤æˆ–è„šæœ¬çš„é€€å‡ºç ä¸ä¸ºé›¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ›¿ä»£
tasks:
  - name: run this command and ignore the result
    shell: /usr/bin/somecommand || /bin/true  
    è½¬é”™ä¸ºæ­£  å¦‚æœå‘½ä»¤å¤±è´¥åˆ™æ‰§è¡Œ true

æˆ–è€…ä½¿ç”¨ignore_errorsæ¥å¿½ç•¥é”™è¯¯ä¿¡æ¯
tasks:
  - name: run this command and ignore the result
    shell: /usr/bin/somecommand
    ignore_errors: True  å¿½ç•¥é”™è¯¯
</code></pre>
<h3 id="è¿è¡Œplaybook">è¿è¡Œplaybook</h3>
<pre><code>è¿è¡Œplaybookçš„æ–¹å¼
    ansible-playbook &lt;filename.yml&gt; ... [options]

å¸¸è§é€‰é¡¹
    --check -C       åªæ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜ï¼Œä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ 
                     (åªæ£€æŸ¥è¯­æ³•,å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜,-Cæ— æ³•æ£€æµ‹å‡ºæ¥)
                     (æ‰§è¡Œplaybookç”Ÿæˆçš„æ–‡ä»¶ä¸å­˜åœ¨,åé¢çš„ç¨‹åºå¦‚æœä¾èµ–è¿™äº›æ–‡ä»¶,ä¹Ÿä¼šå¯¼è‡´æ£€æµ‹å¤±è´¥)
    --list-hosts     åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº
    --list-tags      åˆ—å‡ºtag  (åˆ—å‡ºæ ‡ç­¾)
    --list-tasks     åˆ—å‡ºtask (åˆ—å‡ºä»»åŠ¡)
    --limit ä¸»æœºåˆ—è¡¨ åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„ä¸»æœºæ‰§è¡Œ
    -v -vv -vvv      æ˜¾ç¤ºè¿‡ç¨‹

ç¤ºä¾‹
    ansible-playbook hello.yml --check åªæ£€æµ‹
    ansible-playbook hello.yml --list-hosts  æ˜¾ç¤ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº
    ansible-playbook hello.yml --limit websrvs  é™åˆ¶ä¸»æœº
</code></pre>
<h3 id="playbook-vs-shellscripts">Playbook VS ShellScripts</h3>
<p>å®‰è£…httpd</p>
<pre><code>SHELLè„šæœ¬
#!/bin/bash
# å®‰è£…Apache
yum install --quiet -y httpd
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp /tmp/httpd.conf /etc/httpd/conf/httpd.conf
cp/tmp/vhosts.conf /etc/httpd/conf.d/
# å¯åŠ¨Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨
service httpd start
chkconfig httpd on
</code></pre>
<pre><code>Playbookå®šä¹‰
---
- hosts: all
  remote_user: root
  
  tasks:
    - name: &quot;å®‰è£…Apache&quot;
      yum: name=httpd       yumæ¨¡å—:å®‰è£…httpd
    - name: &quot;å¤åˆ¶é…ç½®æ–‡ä»¶&quot;
      copy: src=/tmp/httpd.conf dest=/etc/httpd/conf/  copyæ¨¡å—: æ‹·è´æ–‡ä»¶
    - name: &quot;å¤åˆ¶é…ç½®æ–‡ä»¶&quot;
      copy: src=/tmp/vhosts.conf dest=/etc/httpd/conf.d/  
    - name: &quot;å¯åŠ¨Apacheï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨&quot;
      service: name=httpd state=started enabled=yes   serviceæ¨¡å—: å¯åŠ¨æœåŠ¡ 
</code></pre>
<h3 id="ç¤ºä¾‹playbook-åˆ›å»ºç”¨æˆ·">ç¤ºä¾‹:Playbook åˆ›å»ºç”¨æˆ·</h3>
<pre><code>ç¤ºä¾‹ï¼šsysuser.yml
---
- hosts: all
  remote_user: root

  tasks:
    - name: create mysql user
      user: name=mysql system=yes uid=36
    - name: create a group
      group: name=httpd system=yes
</code></pre>
<h3 id="playbookç¤ºä¾‹-å®‰è£…httpdæœåŠ¡">Playbookç¤ºä¾‹  å®‰è£…httpdæœåŠ¡</h3>
<pre><code>ç¤ºä¾‹ï¼šhttpd.yml
- hosts: websrvs
  remote_user: root

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
    - name: start service
      service: name=httpd state=started enabled=yes
</code></pre>
<h3 id="playbookç¤ºä¾‹-å®‰è£…nginxæœåŠ¡">Playbookç¤ºä¾‹  å®‰è£…nginxæœåŠ¡</h3>
<pre><code>ç¤ºä¾‹ nginx.yml
- hosts: all
  remote_user: root

  tasks:
    - name: add group nginx
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: Start Nginx
      service: name=nginx state=started enabled=yes
</code></pre>
<h3 id="handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶">handlerså’Œnotifyç»“åˆä½¿ç”¨è§¦å‘æ¡ä»¶</h3>
<pre><code>Handlers å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªè§¦å‘å™¨
æ˜¯taskåˆ—è¡¨ï¼Œè¿™äº›taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒ,ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œ

Notifyæ­¤actionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘ï¼Œ
è¿™æ ·å¯é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œæˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚
åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerï¼Œä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œ
</code></pre>
<h3 id="playbookä¸­handlersä½¿ç”¨">Playbookä¸­handlersä½¿ç”¨</h3>
<pre><code>- hosts: websrvs
  remote_user: root

  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
    - name: ensure apache is running
      service: name=httpd state=started enabled=yes
  
  handlers:
    - name: restart httpd
      service: name=httpd state=restarted
</code></pre>
<h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3>
<pre><code>- hosts: webnodes
  vars:
    http_port: 80
    max_clients: 256
  remote_user: root
  
  tasks:
    - name: ensure apache is at the latest version
      yum: name=httpd state=latest
    - name: ensure apache is running
      service: name=httpd state=started
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      notify: restart httpd
  
  handlers:
      - name: restart httpd 
        service: name=httpd state=restarted
</code></pre>
<h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹</h3>
<pre><code>- hosts: websrvs
  remote_user: root
  
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: config
      copy: src=/root/config.txt dest=/etc/nginx/nginx.conf
      notify:
        - Restart Nginx
        - Check Nginx Process
  
  handlers:
    - name: Restart Nginx
      service: name=nginx state=restarted enabled=yes
    - name: Check Nginx process
      shell: killall -0 nginx &gt; /tmp/nginx.log
</code></pre>
<h3 id="playbookä¸­tagsä½¿ç”¨">Playbookä¸­tagsä½¿ç”¨</h3>
<pre><code>tage: æ·»åŠ æ ‡ç­¾ 
å¯ä»¥æŒ‡å®šæŸä¸€ä¸ªä»»åŠ¡æ·»åŠ ä¸€ä¸ªæ ‡ç­¾,æ·»åŠ æ ‡ç­¾ä»¥å,æƒ³æ‰§è¡ŒæŸä¸ªåŠ¨ä½œå¯ä»¥åšå‡ºæŒ‘é€‰æ¥æ‰§è¡Œ
å¤šä¸ªåŠ¨ä½œå¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªæ ‡ç­¾

ç¤ºä¾‹ï¼šhttpd.yml
- hosts: websrvs
  remote_user: root
  
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
      tage: install 
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      tags: conf
    - name: start httpd service
      tags: service
      service: name=httpd state=started enabled=yes

ansible-playbook â€“t install,conf httpd.yml   æŒ‡å®šæ‰§è¡Œinstall,conf ä¸¤ä¸ªæ ‡ç­¾
</code></pre>
<h3 id="ç¤ºä¾‹-3">ç¤ºä¾‹</h3>
<pre><code>//heartbeat.yaml
- hosts: hbhosts
  remote_user: root
  
  tasks:
    - name: ensure heartbeat latest version
      yum: name=heartbeat state=present
    - name: authkeys configure file
      copy: src=/root/hb_conf/authkeys dest=/etc/ha.d/authkeys
    - name: authkeys mode 600
      file: path=/etc/ha.d/authkeys mode=600
      notify:
        - restart heartbeat
    - name: ha.cf configure file
      copy: src=/root/hb_conf/ha.cf dest=/etc/ha.d/ha.cf
      notify:
        - restart heartbeat
  handlers:
    - name: restart heartbeat
      service: name=heartbeat state=restarted
</code></pre>
<h3 id="playbookä¸­tagsä½¿ç”¨-2">Playbookä¸­tagsä½¿ç”¨</h3>
<pre><code>- hosts: testsrv
  remote_user: root
  tags: inshttpd   é’ˆå¯¹æ•´ä¸ªplaybookæ·»åŠ tage
  tasks:
    - name: Install httpd
      yum: name=httpd state=present
    - name: Install configure file
      copy: src=files/httpd.conf dest=/etc/httpd/conf/
      tags: rshttpd
      notify: restart httpd
  handlers:
    - name: restart httpd
      service: name=httpd status=restarted
     
ansible-playbook â€“t rshttpd httpd2.yml
</code></pre>
<h3 id="playbookä¸­å˜é‡çš„ä½¿ç”¨">Playbookä¸­å˜é‡çš„ä½¿ç”¨</h3>
<pre><code>å˜é‡åï¼šä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´
å˜é‡æ¥æºï¼š
    1&gt; ansible setup facts è¿œç¨‹ä¸»æœºçš„æ‰€æœ‰å˜é‡éƒ½å¯ç›´æ¥è°ƒç”¨ (ç³»ç»Ÿè‡ªå¸¦å˜é‡)
       setupæ¨¡å—å¯ä»¥å®ç°ç³»ç»Ÿä¸­å¾ˆå¤šç³»ç»Ÿä¿¡æ¯çš„æ˜¾ç¤º
                å¯ä»¥è¿”å›æ¯ä¸ªä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯åŒ…æ‹¬:ç‰ˆæœ¬ã€ä¸»æœºåã€cpuã€å†…å­˜
       ansible all -m setup -a 'filter=&quot;ansible_nodename&quot;'     æŸ¥è¯¢ä¸»æœºå
       ansible all -m setup -a 'filter=&quot;ansible_memtotal_mb&quot;'  æŸ¥è¯¢ä¸»æœºå†…å­˜å¤§å°
       ansible all -m setup -a 'filter=&quot;ansible_distribution_major_version&quot;'  æŸ¥è¯¢ç³»ç»Ÿç‰ˆæœ¬
       ansible all -m setup -a 'filter=&quot;ansible_processor_vcpus&quot;' æŸ¥è¯¢ä¸»æœºcpuä¸ªæ•°
    
    2&gt; åœ¨/etc/ansible/hosts(ä¸»æœºæ¸…å•)ä¸­å®šä¹‰å˜é‡
        æ™®é€šå˜é‡ï¼šä¸»æœºç»„ä¸­ä¸»æœºå•ç‹¬å®šä¹‰ï¼Œä¼˜å…ˆçº§é«˜äºå…¬å…±å˜é‡(å•ä¸ªä¸»æœº )
        å…¬å…±(ç»„)å˜é‡ï¼šé’ˆå¯¹ä¸»æœºç»„ä¸­æ‰€æœ‰ä¸»æœºå®šä¹‰ç»Ÿä¸€å˜é‡(ä¸€ç»„ä¸»æœºçš„åŒä¸€ç±»åˆ«)
    
    3&gt; é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜
       ansible-playbook â€“e varname=value
    
    4&gt; åœ¨playbookä¸­å®šä¹‰
       vars:
        - var1: value1
        - var2: value2
    
    5&gt; åœ¨ç‹¬ç«‹çš„å˜é‡YAMLæ–‡ä»¶ä¸­å®šä¹‰
    
    6&gt; åœ¨roleä¸­å®šä¹‰

å˜é‡å‘½å:
    å˜é‡åä»…èƒ½ç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œä¸”åªèƒ½ä»¥å­—æ¯å¼€å¤´

å˜é‡å®šä¹‰ï¼škey=value
    ç¤ºä¾‹ï¼šhttp_port=80

å˜é‡è°ƒç”¨æ–¹å¼ï¼š
    1&gt; é€šè¿‡{{ variable_name }} è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå¿…é¡»æœ‰ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨â€œ{{ variable_name }}â€æ‰ç”Ÿæ•ˆ

    2&gt; ansible-playbook â€“e é€‰é¡¹æŒ‡å®š
       ansible-playbook test.yml -e &quot;hosts=www user=ansible&quot;
</code></pre>
<pre><code>åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰å˜é‡,åœ¨ansibleä¸­ä½¿ç”¨å˜é‡
vim /etc/ansible/hosts
[appsrvs]
192.168.38.17 http_port=817 name=www
192.168.38.27 http_port=827 name=web

è°ƒç”¨å˜é‡
ansible appsrvs -m hostname -a'name={{name}}'  æ›´æ”¹ä¸»æœºåä¸ºå„è‡ªè¢«å®šä¹‰çš„å˜é‡ 

é’ˆå¯¹ä¸€ç»„è®¾ç½®å˜é‡
[appsrvs:vars]
make=&quot;-&quot;

ansible appsrvs -m hostname -a 'name={{name}}{{mark}}{{http_port}}'  ansibleè°ƒç”¨å˜é‡

</code></pre>
<pre><code>å°†å˜é‡å†™è¿›å•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨
vim vars.yml
pack: vsftpd
service: vsftpd

å¼•ç”¨å˜é‡æ–‡ä»¶
vars_files:
  - vars.yml 
    
</code></pre>
<h3 id="ansibleåŸºç¡€å…ƒç´ ">AnsibleåŸºç¡€å…ƒç´ </h3>
<pre><code>Factsï¼šæ˜¯ç”±æ­£åœ¨é€šä¿¡çš„è¿œç¨‹ç›®æ ‡ä¸»æœºå‘å›çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯è¢«ä¿å­˜åœ¨ansibleå˜é‡ä¸­ã€‚
       è¦è·å–æŒ‡å®šçš„è¿œç¨‹ä¸»æœºæ‰€æ”¯æŒçš„æ‰€æœ‰factsï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œ
       ansible websrvs -m setup

é€šè¿‡å‘½ä»¤è¡Œä¼ é€’å˜é‡
    åœ¨è¿è¡Œplaybookçš„æ—¶å€™ä¹Ÿå¯ä»¥ä¼ é€’ä¸€äº›å˜é‡ä¾›playbookä½¿ç”¨
    ç¤ºä¾‹ï¼š
        ansible-playbook test.yml -e &quot;hosts=www user=ansible&quot;
        
register
æŠŠä»»åŠ¡çš„è¾“å‡ºå®šä¹‰ä¸ºå˜é‡ï¼Œç„¶åç”¨äºå…¶ä»–ä»»åŠ¡

ç¤ºä¾‹:
tasks:
- shell: /usr/bin/foo
  register: foo_result
  ignore_errors: True
</code></pre>
<h3 id="ç¤ºä¾‹ä½¿ç”¨setupå˜é‡">ç¤ºä¾‹ï¼šä½¿ç”¨setupå˜é‡</h3>
<pre><code>ç¤ºä¾‹ï¼švar.yml
- hosts: websrvs
  remote_user: root
  tasks:
    - name: create log file
      file: name=/var/log/ {{ ansible_fqdn }} state=touch

ansible-playbook var.yml
</code></pre>
<h3 id="ç¤ºä¾‹å˜é‡">ç¤ºä¾‹ï¼šå˜é‡</h3>
<pre><code>ç¤ºä¾‹ï¼švar.yml
- hosts: websrvs
  remote_user: root
  tasks:
    - name: install package
      yum: name={{ pkname }} state=present
      
ansible-playbook â€“e pkname=httpd var.yml
</code></pre>
<h3 id="ç¤ºä¾‹å˜é‡-2">ç¤ºä¾‹ï¼šå˜é‡</h3>
<pre><code>ç¤ºä¾‹ï¼švar.yml
- hosts: websrvs
  remote_user: root
vars:
  - username: user1
  - groupname: group1
tasks:
  - name: create group
    group: name={{ groupname }} state=present
  - name: create user
    user: name={{ username }} state=present

ansible-playbook var.yml
ansible-playbook -e &quot;username=user2 groupname=group2â€ var2.yml

</code></pre>
<h3 id="å˜é‡">å˜é‡</h3>
<pre><code>ä¸»æœºå˜é‡
å¯ä»¥åœ¨inventoryä¸­å®šä¹‰ä¸»æœºæ—¶ä¸ºå…¶æ·»åŠ ä¸»æœºå˜é‡ä»¥ä¾¿äºåœ¨playbookä¸­ä½¿ç”¨

ç¤ºä¾‹ï¼š
[websrvs]
www1.ansible.com http_port=80 maxRequestsPerChild=808
www2.ansible.com http_port=8080 maxRequestsPerChild=909

ç»„å˜é‡
ç»„å˜é‡æ˜¯æŒ‡èµ‹äºˆç»™æŒ‡å®šç»„å†…æ‰€æœ‰ä¸»æœºä¸Šçš„åœ¨playbookä¸­å¯ç”¨çš„å˜é‡

ç¤ºä¾‹ï¼š
    [websrvs]
    www1.ansible.com
    www2.ansible.com

    [websrvs:vars]
    ntp_server=ntp.ansible.com
    nfs_server=nfs.ansible.com
</code></pre>
<h3 id="ç¤ºä¾‹å˜é‡-3">ç¤ºä¾‹ï¼šå˜é‡</h3>
<pre><code>æ™®é€šå˜é‡
    [websrvs]
    192.168.99.101 http_port=8080 hname=www1
    192.168.99.102 http_port=80 hname=www2

å…¬å…±ï¼ˆç»„ï¼‰å˜é‡
    [websvrs:vars]
    http_port=808
    mark=&quot;_&quot;
    [websrvs]
    192.168.99.101 http_port=8080 hname=www1
    192.168.99.102 http_port=80 hname=www2
    ansible websvrs â€“m hostname â€“a â€˜name={{ hname }}{{ mark }}{{ http_port }}â€™

å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼š
    ansible websvrs â€“e http_port=8000 â€“m hostname â€“a'name={{ hname }}{{ mark }}{{ http_port }}'
</code></pre>
<h3 id="ä½¿ç”¨å˜é‡æ–‡ä»¶">ä½¿ç”¨å˜é‡æ–‡ä»¶</h3>
<pre><code>cat vars.yml
var1: httpd
var2: nginx

cat var.yml
- hosts: web
  remote_user: root
  vars_files:
    - vars.yml
  tasks:
    - name: create httpd log
      file: name=/app/{{ var1 }}.log state=touch
    - name: create nginx log
      file: name=/app/{{ var2 }}.log state=touch
      
hostname app_81.ansible.com  hostname ä¸æ”¯æŒ&quot;_&quot;,è®¤ä¸º&quot;_&quot;æ˜¯éæ³•å­—ç¬¦
hostnamectl set-hostname app_80.ansible.com  å¯ä»¥æ›´æ”¹ä¸»æœºå
</code></pre>
<h3 id="å˜é‡-2">å˜é‡</h3>
<pre><code>ç»„åµŒå¥—
inventoryä¸­ï¼Œç»„è¿˜å¯ä»¥åŒ…å«å…¶å®ƒçš„ç»„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å‘ç»„ä¸­çš„ä¸»æœºæŒ‡å®šå˜é‡ã€‚
è¿™äº›å˜é‡åªèƒ½åœ¨ansible-playbookä¸­ä½¿ç”¨ï¼Œè€Œansibleå‘½ä»¤ä¸æ”¯æŒ

ç¤ºä¾‹ï¼š
    [apache]
    httpd1.ansible.com
    httpd2.ansible.com
    
    [nginx]
    ngx1.ansible.com
    ngx2.ansible.com
    
    [websrvs:children]
    apache
    nginx
    
    [webservers:vars]
    ntp_server=ntp.ansible.com
</code></pre>
<h3 id="invertoryå‚æ•°">invertoryå‚æ•°</h3>
<pre><code>invertoryå‚æ•°ï¼šç”¨äºå®šä¹‰ansibleè¿œç¨‹è¿æ¥ç›®æ ‡ä¸»æœºæ—¶ä½¿ç”¨çš„å‚æ•°ï¼Œè€Œéä¼ é€’ç»™playbookçš„å˜é‡
    ansible_ssh_host
    ansible_ssh_port
    ansible_ssh_user
    ansible_ssh_pass
    ansbile_sudo_pass

ç¤ºä¾‹ï¼š
    cat /etc/ansible/hosts
    [websrvs]
    192.168.0.1 ansible_ssh_user=root ansible_ssh_pass=ansible
    192.168.0.2 ansible_ssh_user=root ansible_ssh_pass=ansible
</code></pre>
<h3 id="invertoryå‚æ•°-2">invertoryå‚æ•°</h3>
<pre><code>inventoryå‚æ•°
ansibleåŸºäºsshè¿æ¥inventoryä¸­æŒ‡å®šçš„è¿œç¨‹ä¸»æœºæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šå…¶äº¤äº’æ–¹å¼ï¼›
è¿™äº›å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š
ansible_ssh_host
The name of the host to connect to, if different from the alias you wishto give to it.

ansible_ssh_port
The ssh port number, if not 22

ansible_ssh_user
The default ssh user name to use.

ansible_ssh_pass
The ssh password to use (this is insecure, we strongly recommendusing --ask-pass or SSH keys)

ansible_sudo_pass
The sudo password to use (this is insecure, we strongly recommendusing --ask-sudo-pass)

ansible_connection
Connection type of the host. Candidates are local, ssh or paramiko.
The default is paramiko before Ansible 1.2, and 'smart' afterwards which
detects whether usage of 'ssh' would be feasible based on whether
ControlPersist is supported.

ansible_ssh_private_key_file
Private key file used by ssh. Useful if using multiple keys and you don't want to use SSH agent.

ansible_shell_type
The shell type of the target system. By default commands are formatted
using 'sh'-style syntax by default. Setting this to 'csh' or 'fish' will cause
commands executed on target systems to follow those shell's syntax instead.

ansible_python_interpreter
The target host python path. This is useful for systems with more
than one Python or not located at &quot;/usr/bin/python&quot; such as \*BSD, or where /usr/bin/python

is not a 2.X series Python. We do not use the &quot;/usr/bin/env&quot; mechanism as that requires the remote user's

path to be set right and also assumes the &quot;python&quot; executable is named python,where the executable might

be named something like &quot;python26&quot;.
ansible\_\*\_interpreter

Works for anything such as ruby or perl and works just like ansible_python_interpreter.

This replaces shebang of modules which will run on that host.
</code></pre>
<h3 id="æ¨¡æ¿templates">æ¨¡æ¿templates</h3>
<pre><code>æ–‡æœ¬æ–‡ä»¶ï¼ŒåµŒå¥—æœ‰è„šæœ¬ï¼ˆä½¿ç”¨æ¨¡æ¿ç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼‰ å€ŸåŠ©æ¨¡æ¿ç”ŸæˆçœŸæ­£çš„æ–‡ä»¶
Jinja2è¯­è¨€ï¼Œä½¿ç”¨å­—é¢é‡ï¼Œæœ‰ä¸‹é¢å½¢å¼
    å­—ç¬¦ä¸²ï¼šä½¿ç”¨å•å¼•å·æˆ–åŒå¼•å·
    æ•°å­—ï¼šæ•´æ•°ï¼Œæµ®ç‚¹æ•°
    åˆ—è¡¨ï¼š[item1, item2, ...]
    å…ƒç»„ï¼š(item1, item2, ...)
    å­—å…¸ï¼š{key1:value1, key2:value2, ...}
    å¸ƒå°”å‹ï¼štrue/false
ç®—æœ¯è¿ç®—ï¼š+, -, *, /, //, %, **
æ¯”è¾ƒæ“ä½œï¼š==, !=, &gt;, &gt;=, &lt;, &lt;=
é€»è¾‘è¿ç®—ï¼šandï¼Œorï¼Œnot
æµè¡¨è¾¾å¼ï¼šForï¼ŒIfï¼ŒWhen
</code></pre>
<h3 id="jinja2ç›¸å…³">Jinja2ç›¸å…³</h3>
<pre><code>å­—é¢é‡
    1&gt; è¡¨è¾¾å¼æœ€ç®€å•çš„å½¢å¼å°±æ˜¯å­—é¢é‡ã€‚å­—é¢é‡è¡¨ç¤ºè¯¸å¦‚å­—ç¬¦ä¸²å’Œæ•°å€¼çš„ Pythonå¯¹è±¡ã€‚å¦‚â€œHello Worldâ€
    åŒå¼•å·æˆ–å•å¼•å·ä¸­é—´çš„ä¸€åˆ‡éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚
    2&gt; æ— è®ºä½•æ—¶ä½ éœ€è¦åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚å‡½æ•°è°ƒç”¨ã€è¿‡æ»¤å™¨æˆ–åªæ˜¯åŒ…å«æˆ–ç»§æ‰¿ä¸€ä¸ªæ¨¡æ¿çš„å‚æ•°ï¼‰ï¼Œå¦‚4242.23
    3&gt; æ•°å€¼å¯ä»¥ä¸ºæ•´æ•°å’Œæµ®ç‚¹æ•°ã€‚å¦‚æœæœ‰å°æ•°ç‚¹ï¼Œåˆ™ä¸ºæµ®ç‚¹æ•°ï¼Œå¦åˆ™ä¸ºæ•´æ•°ã€‚åœ¨Python é‡Œï¼Œ 42 å’Œ 42.0 æ˜¯ä¸ä¸€æ ·çš„
</code></pre>
<h3 id="jinja2ç®—æœ¯è¿ç®—">Jinja2:ç®—æœ¯è¿ç®—</h3>
<pre><code>ç®—æœ¯è¿ç®—
Jinja å…è®¸ä½ ç”¨è®¡ç®—å€¼ã€‚è¿™åœ¨æ¨¡æ¿ä¸­å¾ˆå°‘ç”¨åˆ°ï¼Œä½†ä¸ºäº†å®Œæ•´æ€§å…è®¸å…¶å­˜åœ¨
æ”¯æŒä¸‹é¢çš„è¿ç®—ç¬¦
    +ï¼šæŠŠä¸¤ä¸ªå¯¹è±¡åŠ åˆ°ä¸€èµ·ã€‚
       é€šå¸¸å¯¹è±¡æ˜¯ç´ è´¨ï¼Œä½†æ˜¯å¦‚æœä¸¤è€…æ˜¯å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼Œä½ å¯ä»¥ç”¨è¿™ ç§æ–¹å¼æ¥è¡”æ¥å®ƒä»¬ã€‚
       æ— è®ºå¦‚ä½•è¿™ä¸æ˜¯é¦–é€‰çš„è¿æ¥å­—ç¬¦ä¸²çš„æ–¹å¼ï¼è¿æ¥å­—ç¬¦ä¸²è§ ~ è¿ç®—ç¬¦ã€‚ {{ 1 + 1 }} ç­‰äº 2
    -ï¼šç”¨ç¬¬ä¸€ä¸ªæ•°å‡å»ç¬¬äºŒä¸ªæ•°ã€‚ {{ 3 - 2 }} ç­‰äº 1
    /ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ã€‚è¿”å›å€¼ä¼šæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ã€‚ {{ 1 / 2 }} ç­‰äº {{ 0.5 }}
    //ï¼šå¯¹ä¸¤ä¸ªæ•°åšé™¤æ³•ï¼Œè¿”å›æ•´æ•°å•†ã€‚ {{ 20 // 7 }} ç­‰äº 2
    %ï¼šè®¡ç®—æ•´æ•°é™¤æ³•çš„ä½™æ•°ã€‚ {{ 11 % 7 }} ç­‰äº 4
    *ï¼šç”¨å³è¾¹çš„æ•°ä¹˜å·¦è¾¹çš„æ“ä½œæ•°ã€‚ {{ 2 * 2 }} ä¼šè¿”å› 4 ã€‚
       ä¹Ÿå¯ä»¥ç”¨äºé‡ å¤ä¸€ä¸ªå­—ç¬¦ä¸²å¤šæ¬¡ã€‚{{ â€˜=â€™ * 80 }} ä¼šæ‰“å° 80 ä¸ªç­‰å·çš„æ¨ªæ¡
    **ï¼šå–å·¦æ“ä½œæ•°çš„å³æ“ä½œæ•°æ¬¡å¹‚ã€‚ {{ 2**3 }} ä¼šè¿”å› 8
</code></pre>
<h3 id="jinja2">Jinja2</h3>
<pre><code>æ¯”è¾ƒæ“ä½œç¬¦
== æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰
!= æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ä¸ç­‰
&gt; å¦‚æœå·¦è¾¹å¤§äºå³è¾¹ï¼Œè¿”å› true
&gt;= å¦‚æœå·¦è¾¹å¤§äºç­‰äºå³è¾¹ï¼Œè¿”å› true
&lt; å¦‚æœå·¦è¾¹å°äºå³è¾¹ï¼Œè¿”å› true
&lt;= å¦‚æœå·¦è¾¹å°äºç­‰äºå³è¾¹ï¼Œè¿”å› true

é€»è¾‘è¿ç®—ç¬¦
å¯¹äº if è¯­å¥ï¼Œåœ¨ for è¿‡æ»¤æˆ– if è¡¨è¾¾å¼ä¸­ï¼Œå®ƒå¯ä»¥ç”¨äºè”åˆå¤šä¸ªè¡¨è¾¾å¼
and
    å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°åŒä¸ºçœŸï¼Œè¿”å› true
or
    å¦‚æœå·¦æ“ä½œæ•°å’Œå³æ“ä½œæ•°æœ‰ä¸€ä¸ªä¸ºçœŸï¼Œè¿”å› true
not
    å¯¹ä¸€ä¸ªè¡¨è¾¾å¼å–åï¼ˆè§ä¸‹ï¼‰
(expr)
    è¡¨è¾¾å¼ç»„

['list', 'of', 'objects']:
ä¸€å¯¹ä¸­æ‹¬å·æ‹¬èµ·æ¥çš„ä¸œè¥¿æ˜¯ä¸€ä¸ªåˆ—è¡¨ã€‚åˆ—è¡¨ç”¨äºå­˜å‚¨å’Œè¿­ä»£åºåˆ—åŒ–çš„æ•°æ®ã€‚
ä¾‹å¦‚ ä½ å¯ä»¥å®¹æ˜“åœ°åœ¨ forå¾ªç¯ä¸­ç”¨åˆ—è¡¨å’Œå…ƒç»„åˆ›å»ºä¸€ä¸ªé“¾æ¥çš„åˆ—è¡¨
    &lt;ul&gt;
    {% for href, caption in [('index.html', 'Index'), ('about.html', 'About'), ('downloads.html',
'Downloads')] %}
        &lt;li&gt;&lt;a href=&quot;{{ href }}&quot;&gt;{{ caption }}&lt;/a&gt;&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
    ('tuple', 'of', 'values'):

å…ƒç»„ä¸åˆ—è¡¨ç±»ä¼¼ï¼Œåªæ˜¯ä½ ä¸èƒ½ä¿®æ”¹å…ƒç»„ã€‚
å¦‚æœå…ƒç»„ä¸­åªæœ‰ä¸€ä¸ªé¡¹ï¼Œä½ éœ€è¦ä»¥é€—å·ç»“å°¾å®ƒã€‚
å…ƒç»„é€šå¸¸ç”¨äºè¡¨ç¤ºä¸¤ä¸ªæˆ–æ›´å¤šå…ƒç´ çš„é¡¹ã€‚æ›´å¤šç»†èŠ‚è§ä¸Šé¢çš„ä¾‹å­
    {'dict': 'of', 'key': 'and', 'value': 'pairs'}:

Python ä¸­çš„å­—å…¸æ˜¯ä¸€ç§å…³è”é”®å’Œå€¼çš„ç»“æ„ã€‚
é”®å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå¹¶ä¸”é”®å¿…é¡»åªæœ‰ä¸€ä¸ª å€¼ã€‚
å­—å…¸åœ¨æ¨¡æ¿ä¸­å¾ˆå°‘ä½¿ç”¨ï¼Œç½•ç”¨äºè¯¸å¦‚ xmlattr() è¿‡æ»¤å™¨ä¹‹ç±»
    true / false:
    true æ°¸è¿œæ˜¯ true ï¼Œè€Œ false å§‹ç»ˆæ˜¯ false
</code></pre>
<h3 id="template-çš„ä½¿ç”¨">template çš„ä½¿ç”¨</h3>
<pre><code>templateåŠŸèƒ½ï¼šæ ¹æ®æ¨¡å—æ–‡ä»¶åŠ¨æ€ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶
   &gt; templateæ–‡ä»¶å¿…é¡»å­˜æ”¾äºtemplatesç›®å½•ä¸‹ï¼Œä¸”å‘½åä¸º .j2 ç»“å°¾
   &gt; yaml/yml æ–‡ä»¶éœ€å’Œtemplatesç›®å½•å¹³çº§ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
    ./
     â”œâ”€â”€ temnginx.yml
     â””â”€â”€ templates
        â””â”€â”€ nginx.conf.j2
</code></pre>
<h3 id="templateç¤ºä¾‹">templateç¤ºä¾‹</h3>
<pre><code>ç¤ºä¾‹ï¼šåˆ©ç”¨template åŒæ­¥nginxé…ç½®æ–‡ä»¶
å‡†å¤‡templates/nginx.conf.j2æ–‡ä»¶
vim temnginx.yml
- hosts: websrvs
  remote_user: root
  
  tasks:
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

ansible-playbook temnginx.yml
</code></pre>
<h3 id="playbookä¸­templateå˜æ›´æ›¿æ¢">Playbookä¸­templateå˜æ›´æ›¿æ¢</h3>
<pre><code>ä¿®æ”¹æ–‡ä»¶nginx.conf.j2 ä¸‹é¢è¡Œä¸º
worker_processes {{ ansible_processor_vcpus }};

cat temnginx2.yml
- hosts: websrvs
  remote_user: root
  tasks:
    - name: template config to remote hosts
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

ansible-playbook temnginx2.yml
</code></pre>
<h3 id="playbookä¸­templateç®—æœ¯è¿ç®—">Playbookä¸­templateç®—æœ¯è¿ç®—</h3>
<pre><code>ç®—æ³•è¿ç®—ï¼š
ç¤ºä¾‹ï¼š
    vim nginx.conf.j2
    worker_processes {{ ansible_processor_vcpus**2 }};
    worker_processes {{ ansible_processor_vcpus+2 }};
</code></pre>
<h3 id="when-å®ç°æ¡ä»¶åˆ¤æ–­">when  å®ç°æ¡ä»¶åˆ¤æ–­</h3>
<pre><code>æ¡ä»¶æµ‹è¯•:å¦‚æœéœ€è¦æ ¹æ®å˜é‡ã€factsæˆ–æ­¤å‰ä»»åŠ¡çš„æ‰§è¡Œç»“æœæ¥åšä¸ºæŸtaskæ‰§è¡Œä¸å¦çš„å‰ææ—¶è¦ç”¨åˆ°æ¡ä»¶æµ‹è¯•,
é€šè¿‡whenè¯­å¥å®ç°ï¼Œåœ¨taskä¸­ä½¿ç”¨ï¼Œjinja2çš„è¯­æ³•æ ¼å¼

whenè¯­å¥
    åœ¨taskåæ·»åŠ whenå­å¥å³å¯ä½¿ç”¨æ¡ä»¶æµ‹è¯•ï¼›whenè¯­å¥æ”¯æŒJinja2è¡¨è¾¾å¼è¯­æ³•
ç¤ºä¾‹ï¼š
tasks:
  - name: &quot;shutdown RedHat flavored systems&quot;
    command: /sbin/shutdown -h now
    when: ansible_os_family == &quot;RedHat&quot;  å½“ç³»ç»Ÿå±äºçº¢å¸½ç³»åˆ—,æ‰§è¡Œcommandæ¨¡å— 
 
whenè¯­å¥ä¸­è¿˜å¯ä»¥ä½¿ç”¨Jinja2çš„å¤§å¤š&quot;filter&quot;ï¼Œ
ä¾‹å¦‚è¦å¿½ç•¥æ­¤å‰æŸè¯­å¥çš„é”™è¯¯å¹¶åŸºäºå…¶ç»“æœ(failedæˆ–è€…success)è¿è¡Œåé¢æŒ‡å®šçš„è¯­å¥ï¼Œ
å¯ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹å½¢å¼ï¼š
tasks:
  - command: /bin/false
    register: result
    ignore_errors: True
  - command: /bin/something
    when: result|failed
  - command: /bin/something_else
    when: result|success
  - command: /bin/still/something_else
    when: result|skipped

æ­¤å¤–ï¼Œwhenè¯­å¥ä¸­è¿˜å¯ä»¥ä½¿ç”¨factsæˆ–playbookä¸­å®šä¹‰çš„å˜é‡
</code></pre>
<h3 id="ç¤ºä¾‹whenæ¡ä»¶åˆ¤æ–­">ç¤ºä¾‹ï¼šwhenæ¡ä»¶åˆ¤æ–­</h3>
<pre><code>- hosts: websrvs
  remote_user: root
  tasks:
    - name: add group nginx
      tags: user
      user: name=nginx state=present
    - name: add user nginx
      user: name=nginx state=present group=nginx
    - name: Install Nginx
      yum: name=nginx state=present
    - name: restart Nginx
      service: name=nginx state=restarted
      when: ansible_distribution_major_version == &quot;6&quot;
</code></pre>
<h3 id="ç¤ºä¾‹whenæ¡ä»¶åˆ¤æ–­-2">ç¤ºä¾‹ï¼šwhenæ¡ä»¶åˆ¤æ–­</h3>
<pre><code>ç¤ºä¾‹ï¼š
tasks:
  - name: install conf file to centos7
    template: src=nginx.conf.c7.j2 dest=/etc/nginx/nginx.conf
    when: ansible_distribution_major_version == &quot;7&quot;
  - name: install conf file to centos6
    template: src=nginx.conf.c6.j2 dest=/etc/nginx/nginx.conf
    when: ansible_distribution_major_version == &quot;6&quot;
</code></pre>
<h3 id="playbookä¸­whenæ¡ä»¶åˆ¤æ–­">Playbookä¸­whenæ¡ä»¶åˆ¤æ–­</h3>
<pre><code>---
- hosts: srv120
  remote_user: root
  tasks:
    - name:
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version == &quot;7&quot;
</code></pre>
<figure data-type="image" tabindex="8"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302012029.png" alt="" loading="lazy"></figure>
<h3 id="è¿­ä»£with_items">è¿­ä»£ï¼šwith_items</h3>
<pre><code>è¿­ä»£ï¼šå½“æœ‰éœ€è¦é‡å¤æ€§æ‰§è¡Œçš„ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿­ä»£æœºåˆ¶
    &gt; å¯¹è¿­ä»£é¡¹çš„å¼•ç”¨ï¼Œå›ºå®šå˜é‡åä¸º&quot;item&quot;
    &gt; è¦åœ¨taskä¸­ä½¿ç”¨with_itemsç»™å®šè¦è¿­ä»£çš„å…ƒç´ åˆ—è¡¨
    &gt; åˆ—è¡¨æ ¼å¼ï¼š
         å­—ç¬¦ä¸²
         å­—å…¸
</code></pre>
<h3 id="ç¤ºä¾‹-4">ç¤ºä¾‹</h3>
<pre><code>ç¤ºä¾‹ï¼š åˆ›å»ºç”¨æˆ·
- name: add several users
  user: name={{ item }} state=present groups=wheel   #{{ item }} ç³»ç»Ÿè‡ªå®šä¹‰å˜é‡
  with_items:       # å®šä¹‰{{ item }} çš„å€¼å’Œä¸ªæ•°
    - testuser1
    - testuser2

ä¸Šé¢è¯­å¥çš„åŠŸèƒ½ç­‰åŒäºä¸‹é¢çš„è¯­å¥ï¼š
- name: add user testuser1
  user: name=testuser1 state=present groups=wheel
- name: add user testuser2
  user: name=testuser2 state=present groups=wheel
  
with_itemsä¸­å¯ä»¥ä½¿ç”¨å…ƒç´ è¿˜å¯ä¸ºhashes
ç¤ºä¾‹ï¼š
- name: add several users
  user: name={{ item.name }} state=present groups={{ item.groups }}
  with_items:
    - { name: 'testuser1', groups: 'wheel' }
    - { name: 'testuser2', groups: 'root' }

ansibleçš„å¾ªç¯æœºåˆ¶è¿˜æœ‰æ›´å¤šçš„é«˜çº§åŠŸèƒ½ï¼Œå…·ä½“è¯·å‚è§å®˜æ–¹æ–‡æ¡£
http://docs.ansible.com/playbooks_loops.html
</code></pre>
<h3 id="ç¤ºä¾‹è¿­ä»£">ç¤ºä¾‹ï¼šè¿­ä»£</h3>
<pre><code>ç¤ºä¾‹ï¼šå°†å¤šä¸ªæ–‡ä»¶è¿›è¡Œcopyåˆ°è¢«æ§ç«¯
---
- hosts: testsrv
  remote_user: root
  tasks
  - name: Create rsyncd config
    copy: src={{ item }} dest=/etc/{{ item }}
    with_items:
  - rsyncd.secrets
  - rsyncd.conf
</code></pre>
<h3 id="ç¤ºä¾‹è¿­ä»£-2">ç¤ºä¾‹ï¼šè¿­ä»£</h3>
<pre><code>- hosts: websrvs
  remote_user: root
  tasks:
    - name: copy file
      copy: src={{ item }} dest=/tmp/{{ item }}
      with_items:
    - file1
    - file2
    - file3
- name: yum install httpd
  yum: name={{ item }} state=present
  with_items:
    - apr
    - apr-util
    - httpd
</code></pre>
<h3 id="ç¤ºä¾‹è¿­ä»£-3">ç¤ºä¾‹ï¼šè¿­ä»£</h3>
<pre><code>- hostsï¼šwebsrvs
  remote_user: root
  tasks
    - name: install some packages
      yum: name={{ item }} state=present
      with_items:
        - nginx
        - memcached
        - php-fpm
</code></pre>
<h3 id="ç¤ºä¾‹è¿­ä»£åµŒå¥—å­å˜é‡">ç¤ºä¾‹ï¼šè¿­ä»£åµŒå¥—å­å˜é‡</h3>
<pre><code>- hostsï¼šwebsrvs
  remote_user: root
  
  tasks:
    - name: add some groups
      group: name={{ item }} state=present
      with_items:
        - group1
        - group2
        - group3
    - name: add some users
      user: name={{ item.name }} group={{ item.group }} state=present
      with_items:
        - { name: 'user1', group: 'group1' }
        - { name: 'user2', group: 'group2' }
        - { name: 'user3', group: 'group3' }
</code></pre>
<h3 id="with_itmes-åµŒå¥—å­å˜é‡">with_itmes åµŒå¥—å­å˜é‡</h3>
<pre><code>with_itmes åµŒå¥—å­å˜é‡
ç¤ºä¾‹
---
- hosts: testweb
  remote_user: root
  tasks:
    - name: add several users
      user: name={{ item.name }} state=present groups={{ item.groups }}
      with_items:
    - { name: 'testuser1' , groups: 'wheel'}
    - { name: 'testuser2' , groups: 'root'}
</code></pre>
<h3 id="playbookå­—å…¸-with_items">Playbookå­—å…¸ with_items</h3>
<pre><code>- name: ä½¿ç”¨ufwæ¨¡å—æ¥ç®¡ç†å“ªäº›ç«¯å£éœ€è¦å¼€å¯
  ufw:
  rule: â€œ{{ item.rule }}â€
  port: â€œ{{ item.port }}â€
  proto: â€œ{{ item.proto }}â€
  with_items:
    - { rule: 'allow', port: 22, proto: 'tcp' }
    - { rule: 'allow', port: 80, proto: 'tcp' }
    - { rule: 'allow', port: 123, proto: 'udp' }

- name: é…ç½®ç½‘ç»œè¿›å‡ºæ–¹å‘çš„é»˜è®¤è§„åˆ™
  ufw:
  direction: &quot;{{ item.direction }}&quot;
  policy: &quot;{{ item.policy }}&quot;
  state: enabled
  with_items:
    - { direction: outgoing, policy: allow }
    - { direction: incoming, policy: deny }
</code></pre>
<h3 id="playbookä¸­template-for-if-whenå¾ªç¯">Playbookä¸­template for if  whenå¾ªç¯</h3>
<pre><code>{% for vhost in nginx_vhosts %}

server {    #é‡å¤æ‰§è¡Œserverä»£ç 
listen {{ vhost.listen | default('80 default_server') }};

{% if vhost.server_name is defined %}
server_name {{ vhost.server_name }};
{% endif %}

{% if vhost.root is defined %}
root {{ vhost.root }};
{% endif %}

{% endfor %}
</code></pre>
<h3 id="ç¤ºä¾‹-5">ç¤ºä¾‹</h3>
<pre><code>// temnginx.yml
---
- hosts: testweb
  remote_user: root
  vars:      # è°ƒç”¨å˜é‡
    nginx_vhosts:
      - listen: 8080  #åˆ—è¡¨ é”®å€¼å¯¹


//templates/nginx.conf.j2
{% for vhost in nginx_vhosts %}  
server {
  listen {{ vhost.listen }}
}
{% endfor %}

ç”Ÿæˆçš„ç»“æœ
server {
  listen 8080
}
</code></pre>
<h3 id="ç¤ºä¾‹-6">ç¤ºä¾‹</h3>
<pre><code>// temnginx.yml
---
- hosts: ansibleweb
  remote_user: root
  vars:
    nginx_vhosts:
      - web1
      - web2
      - web3
  tasks:
    - name: template config
      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

// templates/nginx.conf.j2
{% for vhost in nginx_vhosts %}
server {
    listen {{ vhost }}
}
{% endfor %}

ç”Ÿæˆçš„ç»“æœï¼š
server {
    listen web1
}
server {
    listen web2
}
server {
    listen web3
}
</code></pre>
<h3 id="roles">roles</h3>
<pre><code>roles
    ansibleè‡ª1.2ç‰ˆæœ¬å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œç”¨äºå±‚æ¬¡æ€§ã€ç»“æ„åŒ–åœ°ç»„ç»‡playbookã€‚
    rolesèƒ½å¤Ÿæ ¹æ®å±‚æ¬¡å‹ç»“æ„è‡ªåŠ¨è£…è½½å˜é‡æ–‡ä»¶ã€tasksä»¥åŠhandlersç­‰ã€‚
    è¦ä½¿ç”¨rolesåªéœ€è¦åœ¨playbookä¸­ä½¿ç”¨includeæŒ‡ä»¤å³å¯ã€‚
    ç®€å•æ¥è®²ï¼Œroleså°±æ˜¯é€šè¿‡åˆ†åˆ«å°†å˜é‡ã€æ–‡ä»¶ã€ä»»åŠ¡ã€æ¨¡æ¿åŠå¤„ç†å™¨æ”¾ç½®äºå•ç‹¬çš„ç›®å½•ä¸­ï¼Œ
    å¹¶å¯ä»¥ä¾¿æ·åœ°includeå®ƒä»¬çš„ä¸€ç§æœºåˆ¶ã€‚
    è§’è‰²ä¸€èˆ¬ç”¨äºåŸºäºä¸»æœºæ„å»ºæœåŠ¡çš„åœºæ™¯ä¸­ï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯ç”¨äºæ„å»ºå®ˆæŠ¤è¿›ç¨‹ç­‰åœºæ™¯ä¸­

å¤æ‚åœºæ™¯ï¼šå»ºè®®ä½¿ç”¨rolesï¼Œä»£ç å¤ç”¨åº¦é«˜
    å˜æ›´æŒ‡å®šä¸»æœºæˆ–ä¸»æœºç»„
    å¦‚å‘½åä¸è§„èŒƒç»´æŠ¤å’Œä¼ æ‰¿æˆæœ¬å¤§
    æŸäº›åŠŸèƒ½éœ€å¤šä¸ªPlaybookï¼Œé€šè¿‡includeså³å¯å®ç°
</code></pre>
<h3 id="roles-2">Roles</h3>
<pre><code>è§’è‰²(roles)ï¼šè§’è‰²é›†åˆ
roles/
    mysql/
    httpd/
    nginx/
    memcached/
    
å¯ä»¥äº’ç›¸è°ƒç”¨
</code></pre>
<h3 id="ansible-rolesç›®å½•ç¼–æ’">Ansible Rolesç›®å½•ç¼–æ’</h3>
<figure data-type="image" tabindex="9"><img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302012051.png" alt="" loading="lazy"></figure>
<h3 id="rolesç›®å½•ç»“æ„">rolesç›®å½•ç»“æ„</h3>
<pre><code>æ¯ä¸ªè§’è‰²ï¼Œä»¥ç‰¹å®šçš„å±‚çº§ç›®å½•ç»“æ„è¿›è¡Œç»„ç»‡
rolesç›®å½•ç»“æ„ï¼š

playbook.yml  è°ƒç”¨è§’è‰²
roles/
  project/ (è§’è‰²åç§°)
    tasks/
    files/
    vars/
    templates/
    handlers/
    default/ ä¸å¸¸ç”¨
    meta/    ä¸å¸¸ç”¨
</code></pre>
<h3 id="roleså„ç›®å½•ä½œç”¨">Roleså„ç›®å½•ä½œç”¨</h3>
<pre><code>/roles/project/ :é¡¹ç›®åç§°,æœ‰ä»¥ä¸‹å­ç›®å½•
    files/ ï¼šå­˜æ”¾ç”±copyæˆ–scriptæ¨¡å—ç­‰è°ƒç”¨çš„æ–‡ä»¶
    templates/ï¼štemplateæ¨¡å—æŸ¥æ‰¾æ‰€éœ€è¦æ¨¡æ¿æ–‡ä»¶çš„ç›®å½•
    tasks/ï¼šå®šä¹‰task,roleçš„åŸºæœ¬å…ƒç´ ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›
            å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«
    handlers/ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›
               å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«
    vars/ï¼šå®šä¹‰å˜é‡ï¼Œè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼›
           å…¶å®ƒçš„æ–‡ä»¶éœ€è¦åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«
    meta/ï¼šå®šä¹‰å½“å‰è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»,è‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œ
           å…¶å®ƒæ–‡ä»¶éœ€åœ¨æ­¤æ–‡ä»¶ä¸­é€šè¿‡includeè¿›è¡ŒåŒ…å«
    default/ï¼šè®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ä¸­çš„main.ymlæ–‡ä»¶
    
roles/appname ç›®å½•ç»“æ„
    tasksç›®å½•ï¼šè‡³å°‘åº”è¯¥åŒ…å«ä¸€ä¸ªåä¸ºmain.ymlçš„æ–‡ä»¶ï¼Œå…¶å®šä¹‰äº†æ­¤è§’è‰²çš„ä»»åŠ¡åˆ—è¡¨ï¼›
               æ­¤æ–‡ä»¶å¯ä»¥ä½¿ç”¨includeåŒ…å«å…¶å®ƒçš„ä½äºæ­¤ç›®å½•ä¸­çš„taskæ–‡ä»¶
    filesç›®å½•ï¼šå­˜æ”¾ç”±copyæˆ–scriptç­‰æ¨¡å—è°ƒç”¨çš„æ–‡ä»¶ï¼›
    templatesç›®å½•ï¼štemplateæ¨¡å—ä¼šè‡ªåŠ¨åœ¨æ­¤ç›®å½•ä¸­å¯»æ‰¾Jinja2æ¨¡æ¿æ–‡ä»¶
    handlersç›®å½•ï¼šæ­¤ç›®å½•ä¸­åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å„handlerï¼›
                  åœ¨handlerä¸­ä½¿ç”¨includeåŒ…å«çš„å…¶å®ƒçš„handleræ–‡ä»¶ä¹Ÿåº”è¯¥ä½äºæ­¤ç›®å½•ä¸­ï¼›
    varsç›®å½•ï¼šåº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²ç”¨åˆ°çš„å˜é‡ï¼›
    metaç›®å½•ï¼šåº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶ï¼Œç”¨äºå®šä¹‰æ­¤è§’è‰²çš„ç‰¹æ®Šè®¾å®šåŠå…¶ä¾èµ–å…³ç³»ï¼›
              ansible1.3åŠå…¶ä»¥åçš„ç‰ˆæœ¬æ‰æ”¯æŒï¼›
    defaultç›®å½•ï¼šä¸ºå½“å‰è§’è‰²è®¾å®šé»˜è®¤å˜é‡æ—¶ä½¿ç”¨æ­¤ç›®å½•ï¼›åº”å½“åŒ…å«ä¸€ä¸ªmain.ymlæ–‡ä»¶

roles/example_role/files/             æ‰€æœ‰æ–‡ä»¶ï¼Œéƒ½å°†å¯å­˜æ”¾åœ¨è¿™é‡Œ
roles/example_role/templates/         æ‰€æœ‰æ¨¡æ¿éƒ½å­˜æ”¾åœ¨è¿™é‡Œ
roles/example_role/tasks/main.ymlï¼š   ä¸»å‡½æ•°ï¼ŒåŒ…æ‹¬åœ¨å…¶ä¸­çš„æ‰€æœ‰ä»»åŠ¡å°†è¢«æ‰§è¡Œ
roles/example_role/handlers/main.ymlï¼šæ‰€æœ‰åŒ…æ‹¬å…¶ä¸­çš„ handlers å°†è¢«æ‰§è¡Œ
roles/example_role/vars/main.ymlï¼š    æ‰€æœ‰åŒ…æ‹¬åœ¨å…¶ä¸­çš„å˜é‡å°†åœ¨rolesä¸­ç”Ÿæ•ˆ
roles/example_role/meta/main.ymlï¼š    rolesæ‰€æœ‰ä¾èµ–å°†è¢«æ­£å¸¸ç™»å…¥

</code></pre>
<h3 id="åˆ›å»ºrole">åˆ›å»ºrole</h3>
<pre><code>åˆ›å»ºroleçš„æ­¥éª¤
(1) åˆ›å»ºä»¥roleså‘½åçš„ç›®å½•
(2) åœ¨rolesç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºä»¥å„è§’è‰²åç§°å‘½åçš„ç›®å½•ï¼Œå¦‚webserversç­‰
(3) åœ¨æ¯ä¸ªè§’è‰²å‘½åçš„ç›®å½•ä¸­åˆ†åˆ«åˆ›å»ºfilesã€handlersã€metaã€tasksã€templateså’Œvarsç›®å½•ï¼›
    ç”¨ä¸åˆ°çš„ç›®å½•å¯ä»¥åˆ›å»ºä¸ºç©ºç›®å½•ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»º
(4) åœ¨playbookæ–‡ä»¶ä¸­ï¼Œè°ƒç”¨å„è§’è‰²
</code></pre>
<h3 id="å®éªŒ-åˆ›å»ºhttpdè§’è‰²">å®éªŒ: åˆ›å»ºhttpdè§’è‰²</h3>
<pre><code>1&gt; åˆ›å»ºrolesç›®å½•
   mkdir roles/{httpd,mysql,redis}/tasks -pv
   mkdir  roles/httpd/{handlers,files}

æŸ¥çœ‹ç›®å½•ç»“æ„
tree roles/
    roles/
    â”œâ”€â”€ httpd
    â”‚   â”œâ”€â”€ files
    â”‚   â”œâ”€â”€ handlers
    â”‚   â””â”€â”€ tasks
    â”œâ”€â”€ mysql
    â”‚   â””â”€â”€ tasks
    â””â”€â”€ redis
        â””â”€â”€ tasks

2&gt; åˆ›å»ºç›®æ ‡æ–‡ä»¶
   cd roles/httpd/tasks/
   touch install.yml config.yml service.yml

3&gt; vim install.yml
   - name: install httpd package
     yum: name=httpd
     
   vim config.yml
   - name: config file  
     copy: src=httpd.conf dest=/etc/httpd/conf/ backup=yes 
   
   vim service.yml
   - name: start service 
     service: name=httpd state=started enabled=yes
     
4&gt; åˆ›å»ºmain.ymlä¸»æ§æ–‡ä»¶,è°ƒç”¨ä»¥ä¸Šå•ç‹¬çš„ymlæ–‡ä»¶,
   main.ymlå®šä¹‰äº†è°å…ˆæ‰§è¡Œè°åæ‰§è¡Œçš„é¡ºåº
   vim main.yml
   - include: install.yml
   - include: config.yml
   - include: service.yml
   
5&gt; å‡†å¤‡httpd.confæ–‡ä»¶,æ”¾åˆ°httpdå•ç‹¬çš„æ–‡ä»¶ç›®å½•ä¸‹
   cp /app/ansible/flies/httpd.conf ../files/
   
6&gt; åˆ›å»ºä¸€ä¸ªç½‘é¡µ
   vim flies/index.html
   &lt;h1&gt; welcome to weixiaodong home &lt;\h1&gt;

7&gt; åˆ›å»ºç½‘é¡µçš„ymlæ–‡ä»¶
   vim tasks/index.yml
   - name: index.html
     copy: src=index.html dest=/var/www/html 

8&gt; å°†ç½‘é¡µçš„ymlæ–‡ä»¶å†™è¿›mian.ymlæ–‡ä»¶ä¸­
   vim mian.yml
   - include: install.yml
   - include: config.yml
   - include: index.yml
   - include: service.yml

9&gt; åœ¨handlersç›®å½•ä¸‹åˆ›å»ºhandleræ–‡ä»¶mian.yml
   vim handlers/main.yml
   - name: restart service httpd
     service: name=httpd state=restarted

10&gt; åˆ›å»ºæ–‡ä»¶è°ƒç”¨httpdè§’è‰²
    cd /app/ansidle/roles
    vim role_httpd.yml
    ---
    # httpd role
    - hosts: appsrvs
      remote_user: root 

      roles:       #è°ƒç”¨è§’è‰²
        - role: httpd  
        
11&gt; æŸ¥çœ‹ç›®å½•ç»“æ„
    tree 
    .
    httpd
    â”œâ”€â”€ files
    â”‚   â”œâ”€â”€ httpd.conf
    â”‚   â””â”€â”€ index.html
    â”œâ”€â”€ handlers
    â”‚   â””â”€â”€ main.yml
    â””â”€â”€ tasks
        â”œâ”€â”€ config.yml
        â”œâ”€â”€ index.yml
        â”œâ”€â”€ install.yml
        â”œâ”€â”€ main.yml
        â””â”€â”€ service.yml

12&gt; ansible-playbook role_httpd.yml
</code></pre>
<h3 id="é’ˆå¯¹å¤§å‹é¡¹ç›®ä½¿ç”¨rolesè¿›è¡Œç¼–æ’">é’ˆå¯¹å¤§å‹é¡¹ç›®ä½¿ç”¨Rolesè¿›è¡Œç¼–æ’</h3>
<pre><code>rolesç›®å½•ç»“æ„ï¼š
playbook.yml
roles/
  project/
    tasks/
    files/
    vars/
    templates/
    handlers/
    default/ # ä¸ç»å¸¸ç”¨
    meta/    # ä¸ç»å¸¸ç”¨

ç¤ºä¾‹ï¼š
nginx-role.yml
roles/
â””â”€â”€ nginx
    â”œâ”€â”€ files
    â”‚ â””â”€â”€ main.yml
    â”œâ”€â”€ tasks
    â”‚ â”œâ”€â”€ groupadd.yml
    â”‚ â”œâ”€â”€ install.yml
    â”‚ â”œâ”€â”€ main.yml
    â”‚ â”œâ”€â”€ restart.yml
    â”‚ â””â”€â”€ useradd.yml
    â””â”€â”€ vars
        â””â”€â”€ main.yml
</code></pre>
<h3 id="ç¤ºä¾‹-7">ç¤ºä¾‹</h3>
<pre><code>rolesçš„ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š
site.yml
webservers.yml
dbservers.yml
roles/
  common/
    files/
    templates/
    tasks/
    handlers/
    vars/
    meta/
  webservers/
    files/
    templates/
    tasks/
  handlers/
    vars/
    meta/
</code></pre>
<h3 id="å®éªŒ-åˆ›å»ºä¸€ä¸ªnginxè§’è‰²">å®éªŒï¼š åˆ›å»ºä¸€ä¸ªnginxè§’è‰²</h3>
<pre><code>å»ºç«‹nginxè§’è‰²åœ¨å¤šå°ä¸»æœºä¸Šæ¥éƒ¨ç½²nginxéœ€è¦å®‰è£… åˆ›å»ºè´¦å·
1&gt; åˆ›å»ºnginxè§’è‰²ç›®å½•
     cd /app/ansible/role
     mkdir nginx{tesks,templates,hanslers} -pv

2&gt; åˆ›å»ºä»»åŠ¡ç›®å½•
     cd tasks/
     touch insatll.yml config.yml service.yml file.yml user.yml
   åˆ›å»ºmain.ymlæ–‡ä»¶å®šä¹‰ä»»åŠ¡æ‰§è¡Œé¡ºåº
     vim main.yml
     - include: user.yml
     - include: insatll.yml
     - include: config.yml
     - include: file.yml
     - include: service.yml

  
3&gt; å‡†å¤‡é…ç½®æ–‡ä»¶(centos7ã€8)
   ll /app/ansible/role/nginx/templates/
   nginx7.conf.j2
   nginx8.conf.j2


4&gt; å®šä¹‰ä»»åŠ¡
   vim tasks/install.yml
   - name: install
     yum: name=nginx
     
   vim tasks/config.yml
    - name: config file
      template: src=nginx7.conf.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version==&quot;7&quot;
      notify: restrat
      
    - name: config file
      template: src=nginx8.conf.j2 dest=/etc/nginx/nginx.conf
      when: ansible_distribution_major_version==&quot;8&quot;
      notify: restrat
      
    vim tasks/file.yml   è·¨è§’è‰²è°ƒç”¨file.yumæ–‡ä»¶,å®ç°æ–‡ä»¶å¤ç”¨
    - name: index.html
      copy: src=roles/httpd/files/index.html dest=/usr/share/nginx/html/ 
   
    vim tasks/service.yml
    - nmae: start service
      service: name=nginx state=started enabled=yes
      
    vim handlers/main.yml
    - name: restrat
      service: name=nginx state=restarted
      
    vim roles/role_nginix.yml
    --- 
    #test rcle
    - hosts: appsrvs
    
      roles: 
        - role: nginx
        
5&gt; æµ‹è¯•å®‰è£…
   ansible-playbook role_nginx.yml
</code></pre>
<h3 id="rolesæ¡ˆä¾‹">Rolesæ¡ˆä¾‹</h3>
<p>Rolesç›®å½•ç¼–æ’<br>
<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302012146.png" alt="" loading="lazy"><br>
Playbookä¸­è°ƒç”¨<br>
<img src="https://raw.githubusercontent.com/OrochW/picGo/master/20230302012156.png" alt="" loading="lazy"></p>
<h3 id="playbookè°ƒç”¨è§’è‰²">playbookè°ƒç”¨è§’è‰²</h3>
<pre><code>è°ƒç”¨è§’è‰²æ–¹æ³•1ï¼š
- hosts: websrvs
  remote_user: root
  
  roles:
    - mysql
    - memcached
    - nginx
    
è°ƒç”¨è§’è‰²æ–¹æ³•2ï¼š
ä¼ é€’å˜é‡ç»™è§’è‰²
- hosts:
  remote_user:
  roles:
    - mysql
    - { role: nginx, username: nginx }   #ä¸åŒçš„è§’è‰²è°ƒç”¨ä¸åŒçš„å˜é‡  
    é”®roleç”¨äºæŒ‡å®šè§’è‰²åç§°
    åç»­çš„k/vç”¨äºä¼ é€’å˜é‡ç»™è§’è‰²

è°ƒç”¨è§’è‰²æ–¹æ³•3ï¼šè¿˜å¯åŸºäºæ¡ä»¶æµ‹è¯•å®ç°è§’è‰²è°ƒç”¨
roles:
  - { role: nginx, username: nginx, when: ansible_distribution_major_version == '7' }
</code></pre>
<h3 id="é€šè¿‡rolesä¼ é€’å˜é‡">é€šè¿‡rolesä¼ é€’å˜é‡</h3>
<pre><code>é€šè¿‡rolesä¼ é€’å˜é‡
å½“ç»™ä¸€ä¸ªä¸»æœºåº”ç”¨è§’è‰²çš„æ—¶å€™å¯ä»¥ä¼ é€’å˜é‡ï¼Œç„¶ååœ¨è§’è‰²å†…ä½¿ç”¨è¿™äº›å˜é‡
ç¤ºä¾‹ï¼š
- hosts: webservers
  roles:
    - common
    - { role: foo_app_instance, dir: '/web/htdocs/a.com', port: 8080 }
</code></pre>
<h3 id="å‘rolesä¼ é€’å‚æ•°">å‘rolesä¼ é€’å‚æ•°</h3>
<pre><code>è€Œåœ¨playbookä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨rolesï¼š
---
- hosts: webservers
  roles:
    - common
    - webservers

ä¹Ÿå¯ä»¥å‘rolesä¼ é€’å‚æ•°
ç¤ºä¾‹ï¼š
---
- hosts: webservers
  roles:
    - common
    - { role: foo_app_instance, dir: '/opt/a', port: 5000 }
    - { role: foo_app_instance, dir: '/opt/b', port: 5001 }
</code></pre>
<h3 id="æ¡ä»¶å¼åœ°ä½¿ç”¨roles">æ¡ä»¶å¼åœ°ä½¿ç”¨roles</h3>
<pre><code>ç”šè‡³ä¹Ÿå¯ä»¥æ¡ä»¶å¼åœ°ä½¿ç”¨roles
ç¤ºä¾‹ï¼š
---
- hosts: webservers
  roles:
    - { role: some_role, when: &quot;ansible_os_family == 'RedHat'&quot; }
</code></pre>
<h3 id="rolesæ¡ä»¶åŠå˜é‡ç­‰æ¡ˆä¾‹">Rolesæ¡ä»¶åŠå˜é‡ç­‰æ¡ˆä¾‹</h3>
<pre><code>Whenæ¡ä»¶
    roles:
      - {role: nginx, when: &quot;ansible_distribution_major_version == '7' &quot; ,username: nginx }
å˜é‡è°ƒç”¨
- hosts: zabbix-proxy
  sudo: yes
  roles:
    - { role: geerlingguy.php-mysql }
    - { role: dj-wasabi.zabbix-proxy, zabbix_server_host: 192.168.37.167 }
</code></pre>
<h3 id="å®Œæ•´çš„rolesæ¶æ„">å®Œæ•´çš„rolesæ¶æ„</h3>
<pre><code>// nginx-role.yml é¡¶å±‚ä»»åŠ¡è°ƒç”¨ymlæ–‡ä»¶
---
- hosts: testweb
  remote_user: root
  roles:
    - role: nginx
    - role: httpd å¯æ‰§è¡Œå¤šä¸ªrole

cat roles/nginx/tasks/main.yml
---
- include: groupadd.yml
- include: useradd.yml
- include: install.yml
- include: restart.yml
- include: filecp.yml

// roles/nginx/tasks/groupadd.yml
---
- name: add group nginx
  user: name=nginx state=present

cat roles/nginx/tasks/filecp.yml
---
- name: file copy
  copy: src=tom.conf dest=/tmp/tom.conf

ä»¥ä¸‹æ–‡ä»¶æ ¼å¼ç±»ä¼¼ï¼š
useradd.yml,install.yml,restart.yml

ls roles/nginx/files/
tom.conf
</code></pre>
<h3 id="roles-playbook-tagsä½¿ç”¨">roles playbook tagsä½¿ç”¨</h3>
<pre><code>roles playbook tagsä½¿ç”¨
    ansible-playbook --tags=&quot;nginx,httpd,mysql&quot; nginx-role.yml  å¯¹æ ‡ç­¾è¿›è¡ŒæŒ‘é€‰æ‰§è¡Œ

// nginx-role.yml
---
- hosts: testweb
  remote_user: root
  roles:
    - { role: nginx ,tags: [ 'nginx', 'web' ] ,when: ansible_distribution_major_version == &quot;6â€œ }
    - { role: httpd ,tags: [ 'httpd', 'web' ] }
    - { role: mysql ,tags: [ 'mysql', 'db' ] }
    - { role: marridb ,tags: [ 'mysql', 'db' ] }
    - { role: php }
</code></pre>
<h3 id="å®éªŒ-åˆ›å»ºè§’è‰²memcached">å®éªŒ: åˆ›å»ºè§’è‰²memcached</h3>
<pre><code>memcacched å½“åšç¼“å­˜ç”¨,ä¼šåœ¨å†…å­˜ä¸­å¼€å¯ä¸€å—ç©ºé—´å……å½“ç¼“å­˜
cat /etc/sysconfig/memcached 
    PORT=&quot;11211&quot;
    USER=&quot;memcached&quot;
    MAXCONN=&quot;1024&quot;
    CACHESIZE=&quot;64&quot;    # ç¼“å­˜ç©ºé—´é»˜è®¤64M 
    OPTIONS=&quot;&quot;


1&gt; åˆ›å»ºå¯¹ç”¨ç›®å½•
   cd /app/ansible
   mkdir roles/memcached/{tasks,templates} -pv
   
2&gt; æ‹·è´memcachedé…ç½®æ–‡ä»¶æ¨¡æ¿
   cp /etc/sysconfig/memcached  templates/memcached.j2
   vim templates/memcached.j2
   CACHESIZE=&quot;{{ansible_memtotal_mb//4}}&quot;   #ç‰©ç†å†…å­˜çš„1/4ç”¨åšç¼“å­˜
   
3&gt; åˆ›å»ºå¯¹åº”ymlæ–‡ä»¶,å¹¶åšç›¸åº”é…ç½®
   cd tasks/
   touch install.yml config.yml service.yml
   åˆ›å»ºmain.ymlæ–‡ä»¶å®šä¹‰ä»»åŠ¡æ‰§è¡Œé¡ºåº
   vim main.yml
   - include: install.yml
   - include: config.yml
   - include: service.yml  
   
   vim install.yml
   - name: install 
     yum: name=memcached
     
   vim config.yml
   - name: config file
     template: src=memcached.j2 dets=/etc/sysconfig/memcached

   vim service.yml
   - name: service
     service: name=memcached state=started enabled=yes

4&gt; åˆ›å»ºè°ƒç”¨è§’è‰²æ–‡ä»¶
   cd /app/ansible/roles/
   vim role_memcached.yml
    ---
    - hosts: appsrvs
    
      roles: 
        - role: memcached

5&gt; å®‰è£…
   ansible-playbook  role_memcached.yml 
   memcachedç«¯å£å·11211
</code></pre>
<h3 id="å…¶å®ƒåŠŸèƒ½">å…¶å®ƒåŠŸèƒ½</h3>
<pre><code>å§”ä»»ï¼ˆæŒ‡å®šæŸä¸€å°æœºå™¨åšæŸä¸€ä¸ªtaskï¼‰
    delegate_to
    local_action (ä¸“æŒ‡é’ˆå¯¹ansibleå‘½ä»¤æ‰§è¡Œçš„æœºå™¨åšçš„å˜æ›´æ“ä½œ)
äº¤äº’æç¤º
    prompt
*æš‚åœï¼ˆjavaï¼‰
    wait_for
Debug
    debug: msg=&quot;This always executes.&quot;
Include
Template å¤šå€¼åˆå¹¶
Template åŠ¨æ€å˜é‡é…ç½®
</code></pre>
<h3 id="ansible-roles">Ansible Roles</h3>
<pre><code>å§”ä»»
    delegate_to
äº¤äº’æç¤º
    prompt
æš‚åœ
    wait_for
Debug
    debug: msg=&quot;This always executes.&quot;
Include
Template å¤šå€¼åˆå¹¶
Template åŠ¨æ€å˜é‡é…ç½®
</code></pre>
<h3 id="æ¨èèµ„æ–™">æ¨èèµ„æ–™</h3>
<pre><code>http://galaxy.ansible.com
https://galaxy.ansible.com/explore#/
http://github.com/
http://ansible.com.cn/
https://github.com/ansible/ansible
https://github.com/ansible/ansible-examples
</code></pre>
<h3 id="å®éªŒ-å®ç°äºŒè¿›åˆ¶å®‰è£…mysqlçš„å¸è½½">å®éªŒ: å®ç°äºŒè¿›åˆ¶å®‰è£…mysqlçš„å¸è½½</h3>
<pre><code>cat remove_mysql.yml 
---
# install mariadb server 
- hosts: appsrvs:!192.168.38.108
  remote_user: root

  tasks:
    - name: stop service 
      shell: /etc/init.d/mysqld stop
    - name: delete user 
      user: name=mysql state=absent remove=yes
    - name: delete
      file: path={{item}} state=absent
      with_items: 
        - /usr/local/mysql
        - /usr/local/mariadb-10.2.27-linux-x86_64
        - /etc/init.d/mysqld
        - /etc/profile.d/mysql.sh
        - /etc/my.cnf
        - /data/mysql

ansible-playbook  remove_mysql.yml
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[k8s centos7ç³»ç»Ÿåˆå§‹åŒ–]]></title>
        <id>https://orochw.github.io/post/k8s-centos7-xi-tong-chu-shi-hua/</id>
        <link href="https://orochw.github.io/post/k8s-centos7-xi-tong-chu-shi-hua/">
        </link>
        <updated>2023-02-23T08:32:51.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1è®¾ç½®ç³»ç»Ÿä¸»æœºåä»¥åŠ-host-æ–‡ä»¶çš„ç›¸äº’è§£æ">1.è®¾ç½®ç³»ç»Ÿä¸»æœºåä»¥åŠ Host æ–‡ä»¶çš„ç›¸äº’è§£æ</h2>
<pre><code class="language-bash">hostnamectl  set-hostname  k8s-master01
</code></pre>
<h2 id="2å®‰è£…ä¾èµ–åŒ…">2.å®‰è£…ä¾èµ–åŒ…</h2>
<pre><code class="language-bash">yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptables curl sysstat libseccomp wgetvimnet-tools git
</code></pre>
<h2 id="3è®¾ç½®é˜²ç«å¢™ä¸º-iptables-å¹¶è®¾ç½®ç©ºè§„åˆ™">3.è®¾ç½®é˜²ç«å¢™ä¸º Iptables å¹¶è®¾ç½®ç©ºè§„åˆ™</h2>
<pre><code class="language-bash">systemctl  stop firewalld  &amp;&amp;  systemctl  disable firewalldyum -y install iptables-services  &amp;&amp;  systemctl  start iptables  &amp;&amp;  systemctl  enable iptables&amp;&amp;  iptables -F  &amp;&amp;  service iptables save
</code></pre>
<h2 id="4å…³é—­-selinux">4.å…³é—­ SELINUX</h2>
<pre><code class="language-bash">swapoff -a &amp;&amp; sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstabsetenforce 0 &amp;&amp; sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
</code></pre>
<h2 id="5è°ƒæ•´å†…æ ¸å‚æ•°å¯¹äº-k8s">5.è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº K8S</h2>
<pre><code class="language-bash">cat &gt; kubernetes.conf &lt;&lt;EOF
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
net.ipv4.ip_forward=1
net.ipv4.tcp_tw_recycle=0
vm.swappiness=0 # ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ
vm.overcommit_memory=1 # ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨
vm.panic_on_oom=0 # å¼€å¯ OOM
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576
fs.file-max=52706963fs.nr_open=52706963
net.ipv6.conf.all.disable_ipv6=1
net.netfilter.nf_conntrack_max=2310720
EOF
cp kubernetes.conf  /etc/sysctl.d/kubernetes.conf
sysctl -p /etc/sysctl.d/kubernetes.conf
</code></pre>
<h2 id="6è°ƒæ•´ç³»ç»Ÿæ—¶åŒº">6.è°ƒæ•´ç³»ç»Ÿæ—¶åŒº</h2>
<h1 id="è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸ºä¸­å›½ä¸Šæµ·">è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸ºä¸­å›½/ä¸Šæµ·</h1>
<pre><code class="language-bash">timedatectl set-timezone Asia/Shanghai
</code></pre>
<h2 id="7å°†å½“å‰çš„-utc-æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ">7.å°†å½“å‰çš„ UTC æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ</h2>
<pre><code class="language-bash">timedatectl set-local-rtc 0
</code></pre>
<h2 id="8é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡">8.é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡</h2>
<pre><code class="language-bash">systemctl restart rsyslog
systemctl restart crond
</code></pre>
<h2 id="9å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡">9.å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡</h2>
<pre><code>systemctl stop postfix &amp;&amp; systemctl disable postfix
</code></pre>
<h2 id="10è®¾ç½®-rsyslogd-å’Œ-systemd-journald">10.è®¾ç½® rsyslogd å’Œ systemd journald</h2>
<pre><code>mkdir /var/log/journal 
</code></pre>
<h2 id="11æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•">11.æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•</h2>
<pre><code class="language-bash">mkdir /etc/systemd/journald.conf.d
cat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF
[Journal]
# æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜Storage=persistent
# å‹ç¼©å†å²æ—¥å¿—Compress=yesSyncIntervalSec=5m
RateLimitInterval=30sRateLimitBurst=1000
# æœ€å¤§å ç”¨ç©ºé—´ 10GSystemMaxUse=10G
# å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200MSystemMaxFileSize=200M
# æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨MaxRetentionSec=2week
# ä¸å°†æ—¥å¿—è½¬å‘åˆ° 
syslogForwardToSyslog=no
EOF
systemctl restart systemd-journald
</code></pre>
<h2 id="12å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º-444">12.å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º 4.44</h2>
<p>å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º 4.44CentOS 7.x ç³»ç»Ÿè‡ªå¸¦çš„ 3.10.x å†…æ ¸å­˜åœ¨ä¸€äº› Bugsï¼Œå¯¼è‡´è¿è¡Œçš„ Dockerã€Kubernetes ä¸ç¨³å®šï¼Œä¾‹å¦‚ï¼š rpm -Uvh<br>
http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm</p>
<pre><code class="language-bash">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
</code></pre>
<p>å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</p>
<pre><code class="language-bash">yum --enablerepo=elrepo-kernel install -y kernel-lt
</code></pre>
<p>è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</p>
<pre><code class="language-bash">grub2-set-default 'CentOS Linux (4.4.189-1.el7.elrepo.x86_64) 7 (Core)'
</code></pre>
]]></content>
    </entry>
</feed>