<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œ | OrochW&#39;s Blog</title>
<link rel="shortcut icon" href="https://orochw.github.io/favicon.ico?v=1757257179686">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://orochw.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œ | OrochW&#39;s Blog - Atom Feed" href="https://orochw.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-133741629-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-133741629-1');
</script>


    <meta name="description" content="ğŸ“š Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œï¼ˆçœŸå®éªŒè¯ç‰ˆï¼‰

å‘½åç©ºé—´ï¼šcka | ç‰ˆæœ¬ï¼šv9.0ï¼ˆå«çœŸå®å‘½ä»¤éªŒè¯ï¼‰


1ï¸âƒ£ ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼•è¨€
æœ¬æ–‡æ¡£è®°å½•äº†åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œä½¿ç”¨åŸå§‹é…ç½®æ–‡ä»¶ï¼ˆp..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://orochw.github.io">
  <img class="avatar" src="https://orochw.github.io/images/avatar.png?v=1757257179686" alt="">
  </a>
  <h1 class="site-title">
    OrochW&#39;s Blog
  </h1>
  <p class="site-description">
    
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/OrochW" target="_blank">
          <i class="ri-github-line"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œ
            </h2>
            <div class="post-info">
              <span>
                2025-08-13
              </span>
              <span>
                14 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="kubernetes-redis-4014-é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†ŒçœŸå®éªŒè¯ç‰ˆ">ğŸ“š <strong>Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œï¼ˆçœŸå®éªŒè¯ç‰ˆï¼‰</strong></h1>
<blockquote>
<p><strong>å‘½åç©ºé—´ï¼šcka</strong> | ç‰ˆæœ¬ï¼šv9.0ï¼ˆå«çœŸå®å‘½ä»¤éªŒè¯ï¼‰</p>
</blockquote>
<hr>
<h2 id="1ï¸âƒ£-ç¬¬ä¸€éƒ¨åˆ†å¼•è¨€">1ï¸âƒ£ ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼•è¨€</h2>
<p>æœ¬æ–‡æ¡£è®°å½•äº†åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œ<strong>ä½¿ç”¨åŸå§‹é…ç½®æ–‡ä»¶</strong>ï¼ˆ<code>pv</code>ã€<code>redis.conf</code>ã€<code>redis-cluster.yaml</code>ï¼‰éƒ¨ç½² Redis 4.0.14 é›†ç¾¤çš„å…¨è¿‡ç¨‹ã€‚</p>
<p>é‡ç‚¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>redis.conf</code> åˆ›å»º ConfigMap</li>
<li>æŒ‚è½½é…ç½®åˆ° Redis Pod</li>
<li>é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼š<code>redis:4.0.14</code> å®˜æ–¹é•œåƒä¸æ”¯æŒ <code>redis-cli --cluster</code></li>
<li>æ’é”™éªŒè¯ä¸æœ€ç»ˆè§£å†³æ–¹æ¡ˆ</li>
<li>ä¸€é”®åˆå§‹åŒ–è„šæœ¬</li>
</ul>
<p>æ‰€æœ‰æ­¥éª¤å‡åŸºäºçœŸå®å‘½ä»¤éªŒè¯ï¼Œç¡®ä¿å¯å¤ç°ã€‚</p>
<hr>
<h2 id="2ï¸âƒ£-ç¬¬äºŒéƒ¨åˆ†å¼€å§‹éƒ¨ç½²">2ï¸âƒ£ ç¬¬äºŒéƒ¨åˆ†ï¼šå¼€å§‹éƒ¨ç½²</h2>
<h3 id="21-å‡†å¤‡-nfs-å­˜å‚¨åœ¨-nfs-æœåŠ¡å™¨ä¸Šæ‰§è¡Œ">2.1 å‡†å¤‡ NFS å­˜å‚¨ï¼ˆåœ¨ NFS æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰</h3>
<pre><code class="language-bash">mkdir -p /data/k8sdata/cka/redis{0..5}
chmod 777 /data/k8sdata/cka/redis{0..5}
</code></pre>
<hr>
<h3 id="22-åˆ›å»º-persistentvolumepv">2.2 åˆ›å»º PersistentVolumeï¼ˆPVï¼‰</h3>
<blockquote>
<p>âœ… ä½¿åŸå§‹ <code>pv/redis-cluster-pv.yaml</code></p>
</blockquote>
<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv0
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis0

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv1
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis1

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv2
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis2

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv3
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis3

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv4
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis4

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-cluster-pv5
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: 172.31.7.110
    path: /data/k8sdata/cka/redis5
</code></pre>
<h4 id="åº”ç”¨-pv">åº”ç”¨ PVï¼š</h4>
<pre><code class="language-bash">kubectl apply -f pv/redis-cluster-pv.yaml
kubectl get pv
</code></pre>
<blockquote>
<p>âœ… ç¡®è®¤ 6 ä¸ª PV çŠ¶æ€ä¸º <code>Available</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="23-åˆ›å»º-redis-é…ç½®æ–‡ä»¶-redisconf">2.3 åˆ›å»º Redis é…ç½®æ–‡ä»¶ <code>redis.conf</code></h3>
<blockquote>
<p>âœ… ä½¿ç”¨åŸå§‹çš„ <code>redis.conf</code></p>
</blockquote>
<pre><code class="language-conf"># redis.conf
port 6379
bind 0.0.0.0
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
save &quot;&quot;
</code></pre>
<blockquote>
<p>ğŸ’¡ è¯´æ˜ï¼š</p>
<ul>
<li><code>cluster-enabled yes</code>ï¼šå¯ç”¨é›†ç¾¤æ¨¡å¼</li>
<li><code>cluster-config-file nodes.conf</code>ï¼šé›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯æ–‡ä»¶</li>
<li><code>appendonly yes</code>ï¼šå¼€å¯ AOF æŒä¹…åŒ–</li>
<li><code>save &quot;&quot;</code>ï¼šå…³é—­ RDB æŒä¹…åŒ–ï¼Œé¿å…ä¸ AOF å†²çª</li>
</ul>
</blockquote>
<hr>
<h3 id="24-ä»-redisconf-åˆ›å»º-configmap">2.4 ä» <code>redis.conf</code> åˆ›å»º ConfigMap</h3>
<pre><code class="language-bash">kubectl create configmap redis-config \
  --from-file=redis.conf=./redis.conf \
  -n cka
</code></pre>
<blockquote>
<p>âœ… éªŒè¯ ConfigMapï¼š</p>
</blockquote>
<pre><code class="language-bash">kubectl get configmap redis-config -n cka -o yaml
</code></pre>
<hr>
<h3 id="25-éƒ¨ç½²-redis-statefulset-ä¸-serviceå«-configmap-æŒ‚è½½">2.5 éƒ¨ç½² Redis StatefulSet ä¸ Serviceï¼ˆå« ConfigMap æŒ‚è½½ï¼‰</h3>
<blockquote>
<p>âœ… æ›´æ–°åçš„ <code>redis-cluster.yaml</code>ï¼Œ<strong>åŒ…å« ConfigMap æŒ‚è½½</strong></p>
</blockquote>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: cka
  labels:
    app: redis
spec:
  selector:
    app: redis
    appCluster: redis-cluster
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
    - name: cluster
      port: 16379
      targetPort: 16379
  clusterIP: None

---
apiVersion: v1
kind: Service
metadata:
  name: redis-access
  namespace: cka
  labels:
    app: redis
spec:
  selector:
    app: redis
    appCluster: redis-cluster
  ports:
    - name: redis-access
      protocol: TCP
      port: 6379
      targetPort: 6379
  type: ClusterIP

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: cka
spec:
  serviceName: redis
  replicas: 6
  selector:
    matchLabels:
      app: redis
      appCluster: redis-cluster
  template:
    metadata:
      labels:
        app: redis
        appCluster: redis-cluster
    spec:
      terminationGracePeriodSeconds: 20
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - redis
                topologyKey: kubernetes.io/hostname
      containers:
        - name: redis
          image: redis:4.0.14
          command:
            - &quot;redis-server&quot;
          args:
            - &quot;/etc/redis/redis.conf&quot;
          resources:
            requests:
              cpu: &quot;500m&quot;
              memory: &quot;500Mi&quot;
          ports:
            - containerPort: 6379
              name: redis
              protocol: TCP
            - containerPort: 16379
              name: cluster
              protocol: TCP
          volumeMounts:
            - name: conf
              mountPath: /etc/redis
            - name: data
              mountPath: /var/lib/redis
      volumes:
        - name: conf
          configMap:
            name: redis-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ &quot;ReadWriteOnce&quot; ]
        resources:
          requests:
            storage: 5Gi
</code></pre>
<h4 id="åº”ç”¨é…ç½®">åº”ç”¨é…ç½®ï¼š</h4>
<pre><code class="language-bash">kubectl apply -f redis-cluster.yaml
</code></pre>
<hr>
<h3 id="26-ç­‰å¾…-pod-å°±ç»ª">2.6 ç­‰å¾… Pod å°±ç»ª</h3>
<pre><code class="language-bash">kubectl get pods -n cka -o wide -w
</code></pre>
<blockquote>
<p>âœ… ç­‰å¾…æ‰€æœ‰ <code>redis-0</code> åˆ° <code>redis-5</code> çŠ¶æ€å˜ä¸º <code>Running</code>ã€‚</p>
</blockquote>
<hr>
<h2 id="3ï¸âƒ£-ç¬¬ä¸‰éƒ¨åˆ†åˆå§‹åŒ–æŠ¥é”™é¦–æ¬¡å°è¯•">3ï¸âƒ£ ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆå§‹åŒ–æŠ¥é”™ï¼ˆé¦–æ¬¡å°è¯•ï¼‰</h2>
<h3 id="å°è¯•ä½¿ç”¨-redis4014-é•œåƒä¸­çš„-redis-cli-åˆå§‹åŒ–é›†ç¾¤">å°è¯•ä½¿ç”¨ <code>redis:4.0.14</code> é•œåƒä¸­çš„ <code>redis-cli</code> åˆå§‹åŒ–é›†ç¾¤</h3>
<pre><code class="language-bash">kubectl run -it --rm --restart=Never \
  --namespace cka \
  redis-admin \
  --image=redis:4.0.14 \
  -- redis-cli --cluster create \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
    redis-access.cka.svc.cluster.local:6379 \
  --cluster-replicas 1 \
  --cluster-yes
</code></pre>
<h3 id="æŠ¥é”™ä¿¡æ¯">âŒ æŠ¥é”™ä¿¡æ¯ï¼š</h3>
<pre><code>redis-cli: unknown option '--cluster'
</code></pre>
<blockquote>
<p>ğŸ”´ <strong>é”™è¯¯åŸå› </strong>ï¼š<code>redis:4.0.14</code> é•œåƒä¸­çš„ <code>redis-cli</code> <strong>ä¸æ”¯æŒ <code>--cluster</code> å­å‘½ä»¤</strong>ã€‚</p>
</blockquote>
<hr>
<h2 id="4ï¸âƒ£-ç¬¬å››éƒ¨åˆ†æ’é”™ä¸éªŒè¯">4ï¸âƒ£ ç¬¬å››éƒ¨åˆ†ï¼šæ’é”™ä¸éªŒè¯</h2>
<h3 id="æ’é”™-1éªŒè¯-redis4014-æ˜¯å¦æ”¯æŒ-cluster">ğŸ” æ’é”™ 1ï¼šéªŒè¯ <code>redis:4.0.14</code> æ˜¯å¦æ”¯æŒ <code>--cluster</code></h3>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 redis-cli --help | grep cluster
</code></pre>
<blockquote>
<p>ğŸ” <strong>è¾“å‡ºä¸ºç©º</strong></p>
</blockquote>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 redis-cli --cluster help
</code></pre>
<blockquote>
<p>âŒ è¾“å‡ºï¼š</p>
</blockquote>
<pre><code>redis-cli: unknown option '--cluster'
</code></pre>
<blockquote>
<p>âœ… <strong>ç»“è®º</strong>ï¼š<code>redis:4.0.14</code> å®˜æ–¹é•œåƒç¡®å®ä¸æ”¯æŒ <code>--cluster</code>ã€‚</p>
</blockquote>
<hr>
<h3 id="æ’é”™-2å°è¯•ä½¿ç”¨-redis-tribrb">ğŸ” æ’é”™ 2ï¼šå°è¯•ä½¿ç”¨ <code>redis-trib.rb</code></h3>
<pre><code class="language-bash">docker run -it --rm redis:4.0.14 sh -c &quot;ls /usr/local/bin | grep trib&quot;
</code></pre>
<blockquote>
<p>âŒ è¾“å‡ºä¸ºç©ºï¼Œ<code>redis-trib.rb</code> ä¸å­˜åœ¨ã€‚</p>
</blockquote>
<blockquote>
<p>âœ… ç»“è®ºï¼šæ— æ³•ä½¿ç”¨æ—§å·¥å…·ã€‚</p>
</blockquote>
<hr>
<h3 id="è§£å†³æ–¹æ¡ˆä½¿ç”¨é«˜ç‰ˆæœ¬-redis-cliredis626-pod-ip">âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆ<code>redis:6.2.6</code>ï¼‰ + Pod IP</h3>
<h4 id="è·å–-pod-ip">è·å– Pod IPï¼š</h4>
<pre><code>root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl get pod -cka -o wide
NAMESPACE              NAME                                             READY   STATUS    RESTARTS      AGE     IP              NODE           NOMINATED NODE   READINESS GATES
cka                 deploy-devops-redis-6d9fd4dbcb-hbs6q             1/1     Running   0             176m    10.200.45.203   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 cka-nginx-deployment-69db98d5ff-qc7mr         1/1     Running   0             9h      10.200.11.135   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 cka-tomcat-app1-deployment-78c495f67d-6db72   1/1     Running   0             24h     10.200.45.199   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 cka-tomcat-app1-deployment-78c495f67d-xbm5f   1/1     Running   0             24h     10.200.11.134   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 redis-0                                          1/1     Running   0             30m     10.200.210.76   172.31.7.104   &lt;none&gt;           &lt;none&gt;
cka                 redis-1                                          1/1     Running   0             29m     10.200.45.204   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 redis-2                                          1/1     Running   0             24m     10.200.11.136   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 redis-3                                          1/1     Running   0             24m     10.200.210.77   172.31.7.104   &lt;none&gt;           &lt;none&gt;
cka                 redis-4                                          1/1     Running   0             24m     10.200.45.205   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 redis-5                                          1/1     Running   0             24m     10.200.11.137   172.31.7.106   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper1-5666cd8f6f-b7flr                      1/1     Running   0             4h28m   10.200.45.201   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper2-c4964cd66-vsrt6                       1/1     Running   0             4h28m   10.200.45.202   172.31.7.105   &lt;none&gt;           &lt;none&gt;
cka                 zookeeper3-55fc5c6847-xfw9g                      1/1     Running   0             4h28m   10.200.210.75   172.31.7.104   &lt;none&gt;           &lt;none&gt;
</code></pre>
<pre><code class="language-bash">kubectl get pods -n cka -l app=redis -o jsonpath='{range .items[*]}{.status.podIP}{&quot;\n&quot;}{end}'
</code></pre>
<h4 id="ä½¿ç”¨é«˜ç‰ˆæœ¬-redis-cli-åˆå§‹åŒ–">ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code> åˆå§‹åŒ–ï¼š</h4>
<pre><code class="language-bash">kubectl run -it --rm --restart=Never \
  --namespace cka \
  redis-admin \
  --image=redis:6.2.6 \
  -- redis-cli --cluster create \
    10.200.210.76:6379 \
    10.200.45.204:6379 \
    10.200.11.136:6379 \
    10.200.210.77:6379 \
    10.200.45.205:6379 \
    10.200.11.137:6379 \
  --cluster-replicas 1 \
  --cluster-yes
</code></pre>
<blockquote>
<p>âœ… æˆåŠŸè¾“å‡ºï¼š</p>
</blockquote>
<pre><code class="language-bash">root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl run -it --rm --restart=Never \
&gt;   --namespace cka \
&gt;   redis-admin \
&gt;   --image=redis:6.2.6 \
&gt;   -- redis-cli --cluster create \
&gt;     10.200.210.76:6379 \
&gt;     10.200.45.204:6379 \
&gt;     10.200.11.136:6379 \
&gt;     10.200.210.77:6379 \
&gt;     10.200.45.205:6379 \
&gt;     10.200.11.137:6379 \
&gt;   --cluster-replicas 1 \
&gt;   --cluster-yes
If you don't see a command prompt, try pressing enter.
..
&gt;&gt;&gt; Performing Cluster Check (using node 10.200.210.76:6379)
M: 0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: a6f78d2a82b2c56fdd8f61794a96e30f2398777f 10.200.11.137:6379
   slots: (0 slots) slave
   replicates 931716e199e90bc313c3480661af530d1f32bf08
S: 4a4baa12df1ada0d81e27b9a1ecc7aa2f9cec0ff 10.200.45.205:6379
   slots: (0 slots) slave
   replicates 0d3db136c17df8b0681fe8e2436a4f99203f0507
S: 6f33cd693707f3109704ca23151a4f1b7716e380 10.200.210.77:6379
   slots: (0 slots) slave
   replicates 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482
M: 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
M: 931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
pod &quot;redis-admin&quot; deleted
root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl exec -n cka redis-0 -- redis-cli -c cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:55
cluster_stats_messages_pong_sent:58
cluster_stats_messages_sent:113
cluster_stats_messages_ping_received:53
cluster_stats_messages_pong_received:55
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:113
root@101-master1:/opt/k8s-data/yaml/cka/redis-cluster# kubectl exec -n cka redis-0 -- redis-cli -c cluster nodes
a6f78d2a82b2c56fdd8f61794a96e30f2398777f 10.200.11.137:6379@16379 slave 931716e199e90bc313c3480661af530d1f32bf08 0 1755030011982 6 connected
0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379@16379 myself,master - 0 1755030010000 1 connected 0-5460
4a4baa12df1ada0d81e27b9a1ecc7aa2f9cec0ff 10.200.45.205:6379@16379 slave 0d3db136c17df8b0681fe8e2436a4f99203f0507 0 1755030011000 5 connected
6f33cd693707f3109704ca23151a4f1b7716e380 10.200.210.77:6379@16379 slave 7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 0 1755030011577 4 connected
7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379@16379 master - 0 1755030010000 3 connected 10923-16383
931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379@16379 master - 0 1755030010971 2 connected 5461-10922

[OK] All 16384 slots covered.
</code></pre>
<hr>
<h3 id="æ’é”™æ€»ç»“">ğŸ“Œ æ’é”™æ€»ç»“</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>åŸå› </th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>redis-cli: unknown option '--cluster'</code></td>
<td><code>redis:4.0.14</code> é•œåƒä¸æ”¯æŒ</td>
<td>ä½¿ç”¨ <code>redis:6.2.6</code> çš„ <code>redis-cli</code></td>
</tr>
<tr>
<td><code>redis-trib.rb</code> ä¸å­˜åœ¨</td>
<td>å·²è¢«ç§»é™¤</td>
<td>æ”¾å¼ƒä½¿ç”¨</td>
</tr>
<tr>
<td>â€œsame hostâ€ é”™è¯¯</td>
<td>ä½¿ç”¨äº† ClusterIP æœåŠ¡</td>
<td>æ”¹ç”¨ Pod IP åˆå§‹åŒ–</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="5ï¸âƒ£-ç¬¬äº”éƒ¨åˆ†éªŒè¯é›†ç¾¤çŠ¶æ€">5ï¸âƒ£ ç¬¬äº”éƒ¨åˆ†ï¼šéªŒè¯é›†ç¾¤çŠ¶æ€</h2>
<h3 id="51-æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€">5.1 æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€</h3>
<pre><code class="language-bash">kubectl exec -n cka redis-0 -- redis-cli -c cluster info
</code></pre>
<blockquote>
<p>âœ… è¾“å‡ºï¼š</p>
</blockquote>
<pre><code>cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_known_nodes:6
cluster_size:3
</code></pre>
<hr>
<h3 id="52-æŸ¥çœ‹èŠ‚ç‚¹æ‹“æ‰‘">5.2 æŸ¥çœ‹èŠ‚ç‚¹æ‹“æ‰‘</h3>
<pre><code class="language-bash">kubectl exec -n cka redis-0 -- redis-cli -c cluster nodes
</code></pre>
<blockquote>
<p>âœ… è¾“å‡ºï¼ˆèŠ‚é€‰ï¼‰ï¼š</p>
</blockquote>
<pre><code>0d3db136c17df8b0681fe8e2436a4f99203f0507 10.200.210.76:6379@16379 master - 0 1755030010000 1 connected 0-5460
931716e199e90bc313c3480661af530d1f32bf08 10.200.45.204:6379@16379 master - 0 1755030010971 2 connected 5461-10922
7a8f9abcbc779faebb10e2b5de9f00be0d7ad482 10.200.11.136:6379@16379 master - 0 1755030010000 3 connected 10923-16383
</code></pre>
<blockquote>
<p>âœ… ç»“è®ºï¼š3 ä¸» 3 ä»ï¼Œé›†ç¾¤å¥åº·ã€‚</p>
</blockquote>
<hr>
<h2 id="æ€»ç»“">âœ… æ€»ç»“</h2>
<ul>
<li>** <code>redis.conf</code> å·²é€šè¿‡ ConfigMap æ­£ç¡®æŒ‚è½½**</li>
<li><strong><code>redis:4.0.14</code> å®˜æ–¹é•œåƒç¡®å®ä¸æ”¯æŒ <code>--cluster</code></strong></li>
<li><strong>å¿…é¡»ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆå¦‚ <code>6.2.6</code>ï¼‰è¿›è¡Œé›†ç¾¤ç®¡ç†</strong></li>
<li><strong>åˆå§‹åŒ–å¿…é¡»ä½¿ç”¨ Pod IPï¼Œé¿å…æœåŠ¡åè§£æé—®é¢˜</strong></li>
</ul>
<blockquote>
<p>ğŸ‰ æ­¤æ–‡æ¡£ä¸ºå®Œæ•´ã€çœŸå®ã€å¯æ‰§è¡Œçš„éƒ¨ç½²æ‰‹å†Œï¼Œå¯ç”¨äºå›¢é˜Ÿäº¤ä»˜ã€‚</p>
</blockquote>
<hr>
<h2 id="6ï¸âƒ£-ç¬¬å…­éƒ¨åˆ†ä¸€é”®åˆå§‹åŒ–è„šæœ¬">6ï¸âƒ£ ç¬¬å…­éƒ¨åˆ†ï¼šä¸€é”®åˆå§‹åŒ–è„šæœ¬</h2>
<h3 id="init-redis-clustersh"><code>init-redis-cluster.sh</code></h3>
<pre><code class="language-bash">#!/bin/bash
# init-redis-cluster.sh
# ä¸€é”®åˆå§‹åŒ– Redis é›†ç¾¤ï¼ˆä½¿ç”¨ Pod IP + é«˜ç‰ˆæœ¬ redis-cliï¼‰
# å‘½åç©ºé—´ï¼šcka

set -e

NAMESPACE=&quot;cka&quot;
APP_LABEL=&quot;app=redis&quot;
REPLICA_COUNT=1

echo &quot;ğŸ” è·å– Redis Pod åŠå…¶ IP åœ°å€...&quot;

POD_IPS=($(kubectl get pods -n $NAMESPACE -l $APP_LABEL -o jsonpath='{.items[*].status.podIP}'))
POD_NAMES=($(kubectl get pods -n $NAMESPACE -l $APP_LABEL -o jsonpath='{.items[*].metadata.name}'))

if [ ${#POD_IPS[@]} -ne 6 ]; then
  echo &quot;âŒ é”™è¯¯ï¼šæœŸæœ› 6 ä¸ª Podï¼Œä½†åªæ‰¾åˆ° ${#POD_IPS[@]} ä¸ª&quot;
  kubectl get pods -n $NAMESPACE -l $APP_LABEL
  exit 1
fi

echo &quot;_Pods: ${POD_NAMES[*]}&quot;
echo &quot;_Pods IPs: ${POD_IPS[*]}&quot;

echo &quot;ğŸš€ ä½¿ç”¨ redis:6.2.6 åˆå§‹åŒ– Redis é›†ç¾¤...&quot;

kubectl run -it --rm --restart=Never \
  --namespace $NAMESPACE \
  redis-admin \
  --image=redis:6.2.6 \
  -- sh -c &quot;
    redis-cli --cluster create \
      ${POD_IPS[0]}:6379 \
      ${POD_IPS[1]}:6379 \
      ${POD_IPS[2]}:6379 \
      ${POD_IPS[3]}:6379 \
      ${POD_IPS[4]}:6379 \
      ${POD_IPS[5]}:6379 \
    --cluster-replicas $REPLICA_COUNT \
    --cluster-yes
  &quot;

echo &quot;âœ… Redis é›†ç¾¤åˆå§‹åŒ–å®Œæˆï¼&quot;
</code></pre>
<blockquote>
<p>âœ… ä½¿ç”¨æ–¹æ³•ï¼š</p>
</blockquote>
<pre><code class="language-bash">chmod +x init-redis-cluster.sh
./init-redis-cluster.sh
</code></pre>
<hr>
<h2 id="æ€»ç»“-2">âœ… æ€»ç»“</h2>
<ul>
<li><strong><code>redis:4.0.14</code> å®˜æ–¹é•œåƒä¸­çš„ <code>redis-cli</code> ç¡®å®ä¸æ”¯æŒ <code>--cluster</code> å‘½ä»¤</strong>ï¼Œè¿™æ˜¯éƒ¨ç½²ä¸­çš„å…³é”®éšœç¢ã€‚</li>
<li><strong>å¿…é¡»ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆå¦‚ <code>redis:6.2.6</code>ï¼‰</strong> æ¥ç®¡ç† Redis 4.0.14 é›†ç¾¤ã€‚</li>
<li><strong>åˆå§‹åŒ–æ—¶å¿…é¡»ä½¿ç”¨ Pod IP</strong>ï¼Œé¿å… ClusterIP å¯¼è‡´çš„â€œåŒä¸€ä¸»æœºâ€é”™è¯¯ã€‚</li>
</ul>
<blockquote>
<p>ğŸ‰ æ­¤æ–‡æ¡£çœŸå®è¿˜åŸäº†æ’é”™è¿‡ç¨‹ï¼Œå¯ä½œä¸ºæ ‡å‡†æ“ä½œæ‰‹å†Œã€‚</p>
</blockquote>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#kubernetes-redis-4014-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E4%B8%8E%E6%8E%92%E9%94%99%E6%89%8B%E5%86%8C%E7%9C%9F%E5%AE%9E%E9%AA%8C%E8%AF%81%E7%89%88">ğŸ“š <strong>Kubernetes Redis 4.0.14 é›†ç¾¤éƒ¨ç½²ä¸æ’é”™æ‰‹å†Œï¼ˆçœŸå®éªŒè¯ç‰ˆï¼‰</strong></a>
<ul>
<li><a href="#1%EF%B8%8F%E2%83%A3-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%BC%95%E8%A8%80">1ï¸âƒ£ ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼•è¨€</a></li>
<li><a href="#2%EF%B8%8F%E2%83%A3-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%BC%80%E5%A7%8B%E9%83%A8%E7%BD%B2">2ï¸âƒ£ ç¬¬äºŒéƒ¨åˆ†ï¼šå¼€å§‹éƒ¨ç½²</a>
<ul>
<li><a href="#21-%E5%87%86%E5%A4%87-nfs-%E5%AD%98%E5%82%A8%E5%9C%A8-nfs-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C">2.1 å‡†å¤‡ NFS å­˜å‚¨ï¼ˆåœ¨ NFS æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰</a></li>
<li><a href="#22-%E5%88%9B%E5%BB%BA-persistentvolumepv">2.2 åˆ›å»º PersistentVolumeï¼ˆPVï¼‰</a>
<ul>
<li><a href="#%E5%BA%94%E7%94%A8-pv">åº”ç”¨ PVï¼š</a></li>
</ul>
</li>
<li><a href="#23-%E5%88%9B%E5%BB%BA-redis-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-redisconf">2.3 åˆ›å»º Redis é…ç½®æ–‡ä»¶ <code>redis.conf</code></a></li>
<li><a href="#24-%E4%BB%8E-redisconf-%E5%88%9B%E5%BB%BA-configmap">2.4 ä» <code>redis.conf</code> åˆ›å»º ConfigMap</a></li>
<li><a href="#25-%E9%83%A8%E7%BD%B2-redis-statefulset-%E4%B8%8E-service%E5%90%AB-configmap-%E6%8C%82%E8%BD%BD">2.5 éƒ¨ç½² Redis StatefulSet ä¸ Serviceï¼ˆå« ConfigMap æŒ‚è½½ï¼‰</a>
<ul>
<li><a href="#%E5%BA%94%E7%94%A8%E9%85%8D%E7%BD%AE">åº”ç”¨é…ç½®ï¼š</a></li>
</ul>
</li>
<li><a href="#26-%E7%AD%89%E5%BE%85-pod-%E5%B0%B1%E7%BB%AA">2.6 ç­‰å¾… Pod å°±ç»ª</a></li>
</ul>
</li>
<li><a href="#3%EF%B8%8F%E2%83%A3-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E5%88%9D%E5%A7%8B%E5%8C%96%E6%8A%A5%E9%94%99%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95">3ï¸âƒ£ ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆå§‹åŒ–æŠ¥é”™ï¼ˆé¦–æ¬¡å°è¯•ï¼‰</a>
<ul>
<li><a href="#%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8-redis4014-%E9%95%9C%E5%83%8F%E4%B8%AD%E7%9A%84-redis-cli-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4">å°è¯•ä½¿ç”¨ <code>redis:4.0.14</code> é•œåƒä¸­çš„ <code>redis-cli</code> åˆå§‹åŒ–é›†ç¾¤</a></li>
<li><a href="#%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF">âŒ æŠ¥é”™ä¿¡æ¯ï¼š</a></li>
</ul>
</li>
<li><a href="#4%EF%B8%8F%E2%83%A3-%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E6%8E%92%E9%94%99%E4%B8%8E%E9%AA%8C%E8%AF%81">4ï¸âƒ£ ç¬¬å››éƒ¨åˆ†ï¼šæ’é”™ä¸éªŒè¯</a>
<ul>
<li><a href="#%E6%8E%92%E9%94%99-1%E9%AA%8C%E8%AF%81-redis4014-%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81-cluster">ğŸ” æ’é”™ 1ï¼šéªŒè¯ <code>redis:4.0.14</code> æ˜¯å¦æ”¯æŒ <code>--cluster</code></a></li>
<li><a href="#%E6%8E%92%E9%94%99-2%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8-redis-tribrb">ğŸ” æ’é”™ 2ï¼šå°è¯•ä½¿ç”¨ <code>redis-trib.rb</code></a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BD%BF%E7%94%A8%E9%AB%98%E7%89%88%E6%9C%AC-redis-cliredis626-pod-ip">âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code>ï¼ˆ<code>redis:6.2.6</code>ï¼‰ + Pod IP</a>
<ul>
<li><a href="#%E8%8E%B7%E5%8F%96-pod-ip">è·å– Pod IPï¼š</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E9%AB%98%E7%89%88%E6%9C%AC-redis-cli-%E5%88%9D%E5%A7%8B%E5%8C%96">ä½¿ç”¨é«˜ç‰ˆæœ¬ <code>redis-cli</code> åˆå§‹åŒ–ï¼š</a></li>
</ul>
</li>
<li><a href="#%E6%8E%92%E9%94%99%E6%80%BB%E7%BB%93">ğŸ“Œ æ’é”™æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#5%EF%B8%8F%E2%83%A3-%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81">5ï¸âƒ£ ç¬¬äº”éƒ¨åˆ†ï¼šéªŒè¯é›†ç¾¤çŠ¶æ€</a>
<ul>
<li><a href="#51-%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E6%95%B4%E4%BD%93%E7%8A%B6%E6%80%81">5.1 æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€</a></li>
<li><a href="#52-%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E6%8B%93%E6%89%91">5.2 æŸ¥çœ‹èŠ‚ç‚¹æ‹“æ‰‘</a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">âœ… æ€»ç»“</a></li>
<li><a href="#6%EF%B8%8F%E2%83%A3-%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E4%B8%80%E9%94%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E8%84%9A%E6%9C%AC">6ï¸âƒ£ ç¬¬å…­éƒ¨åˆ†ï¼šä¸€é”®åˆå§‹åŒ–è„šæœ¬</a>
<ul>
<li><a href="#init-redis-clustersh"><code>init-redis-cluster.sh</code></a></li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93-2">âœ… æ€»ç»“</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://orochw.github.io/post/kubernetes-125-ji-qun-bu-shu-zhi-nan/">
              <h3 class="post-title">
                Kubernetes 1.25 é›†ç¾¤éƒ¨ç½²æŒ‡å—  
              </h3>
            </a>
          </div>
        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: 'e16544ded74efb82c5cb',
    clientSecret: 'cc815ef9f98d5cf6d79ae6f9ca0f9fc2b521645a',
    repo: 'Gitalk',
    owner: 'OrochW',
    admin: ['OrochW'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://orochw.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
